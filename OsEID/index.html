<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="AsciiDoc 8.6.10">
<title>OsEID smart card &amp; OsEID token</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


@media screen {
  body {
    max-width: 50em; /* approximately 80 characters wide */
    margin-left: 16em;
  }

  #toc {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 13em;
    padding: 0.5em;
    padding-bottom: 1.5em;
    margin: 0;
    overflow: auto;
    border-right: 3px solid #f8f8f8;
    background-color: white;
  }

  #toc .toclevel1 {
    margin-top: 0.5em;
  }

  #toc .toclevel2 {
    margin-top: 0.25em;
    display: list-item;
    color: #aaaaaa;
  }

  #toctitle {
    margin-top: 0.5em;
  }
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>OsEID smart card &amp; OsEID token</h1>
<span id="author">Peter Popovec</span><br>
<span id="email" class="monospaced">&lt;<a href="mailto:popovec.peter@gmail.com">popovec.peter@gmail.com</a>&gt;</span><br>
<span id="revdate">Mon Sep 30 09:59:53 CEST 2019</span>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Copyright &#169; 2015-2019 Peter Popovec &lt;<a href="mailto:popovec.peter@gmail.com">popovec.peter@gmail.com</a>&gt;</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph"><p>OsEID is amateur/hobby smart card with <a href="#RSA">[RSA]</a> and <a href="#EC">[EC]</a> cryptography support. It
is designed on low cost and easily accessible microcontroller Microchip/Atmel ATmega
128 or ATmega 128A. Alternative hardware uses atmega 1284 microcontroller.</p></div>
<div class="paragraph"><p><span class="image">
<img src="images/card_3x.png" alt="OsEID">
</span></p></div>
<div class="paragraph"><p>OsEID token is amateur/hobby USB token based on Microchip/Atmel xmega128a4u
microcontroller.  This projects implements USB reader (<a href="#CCID">[CCID]</a> class) with
built in OsEID card.</p></div>
<div class="imageblock">
<div class="content">
<img src="images/token2.png" alt="OeEID-token">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_project_website">Project website</h2>
<div class="sectionbody">
<div class="paragraph"><p>OsEID projects releases can be found at  at <a href="https://oseid.sourceforge.io">https://oseid.sourceforge.io</a> or <a href="https://sourceforge.net/projects/oseid/">https://sourceforge.net/projects/oseid/</a></p></div>
<div class="sect2">
<h3 id="_features">Features</h3>
<div class="ulist"><ul>
<li>
<p>
Open source code (ASM and C)
</p>
</li>
<li>
<p>
OsEID card  - simple mechanical construction, only one integrated circuit!
</p>
</li>
<li>
<p>
OsEID token - single sided PCB, only 15 components
</p>
</li>
<li>
<p>
Based on easily accessible microcontroller Microchip/Atmel ATmega 128A / xmega128A4U
</p>
</li>
<li>
<p>
ISO 7816 compatible
  note:[Not all ISO specifications are respected, for example, card thickness cannot be accomplished.]
</p>
</li>
<li>
<p>
Support for pkcs#15 structure
</p>
</li>
<li>
<p>
RSA cryptography with side channel attack protection (key size 512 up to 2048 bits)
</p>
<div class="ulist"><ul>
<li>
<p>
onboard key generation
</p>
</li>
</ul></div>
</li>
<li>
<p>
Elliptic cryptography with side channel attack protection
</p>
<div class="ulist"><ul>
<li>
<p>
<a href="#ECDSA">[ECDSA]</a> operation
</p>
</li>
<li>
<p>
<a href="#ECDH">[ECDH]</a> operation
</p>
</li>
<li>
<p>
onboard key generation
</p>
</li>
<li>
<p>
nistp192/prime192v1/secp192r1 <a href="#OID">[OID]</a> 1.2.840.10045.3.1.1
</p>
</li>
<li>
<p>
nistp256/prime256v1/secp256r1 <a href="#OID">[OID]</a> 1.2.840.10045.3.1.7
</p>
</li>
<li>
<p>
secp384r1 <a href="#OID">[OID]</a> 1.3.132.0.34
</p>
</li>
<li>
<p>
secp521r1 <a href="#OID">[OID]</a> 1.3.132.0.35
</p>
</li>
<li>
<p>
secp256k1 <a href="#OID">[OID]</a> 1.3.132.0.10, experimental support, OpenSC patch required
</p>
</li>
</ul></div>
</li>
<li>
<p>
symmetric cryptography: DES, 3DES, AES 128, AES 192, AES 256
</p>
</li>
<li>
<p>
Onboard random number generator
</p>
</li>
<li>
<p>
<a href="#PIN">[PIN]</a> / <a href="#PUK">[PUK]</a> controlled access to files on card
</p>
</li>
<li>
<p>
64 kbyte file space (for keys /certificates etc.)
</p>
</li>
<li>
<p>
auto size <a href="#DF">[DF]</a>
</p>
</li>
<li>
<p>
Supported in Linux/Windows by OpenSC package - MyEID driver
</p>
</li>
<li>
<p>
OsEID card: Communication speed 161290 bits/s for 5MHz readers
</p>
</li>
<li>
<p>
OsEID token: no special card reader driver needed for Linux/WIN/MAC
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_drawbacks">Drawbacks</h3>
<div class="ulist"><ul>
<li>
<p>
No Warranty, use at your own risk.
</p>
</li>
<li>
<p>
It is not possible to buy it, you have to make it.
</p>
</li>
<li>
<p>
Documentation is still in the form of draft.
</p>
</li>
<li>
<p>
card - only T0 protocol, T1 available only in token/simulator
</p>
</li>
<li>
<p>
RSA operations slow (depends on ATmega RC oscillator, usually max about 13.5MHz)
</p>
<div class="ulist"><ul>
<li>
<p>
about 23.3 seconds for 2048 bit key / token about 10 seconds,
</p>
</li>
<li>
<p>
about 11.5 seconds for 1536 bit key / token about 5 seconds,
</p>
</li>
<li>
<p>
about 3.8  seconds for 1024 bit key / token about 1.7 seconds,
</p>
</li>
<li>
<p>
about 1.9  seconds for 768 and 512 bit keys / token about 0.8 second
</p>
</li>
</ul></div>
</li>
<li>
<p>
EC operations slow, ECDSA operation timing:
</p>
<div class="ulist"><ul>
<li>
<p>
secp521r1  11 seconds  / token about 5 seconds
</p>
</li>
<li>
<p>
secp384r1  5.9 seconds / token about 2.5 seconds
</p>
</li>
<li>
<p>
prime256v1 2.7 seconds / token about 1.4 seconds
</p>
</li>
<li>
<p>
prime192v1 1.1 second / token about 0.5 seconds
</p>
</li>
<li>
<p>
secp256k1  3.6 seconds / token about 2 seconds
</p>
</li>
</ul></div>
</li>
<li>
<p>
not perfect constant time EC operations
</p>
</li>
<li>
<p>
OsEID card - ESD (electrostatic discharge) protection implemented only on token
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_oseid_myeid_differences">OsEID - MyEID differences</h3>
<div class="paragraph"><p>OsEID tries to support all features which are available in commercial card
<a href="#MyEID">[MyEID]</a>.  Thanks to that, no special software/drivers is needed for
commonly used operating systems.  For Windows, Linux and Mac OS opensource
project <a href="#OpenSC">[OpenSC]</a> can be used as driver for OsEID card.</p></div>
<div class="paragraph"><p>OsEID disadvantages to MyEID card (mechanical)</p></div>
<div class="ulist"><ul>
<li>
<p>
no SIM version of card
</p>
</li>
<li>
<p>
mechanical construction - big, not compact as one plastic card
</p>
</li>
</ul></div>
<div class="paragraph"><p>OsEID disadvantages to MyEID card applet version 4.X:</p></div>
<div class="paragraph"><p>(These functionalities are not supported by MyEID driver in OpenSC up to
0.18, perhaps OsEID will support these functions in future)</p></div>
<div class="ulist"><ul>
<li>
<p>
RSA - only value 65537 is allowed as public exponent
</p>
</li>
<li>
<p>
experimental support for symmetric encrypt/decrypt - DES and AES
</p>
</li>
<li>
<p>
experimental support for key unwrap
</p>
</li>
<li>
<p>
experimental support for key wrap
</p>
</li>
<li>
<p>
experimental challenge response PIN
</p>
</li>
<li>
<p>
experimental Admin state and Global unblocker state
</p>
</li>
<li>
<p>
no PIV/CIV emulation
</p>
</li>
<li>
<p>
no Auto size files (only auto size DF)
</p>
</li>
<li>
<p>
no 224 bit NIST curve
</p>
</li>
<li>
<p>
no support for automatic delete of session objects
  (please read MyEID 2.3.0 referene manual)
</p>
</li>
<li>
<p>
slow RSA
</p>
</li>
<li>
<p>
slow ECC
</p>
</li>
<li>
<p>
MyEID applet version 4.5.X allow use RSA keys up to 4096 bits, OsEID
  maximum is 2048 bits for RSA, and there is no way to run RSA with longer
  keys in this hardware.
</p>
</li>
</ul></div>
<div class="paragraph"><p>experimental = feature is supported by OsEID card, but original MyEID card
function can work differently.  There is no enough information in MyEID
applet reference manual 2.1.4/2/2.3.0 and no OpenSC implementation to test
all functions.</p></div>
<div class="paragraph"><p>OsEID disadvantages to MyEID card, applet version below 3.5:</p></div>
<div class="paragraph"><p>(MyEID in version below 3.5 does not support EC cryptography)</p></div>
<div class="ulist"><ul>
<li>
<p>
slow RSA
</p>
</li>
</ul></div>
<div class="paragraph"><p>For a comparison, here is table showing the execution time of RSA decrypt
operation (time in seconds) for MyEID (3.3.3), OsEID (with exponent blinding
turned on):</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>pkcs11-tool --decrypt --slot 1 -m RSA-PKCS ..</pre>
</div></div>
<table class="tableblock frame-all grid-all"
style="
width:80%;
">
<caption class="title">Table 1. OsEID/MyEID RSA speed comparation</caption>
<col style="width:37%;">
<col style="width:12%;">
<col style="width:12%;">
<col style="width:12%;">
<col style="width:12%;">
<col style="width:12%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >  key size               </th>
<th class="tableblock halign-left valign-top" > 512 </th>
<th class="tableblock halign-left valign-top" > 768 </th>
<th class="tableblock halign-left valign-top" > 1024 </th>
<th class="tableblock halign-left valign-top" > 1536 </th>
<th class="tableblock halign-left valign-top" > 2048</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">MyEID (3.3.3)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.6</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">OsEID card (blinding on)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.6</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5.4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">12.7</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">23.8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">OsEID token (blinding on)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1.2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1.4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2.3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5.5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">10.6</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Times in this table are higher then times given in Features section, because
here the time of all operations that OpenSC runs on card, e.g.  card
identification, reading PKCS#15 files, reading public key.</p></div>
<div class="paragraph"><p>MyEID card seems to be slower in filesystem operations, listing all card
objects by <strong>pkcs15-tool -D</strong> command run in 2.8 second for 5 RSA keys on card.
OsEID runs the same command, the same set of keys in 1.9 second.</p></div>
<div class="paragraph"><p>Time depends on card reader too.  Both cards allow the same communication speed -
161290 bits/s for 5MHz readers, for tests 3.7MHz reader was used (about
120kbit/s).</p></div>
<div class="ulist"><ul>
<li>
<p>
ECC speed is comparable to MyEID
</p>
</li>
</ul></div>
<table class="tableblock frame-all grid-all"
style="
width:80%;
">
<caption class="title">Table 2. OsEID/MyEID ECC speed comparation</caption>
<col style="width:42%;">
<col style="width:14%;">
<col style="width:14%;">
<col style="width:14%;">
<col style="width:14%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >  key size               </th>
<th class="tableblock halign-left valign-top" > 192   </th>
<th class="tableblock halign-left valign-top" > 256    </th>
<th class="tableblock halign-left valign-top" > 192   </th>
<th class="tableblock halign-left valign-top" > 256</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" colspan="2" ><p class="tableblock">pkcs15-crypt</p></td>
<td class="tableblock halign-left valign-top" colspan="2" ><p class="tableblock">pkcs11-tool</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">MyEID (4.0.1)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1.4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1.4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4.7</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4.7</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">OsEID card</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1.6</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4.7</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">OsEID token</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.7</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1.4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1.3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2.0</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>(there is no support for secp384r1 and secp521r1 in MyEID 4.0.1 card)</p></div>
<div class="paragraph"><p>OsEID benefits to MyEID card:</p></div>
<div class="ulist"><ul>
<li>
<p>
secp256k1 curve
</p>
</li>
<li>
<p>
open source - can be reprogrammed for different usage
</p>
</li>
<li>
<p>
for people who don&#8217;t trust commercial solutions because of backdoors
</p>
</li>
<li>
<p>
for people who are happy to make a card by themselves
</p>
</li>
<li>
<p>
card and reader simulation (without real card/reader)
</p>
</li>
<li>
<p>
AES192 (MyEID reference manual 2.1.4 documents only AES128 and AES256)
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_disclaimer">Disclaimer</h3>
<div class="paragraph"><p>Whole project is published in good faith and is to be used for educational
purposes only, however, amateur/hobby usage is also possible.  When you
decide to use this project in other way, keep in mind all drawbacks.
Particularly take care that the card may be damaged and you may lose access
to devices, that need authentication with card.  Please, consider creating
backup card/backup access for this situation.  AUTHOR IS NOT RESPONSIBLE FOR
ANY DAMAGE OF CARD READERS, COMPUTER EQUIPMENTS OR DATA LOSS/DATA LEAKAGE!
USE AT YOUR OWN RISK ONLY! Please read information about RSA and ECC
security in this manual.</p></div>
</div>
<div class="sect2">
<h3 id="_code_license">Code LICENSE</h3>
<div class="paragraph"><p>Code is licensed by GNU GENERAL PUBLIC LICENSE Version 3, 29 June 2007.
Please read Licence.txt in code root directory. <a href="#GPL">[GPL]</a></p></div>
<div class="paragraph"><p>128,192 and 256 bit multiplication source files were originally public
domain (Authors: Michael Hutter and Peter Schwabe, Version: 2014-07-25,
downloaded from <a href="http://mhutter.org/research/avr/">http://mhutter.org/research/avr/</a> ), but have been modified
for OsEID project (to allow run this code in interrupt enabled environment,
and to improve speed). I decided to release this modified version under the
GPL.</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_making_oseid_card">Making OsEID card</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_mechanical_construction">Mechanical construction</h3>
<div class="sect3">
<h4 id="_card_components">Card components</h4>
<div class="paragraph"><p>Card is a composition of two components. First component is ATmega 128
microcontroller or ATmega 128A microcontroller.</p></div>
<div class="paragraph"><p><span class="image">
<img src="images/atmega128A_small.png" alt="Atmega128A">
</span></p></div>
<div class="paragraph"><p>ATmega 128A microcontroller is available with a number of vendors.  You can
buy ATMEGA128A-AU in TQFP64 package from <a href="http://www.farnell.com">http://www.farnell.com</a> by sale code
1773397 (about 4.8E / Dec 31 2017).  Alternatively you can buy ATMEGA128A-AU from
<a href="https://www.tme.eu/en/details/atmega128a-au/8-bit-avr-family/microchip-atmel/">https://www.tme.eu/en/details/atmega128a-au/8-bit-avr-family/microchip-atmel/</a>
(price about 5.5E / Dec 31 2017).</p></div>
<div class="paragraph"><p>The second component is single sided printed circuit board (PCB) in the form of plastic
payment card.</p></div>
<div class="paragraph"><p><span class="image">
<img src="images/pcb_scan.png" alt="PCB">
</span></p></div>
<div class="paragraph"><p>This board is designed to match card dimensions and card contact pads positions
defined by ISO 7816-1.  PCB also connects microcontroller leads to card
contact pads.  There is no vendor for this PCB, but you can produce this PCB at
your local PCB producer.  Your producer needs gerber file or PDF file or
simple image as a manufacturing data for PCB production.  Please check
download section for these files.  Thickness of PCB must be about 0.8mm to
meet dimensions of card recommended by ISO 7816-1. Picture of PCB is also
included in <a href="#appendixA">appendix A</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_soldering_microcontroller_to_pcb">Soldering microcontroller to PCB</h4>
<div class="paragraph"><p>PCB and microcontroller together form final smartcard. The components are
connected by soldering.  ATmega128A microcontroller is available in TQFP or
QFN/MLF package.  Thickness of QFN/MLF packages is in range 0.8 to 1mm but
soldering this package in amateur condition is very difficult.  Because of
soldering difficulty TQFP package was preferred.</p></div>
<div class="paragraph"><p>Unfortunately, ATmega128A microcontroller in TQFP64 package thickness is
slightly below 1.2mm precisely in range 0.95 to 1.05mm + lead thickness
about 0.05 to 0.15mm.</p></div>
<div class="paragraph"><p>If we solder TQFP package directly on PCB board, we can achieve thickness
slightly below 2mm.  That is not good.  To get minimal thickness of card,
microcontroller is imbedded into printed circuit board.  In the position of
microcontroller there is a rectangular hole created in PCB with dimensions about 15.3x15.3mm.
The body of microcontroller is inserted into this hole.  Then
microcontroller leads are slightly bent upwards and soldered to PCB copper
contacts from opposite side as normally.  This mounting can achieve final
thickness of card about 1.1mm.  Most of card readers deal with this
thickness without problems.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">Be aware that final thickness about 1.1mm violates ISO7816-1
specification, which defines thickness of card to 0.76mm with tolerance
+0.08mm.</td>
</tr></table>
</div>
<div class="paragraph"><p>PCB dimensions must also match ISO 7816-1 specification: width 85.47mm -
85.72mm and height 53.92mm - 54.03mm, and corner radiuses in range 2.88 to
3.48mm.</p></div>
<div class="paragraph"><p>It is assumed that you have plenty of mechanical skills and experience with
soldering surface mounted integrated circuit. Further details
of the mechanical installation are therefore not listed here.</p></div>
<div class="paragraph"><p><span class="image">
<img src="images/imbedding.png" alt="Imbedding TQFP package into PCB">
</span></p></div>
</div>
<div class="sect3">
<h4 id="_pcb_plating_coating">PCB plating / coating</h4>
<div class="paragraph"><p>For amateur use, a common printed circuit board without special surface finish will be sufficient.
Because copper on PCB corrodes on air, sooner or
later, problems arise when using the card.  If you plan to use the card
frequently, it is advisable to use circuit board with gold-plated contact
pads.  An alternative to gold plating is silver plating or nickel plating.
Consult your local printed circuit board producer what plating he offers and
at what price.</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
<div class="sect2">
<h3 id="_programming_microcontroller">Programming microcontroller</h3>
<div class="paragraph"><p>Before using the card, microprocessor must be programmed with card operation
system.  You need hex file <em>card.hex</em> that is available in download section.
To load hex file into ATmega128 microcontroller, you need Microchip/Atmel
programmer tool with programmer software.  For example, free software can be
found at <a href="http://www.nongnu.org/avrdude/">http://www.nongnu.org/avrdude/</a>.  Programmer hardware overview can
be found at <a href="http://www.ladyada.net/learn/avr/programmers.html">http://www.ladyada.net/learn/avr/programmers.html</a>.  You can
learn more about programming AVR microcontrollers on internet, a good
website to start is
<a href="https://learn.adafruit.com/introducing-trinket/programming-with-avrdude">https://learn.adafruit.com/introducing-trinket/programming-with-avrdude</a>.</p></div>
<div class="paragraph"><p>At this point the familiarity with programming AVR
microcontrollers through ISP is assumed. Your card already includes ISP connector but in
different format as normal Microchip/Atmel ISP6 or ISP10 connectors. Mapping
microcontroller pins to card contact pads and to standard Microchip/Atmel ISP6 can be
found in the table below.</p></div>
<table class="tableblock frame-all grid-all"
style="
width:80%;
">
<caption class="title">Table 3. Mapping card / microcontroller / ISP contacts</caption>
<col style="width:33%;">
<col style="width:33%;">
<col style="width:33%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" > CPU pin name</th>
<th class="tableblock halign-left valign-top" >ISO pad name</th>
<th class="tableblock halign-left valign-top" > Atmel ISP name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">GND</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">GND  C5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">GND    6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Vcc</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Vcc  C1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">VCC    2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">RESET</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Vpp  C6</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">RESET  5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">PE0/PDI 2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">RST  C2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">MOSI   4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">PE1/PDO</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CLK  C3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">MISO   1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">PB1/SCK</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">I/O  C7</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">SCK    3</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>It is recommended to make simple adapter from AVR ISP6 connector to CARD
contact pads.  You need a smart card connector and a ribbon cable with
IDC connector with 6 pins. Alternatively, if your programmer already
contains ribbon cable with 6 pin female IDC connector, you need 6 pin male
IDC connector.</p></div>
<div class="imageblock">
<div class="content">
<img src="images/adapter1.jpg" alt="programming adapter">
</div>
</div>
<div class="paragraph"><p>You can buy it from here:</p></div>
<div class="paragraph"><p><a href="http://www.tme.eu/en/details/116b-dboa-r/card-connectors/attend/116b-dbo0-r02/">http://www.tme.eu/en/details/116b-dboa-r/card-connectors/attend/116b-dbo0-r02/</a>
<a href="http://www.tme.eu/en/details/fc06150-s/ribbon-cables-with-idc-connectors/amphenol/">http://www.tme.eu/en/details/fc06150-s/ribbon-cables-with-idc-connectors/amphenol/</a>
<a href="http://www.tme.eu/en/details/09185066324/idc-connectors/harting/">http://www.tme.eu/en/details/09185066324/idc-connectors/harting/</a></p></div>
<div class="paragraph"><p>Carefully connect the cable to the relevant contact pads of smart card
connector.  Connect this adapter to AVR programmer, insert new card into
smart card connector and you can upload firmware into your card.</p></div>
<div class="paragraph"><p>It is recommended to program microcontroller fuses first:</p></div>
<div class="paragraph"><p>Extended fuses:  0xFF<br>
High fuses:      0xD9<br>
Low fuses:       0x04<br></p></div>
<div class="paragraph"><p>Then upload card.hex and at last step is programming lock bits:</p></div>
<div class="paragraph"><p>Lock bits:       0xFC<br></p></div>
<div class="paragraph"><p>Example for <strong>avrdude</strong> and <strong>avrispmkII</strong> programmer:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ avrdude -p m128 -c avrispmkII -v -U efuse:w:0xFF:m
$ avrdude -p m128 -c avrispmkII -v -U hfuse:w:0xD9:m
$ avrdude -p m128 -c avrispmkII -v -U lfuse:w:0x04:m
$ avrdude -p m128 -c avrispmkII -v -U flash:w:download/OsEID_card.hex
$ avrdude -p m128 -c avrispmkII -v -U eeprom:w:download/OsEID_card_eeprom.hex
$ avrdude -p m128 -c avrispmkII -v -U lock:w:0xFC:m</pre>
</div></div>
<div class="paragraph"><p>Your card is ready for use now.</p></div>
</div>
<div class="sect2">
<h3 id="_compiling_from_sources">Compiling from sources</h3>
<div class="paragraph"><p>You can use source files to build card.hex.  Development is tested on DEBIAN
9.1.  You need <strong>gcc-avr</strong>, <strong>binutils-avr</strong>, <strong>avr-libc</strong>, <strong>make</strong>, <strong>srecord</strong> and
<strong>avrdude</strong> package.  You need to unpack OsEID tarball.  Makefiles located in <strong>src</strong> subdirectory
are used to compile and program the card.  Card serial number
is automatically generated from actual time/date.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>make -f Makefile.atmega128
make -f Makefile.atmega128 fuses
make -f Makefile.atmega128 program
make -f Makefile.atmega128 lock</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_vpp_pad">Vpp pad</h3>
<div class="paragraph"><p>In year 2006, the standard ISO 7816 changed the definition of <strong>Vpp</strong> pad.
This pad is no longer used for programming voltage.  If you use newer reader
(produced after 2006), card may work, or fail in this reader.  If your OsEID
card does not working in your card reader, Vpp pad of card pad must be isolated
from reader.  This can be done by stick self-adhesive tape on Vpp pad.</p></div>
</div>
<div class="sect2">
<h3 id="_building_oseid_token">Building OsEID-token</h3>
<div class="paragraph"><p>Only partial information here, schematics, PCB and list of components is in
Appendix D.  It is assumed that only a skilled technician will try to
build this device.</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_oseid_card">Using OsEID card</h2>
<div class="sectionbody">
<div class="paragraph"><p>For linux users: download and install <strong>OpenSC</strong> package.  Please use OpenSC
version 0.19 or newer.  Debian (buster) already contains the <strong>OpenSC</strong>
version 0.19.  For other distros, please follow distro specific installation
of OpenSC package.  Download and install <strong>pcscd</strong> and <strong>pcsc-tools</strong> package.
According to your card reader, you will need to install specific driver for
your reader (for example <strong>libccid</strong> or <strong>libacr38u</strong> package, ..  )</p></div>
<div class="paragraph"><p>Windows users: download and install OpenSC 0.17.  (version 0.18,0.19 is only
partially tested, please read comments about minidriver configuration below)</p></div>
<div class="sect2">
<h3 id="_base_functionality">Base functionality</h3>
<div class="paragraph"><p>The fastest way to test the functionality of the card is by launching program
<strong>pcsc_scan</strong> :</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>$ pcsc_scan
PC/SC device scanner
V 1.4.23 (c) 2001-2011, Ludovic Rousseau &lt;ludovic.rousseau@free.fr&gt;
Compiled with PC/SC lite version: 1.8.11
Using reader plug'n play mechanism
Scanning present readers...
0: Alcor Micro AU9540 00 00

Thu Dec 29 09:22:26 2016
Reader 0: Alcor Micro AU9540 00 00
  Card state: Card removed,</pre>
</div></div>
<div class="paragraph"><p>Insert card into reader. If the card is recognized, similar message is
displayed:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>Wed Jan  4 14:21:01 2017
Reader 0: Alcor Micro AU9540 00 00
  Card state: Card inserted,
  ATR: 3B F5 18 00 02 10 80 4F 73 45 49 44

ATR: 3B F5 18 00 02 10 80 4F 73 45 49 44
+ TS = 3B --&gt; Direct Convention
+ T0 = F5, Y(1): 1111, K: 5 (historical bytes)
  TA(1) = 18 --&gt; Fi=372, Di=12, 31 cycles/ETU
    129032 bits/s at 4 MHz, fMax for Fi = 5 MHz =&gt; 161290 bits/s
  TB(1) = 00 --&gt; VPP is not electrically connected
  TC(1) = 02 --&gt; Extra guard time: 2
  TD(1) = 10 --&gt; Y(i+1) = 0001, Protocol T = 0
-----
  TA(2) = 80 --&gt; Protocol to be used in spec mode: T=0 - Unable to change -
defined by interface bytes
+ Historical bytes: 4F 73 45 49 44
  Category indicator byte: 4F (proprietary format)</pre>
</div></div>
<div class="paragraph"><p>Press CTRL-C break <strong>pcsc_scan</strong> and you can go to configure <strong>OpenSC</strong> package.</p></div>
<div style="page-break-after:always"></div>
</div>
<div class="sect2">
<h3 id="_opensc_package_configuration">Opensc package configuration</h3>
<div class="paragraph"><p>If your OpenSC version is 0.20.0 or above, OsEID card is automatically
recognized. For older versions you need do some changes in configuration.</p></div>
<div class="paragraph"><p>Configure OpenSC package: edit <strong>/etc/opensc/opensc.conf</strong></p></div>
<div class="paragraph"><p>or if you use windows <strong>C:\Program Files\OpenSC Project\OpenSC\opensc.conf</strong></p></div>
<div class="paragraph"><p>add new <a href="#ATR">[ATR]</a> for OsEID card and OsEID token in <strong>app default</strong> section:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>        # OsEID card is handled by myeid driver
        card_atr 3b:f5:00:00:02:10:80:4f:73:45:49:44 {
                atrmask = "ff:ff:00:ff:ff:ff:ff:ff:ff:ff:ff:ff";
                driver = "myeid";
        }
        # OsEID token, T0/T1 protocol
        card_atr 3b:f5:00:00:02:80:01:4f:73:45:49:44:00 {
                atrmask = "ff:ff:00:ff:ff:ff:ff:ff:ff:ff:ff:ff:00"
                driver = "myeid";
        }</pre>
</div></div>
<div class="paragraph"><p>If your OpenSC version is 0.20 or newer, and your using OsEID card with
firmware 20190102 or older, you need one more configuration directive in
<strong>/etc/opensc/opensc.conf</strong> in <strong>app default</strong> section:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>        reader_driver pcsc {
                max_recv_size = 255;
        }</pre>
</div></div>
<div class="paragraph"><p>It is recommended that you install oseid profile files into OpenSC profile
directory (usually /usr/share/opensc/). Profile files for different versions
of OpenSC can be found in download directory.</p></div>
<div class="paragraph"><p>After this configuration step, you can use <strong>opensc-explorer</strong>, <strong>pkcs15-init</strong>,
<strong>pkcs15-tool</strong>, <strong>pkcs11-tool</strong> and other software to personalize your OsEID card.</p></div>
</div>
<div class="sect2">
<h3 id="_windows_minidriver_configuration">Windows minidriver configuration</h3>
<div class="paragraph"><p>If you plan to use OsEID card in Win 10 (for example in EDGE browser etc.) you
need install <strong>OpenSC</strong> package (0.17).</p></div>
<div class="paragraph"><p>Opensc version 0.17.0 functionality with OsEID card has been tested in WIN
10 (both 64 and 32 bit versions).  <strong>certutil</strong> command is fully functional
and TLS client auth in <strong>EDGE</strong> browser is working.  Opensc 0.18.0 and 0.19 fails
in EDGE, there is missing PIN dialog.</p></div>
<div class="paragraph"><p>To use OsEID card, You need configure OpenSC package (add OsEID ATR to
opensc.conf file) and you need update your registry file.  Please use
OsEID.reg file from download section.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Cryptography\Calais\SmartCards\OsEID]
"80000001"="opensc-minidriver.dll"
"ATR"=hex:3b,f5,00,00,02,10,80,4f,73,45,49,44
"ATRmask"=hex:ff,ff,00,ff,ff,ff,ff,ff,ff,ff,ff,ff
"Smart Card Key Storage Provider"="Microsoft Smart Card Key Storage Provider"
"Crypto Provider"="OpenSC CSP"

[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Cryptography\Calais\SmartCards\OsEID-token]
"80000001"="opensc-minidriver.dll"
"ATR"=hex:3b,f5,00,00,02,80,01,4f,73,45,49,44,00
"ATRmask"=hex:ff,ff,00,ff,ff,ff,ff,ff,ff,ff,ff,ff,00
"Smart Card Key Storage Provider"="Microsoft Smart Card Key Storage Provider"
"Crypto Provider"="OpenSC CSP"</pre>
</div></div>
<div class="paragraph"><p>Opensc from version 0.18.0 uses different location of file
opensc-minidriver.dll.  Please correct this in your register file:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>"80000001"="C:\Program Files\OpenSC Project\OpenSC\minidriver\opensc-minidriver.dll"</pre>
</div></div>
<div class="paragraph"><p>For 32 bit OpenSC version on 64 bit system:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>"80000001"="C:\Program Files (x86)\OpenSC Project\OpenSC\minidriver\opensc-minidriver.dll"</pre>
</div></div>
<div class="paragraph"><p>After personalizing your card, you need to use <strong>certutil -scinfo</strong> command in
windows command prompt to import certificates from card into windows
certificate store. After successful import of certificates, you can browse
personal certificates by <strong>certmgr</strong> and/or <strong>certlm</strong> command.</p></div>
</div>
<div class="sect2">
<h3 id="_explore_files_on_card">Explore files on card:</h3>
<div class="paragraph"><p>On linux/windows with installed OpenSC package You can use <strong>opensc-explorer</strong>
to browse files on Your new card:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>$ opensc-explorer
OpenSC Explorer version 0.14.0
Using reader with a card: ACS ACR38U 00 00
OpenSC [3F00]&gt; info

Dedicated File  ID 3F00

File path:     3F00
File size:     32767 bytes
ACL for SELECT:       N/A
ACL for LOCK:         N/A
ACL for DELETE:       CHV3
ACL for CREATE:       CHV3
ACL for REHABILITATE: N/A
ACL for INVALIDATE:   N/A
ACL for LIST FILES:   N/A
ACL for CRYPTO:       N/A
ACL for DELETE SELF:  N/A
Proprietary attributes:  00 02
Security attributes:     33 3F FF</pre>
</div></div>
<div class="paragraph"><p>There exists only one file on card. This is file with ID 3F00 - master file
(MF). Card security system (PIN/PUK codes) are inactive for now.</p></div>
</div>
<div class="sect2">
<h3 id="_card_initialization_creation_of_pkcs15_structure">Card initialization (creation of pkcs15 structure)</h3>
<div class="literalblock">
<div class="content monospaced">
<pre>pkcs15-init -C --so-pin 00000000 --so-puk 00000000 --pin 1111111</pre>
</div></div>
<div class="paragraph"><p>or better way, determine OpenSC version by running</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>opensc-tool -i</pre>
</div></div>
<div class="paragraph"><p>Then use oseid profile with the same version as OpenSC (for example 0.17):</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>pkcs15-init -C -c oseid_0.17 --so-pin 00000000 --so-puk 00000000 --pin 1111111</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_init_user_pin_puk">Init user pin/puk</h3>
<div class="literalblock">
<div class="content monospaced">
<pre>pkcs15-init --store-pin --id 01 --pin 11111111 --puk 11111111 --so-pin 00000000</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_finalize_card_activate_card_security_mechanism">Finalize card (activate card security mechanism)</h3>
<div class="literalblock">
<div class="content monospaced">
<pre>pkcs15-init -F</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_generate_rsa_key">Generate RSA key</h3>
<div class="paragraph"><p>(Warning, this operation is really slow, may run about 4 minutes but in some
cases over 30 minutes for 1024 bit key, generating 2048 bit key take about
45 minutes but in some cases several hours.)</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>pkcs15-init --generate-key rsa/1024 --auth-id 1 --pin 11111111 \
  --label gen_rsa_1024 --key-usage sign,decrypt</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_generate_rsa_key_with_openssl_and_upload_rsa_key">Generate RSA key with openssl and upload RSA key</h3>
<div class="literalblock">
<div class="content monospaced">
<pre>openssl genrsa -out 1024-key.pem 1024
pkcs15-init  --store-private-key 1024-key.pem --auth-id=1 --pin 11111111 \
  --key-usage sign,decrypt --id 1234</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_sign_message_with_rsa_key">Sign message with RSA key</h3>
<div class="literalblock">
<div class="content monospaced">
<pre>pkcs11-tool  --sign --slot 0 -m SHA1-RSA-PKCS --id 1234 -pin 11111111 \
  --input-file rsa_sign_testfile.txt --output-file rsa_sign_testfile.txt.sign</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_generate_ec_key_on_card">Generate EC key on card</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">For EC operations you need an OpenSC version 0.17 or newer version.</td>
</tr></table>
</div>
<div class="literalblock">
<div class="content monospaced">
<pre>pkcs15-init --generate-key ec-prime256v1 --auth-id 1 --pin 11111111</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_generate_key_with_openssl_and_upload_ec_key_certificate_to_card">Generate key with openssl and upload EC key/certificate to card</h3>
<div class="literalblock">
<div class="content monospaced">
<pre>openssl ecparam -name prime256v1 -genkey -noout -out prime256v1-key.pem
pkcs15-init --store-private-key prime256v1-key.pem  --auth-id=1 --pin 11111111

pkcs15-init -X prime256v1-cert.pem --pin 11111111 --auth-id=1</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_sign_with_ec_key">Sign with EC key</h3>
<div class="paragraph"><p>First read possible keys, select proper key id for sign (in example 121212)</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>pkcs15-tool --list-public-keys
pkcs15-crypt --pin 11111111 -k 121212 --signature-format "openssl" -s \
  -i testfile.txt.sha1 -o testfile.txt.pkcs11.sha1.sig</pre>
</div></div>
<div class="paragraph"><p>Another example for sign with EC key:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>pkcs11-tool --sign --signature-format "openssl" --slot 1 -m ECDSA \
  --input-file sign.this.txt --output-file sign.this.txt.signature</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_oseid_tool">OsEID-tool</h3>
<div class="paragraph"><p>You can use <strong>OsEID-tool</strong> software (available in tools section, only linux
version).  This software is designed to simplify some tasks on OsEID card
(can be used with MyEID card too).  Implemented functions:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>INFO - print info about card
INIT - do initialization of token by pkcs15-init
EC-CREATE-KEYS - use openssl to generate EC keys
EC-UPLOAD-KEYS - upload EC keys into initialized token
EC-GENERATE-KEYS  - generate keys on card
EC-SIGN-TEST - sign sample text by ECDSA operation and test this signature
EC-ECDH-TEST - generate shared secrets and test shared secrets
RSA-CREATE-KEYS -  use openssl to generate RSA keys
RSA-UPLOAD-KEYS - upload RSA keys into initialized token
RSA-GENERATE-KEYS - generate RSA key on card
RSA-SIGN-TEST - sign sample text with token RSA operation and test this signature
RSA-DECRYPT-TEST - decrypt test data
PKCS11-RSA-TEST - pkcs11-tool full test on RSA keys
CSR [key] [subject] - generate certificate signing request
CRT [key] [subject] - generate self signed certificate
RND-TEST - test random generator entropy</pre>
</div></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_faq">FAQ</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_what_is_oseid">What is OsEID ?</h3>
<div class="paragraph"><p>OsEID is smart card with cryptography support, realized in amateur
conditions.  It consist of one integrated circuit (microcontroller
Microchip/Atmel ATmega 128) and PCB (printed circuit board).  No more
components are needed.</p></div>
</div>
<div class="sect2">
<h3 id="_what_can_oseid_handle">What can OsEID handle ?</h3>
<div class="paragraph"><p>OsEID smart card supports both RSA cryptography and Elliptic curve
cryptography.  DES and AES ciphers are supported too.  It is (partially *)
compatible with ISO 7816 specifications.  Card support PKCS15 structure, RSA
up to 2048 bits and NIST elliptic curves (192,256,384 and 521 bits).</p></div>
<div class="paragraph"><p>It is designed to emulate Aventra MyEID card in universal microcontroller.
No special driver is needed for use in Linux/Windows.</p></div>
</div>
<div class="sect2">
<h3 id="_what_difference_is_between_myeid_and_oseid_card">What difference is between MyEID and OsEID card?</h3>
<div class="paragraph"><p>OsEID is hobby/amateur smart card, MyEID is professional card.  OsEID come
with open source firmware in well known, easily accessible and inexpensive
microcontroller.</p></div>
</div>
<div class="sect2">
<h3 id="_where_do_i_buy_a_card">Where do I buy a card ?</h3>
<div class="paragraph"><p>The card can not be bought, You have to make it. (Read documentation chapter
Making OsEID card)</p></div>
</div>
<div class="sect2">
<h3 id="_where_can_i_find_the_latest_firmware_version">Where can I find the latest firmware version ?</h3>
<div class="paragraph"><p>New versions are published on  <a href="https://sourceforge.net/projects/oseid">https://sourceforge.net/projects/oseid</a>
This is a primary site, code is available in tarball (all sources, firmware
files compiled from sources in HEX format, and PDF version of doc).</p></div>
<div class="paragraph"><p>Same site can be reached at <a href="https://oseid.sourceforge.io">https://oseid.sourceforge.io</a></p></div>
<div class="paragraph"><p>OsEID is also awailable on github - <a href="https://github.com/popovec/oseid">https://github.com/popovec/oseid</a></p></div>
<div class="paragraph"><p>OsEID development track all changes in OpenSC MyEID driver.  All changes in
OpenSC thats affect correct functions of OsEID card are examined and a
update is uploaded into <a href="https://github.com/popovec/oseid">https://github.com/popovec/oseid</a>. You usually need
these updates only if you use development versions of OpenSC.</p></div>
<div class="paragraph"><p>HTTP online doc is available on <a href="https://popovec.github.io/OsEID">https://popovec.github.io/OsEID</a></p></div>
</div>
<div class="sect2">
<h3 id="_in_what_application_i_can_use_this_smart_card">In what application I can use this smart card ?</h3>
<div class="ulist"><ul>
<li>
<p>
openssh - private rsa key can be stored on card
</p>
</li>
<li>
<p>
Firefox - secure login into web pages
</p>
</li>
<li>
<p>
windows Edge - secure login into web pages (tested with opensc 0.17)
</p>
</li>
<li>
<p>
Thunderbird - sign and decrypt emails
</p>
</li>
<li>
<p>
openvpn - secure login to openvpn server
</p>
</li>
<li>
<p>
easy-rsa - sign certificates by private key on card
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_why_rsa_calculation_is_so_slow">Why RSA calculation is so slow?</h3>
<div class="paragraph"><p>ATmega128 is 8 bit CPU and runs at  low frequency (about 13.5MHz).
The chip has only 8x8 bit multiplier, no special acceleration units for
RSA and ECC, as it is in the world of commercial cards.</p></div>
</div>
<div class="sect2">
<h3 id="_is_there_a_faster_alternative_to_oseid_card">Is there a faster alternative to OsEID card?</h3>
<div class="paragraph"><p>Yes, you can make OsEID token, but it is more complicated to make it.
A lot of skill with soldering of SMD components is needed. The token is about two
times faster than OsEID card.  Token can run 2048 RSA operation in about
10.5 seconds.  Overclocked version can run 2048 bit RSA operation in about 7 sec.</p></div>
</div>
<div class="sect2">
<h3 id="_why_oseid_is_denoted_as_beta_software">Why OsEID is denoted as BETA software?</h3>
<div class="paragraph"><p>OsEID card software is in extensive development.  New features are added,
and lot of old code is optimized.  Lot of internal interfaces are changed
from version to version.  Finally, card behavior is tested using (partial)
regression tests.  Through this, nobody can guarantee the flawless function
of such a large system.  It is advisable to leave the BETA tag (for now) on
this project.</p></div>
</div>
<div class="sect2">
<h3 id="_i_found_a_bug_in_oseid_card_where_can_i_report_it">I found a bug in OsEID card, where can I report it ?</h3>
<div class="paragraph"><p>You can contact me (author) by email &lt;<a href="mailto:popovec.peter@gmail.com">popovec.peter@gmail.com</a>&gt;</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_card_communication_protocol">Card communication protocol</h2>
<div class="sectionbody">
<div class="paragraph"><p>Application uses formatted data blocks to communicate with card. This data
blocks are APDUs - Application Protocol Data Units.</p></div>
<div class="paragraph"><p>APDU is constructed as block of bytes. There exists two types of APDU,
command and response.</p></div>
<div class="paragraph"><p>Command APDU consist of four bytes and optional fields <strong>Lc</strong>, <strong>DATA</strong> and <strong>Le</strong></p></div>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CLA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">INS</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Lc</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">DATA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Le</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Response APDU consist of optional response body and two status bytes:</p></div>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:80%;">
<col style="width:10%;">
<col style="width:10%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">RDATA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">SW1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">SW2</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>There exist four formats of command APDU:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
No command body, no response body
</p>
</li>
<li>
<p>
No command body, response
</p>
</li>
<li>
<p>
Command body, no response
</p>
</li>
<li>
<p>
Command body, response body
</p>
</li>
</ol></div>
<div class="paragraph"><p>Short APDU allow maximal length of DATA field 255 bytes, extended APDU allow
maximal lento of DATA field up to 65535 bytes.</p></div>
<div class="paragraph"><p>ISO7816-3 defines numbers <strong>Nc</strong> and <strong>Ne</strong> that corresponds to fields <strong>Lc</strong> and
<strong>Le</strong>. If <strong>Nc</strong> is 0, <strong>Lc</strong> field is not present, <strong>Nc</strong> in range 1..65535
corresponds to <strong>Lc</strong> in same range. Similar mapping from <strong>Ne</strong> to <strong>Le</strong> exist,
but <strong>Ne</strong> is in range 0..65536.</p></div>
<div class="paragraph"><p><strong>Nc</strong> value represent length of <strong>DATA</strong> field, <strong>Ne</strong> represent maximal length
of response body (below).  <strong>Lc</strong>/<strong>Le</strong> is coded in zero, one, two or three
bytes, coding depends on APDU case:</p></div>
<div class="paragraph"><p><strong>CASE 1</strong>: <strong>Nc</strong> = 0, <strong>Ne</strong> = 0, <strong>Lc</strong>,<strong>DATA</strong>,<strong>Le</strong> not present in APDU,
           APDU length = 4</p></div>
<div class="paragraph"><p><strong>CASE 2</strong>: <strong>Nc</strong> = 0, <strong>Ne</strong> &gt; 0, <strong>Le</strong> present in APDU, APDU length = 5 or 7</p></div>
<div class="ulist"><ul>
<li>
<p>
(S) one byte in range 1..255 &#8594; <strong>Le</strong> in range 1.255
</p>
</li>
<li>
<p>
(S) one byte 0 &#8594; <strong>Le</strong> = 256
</p>
</li>
<li>
<p>
(E) one byte 0 and two bytes (big endian) <strong>Le</strong> 1..65536
        (value 0 represent 65536 bytes for <strong>Le</strong>)
</p>
</li>
</ul></div>
<div class="paragraph"><p><strong>CASE 3</strong>: <strong>Nc</strong> &gt; 0, <strong>Ne</strong> = 0, <strong>Lc</strong>, and <strong>DATA</strong> present in APDU</p></div>
<div class="ulist"><ul>
<li>
<p>
(S) one byte in range 1..255 &#8594; <strong>Lc</strong> in range 1.255, APDU length 5+<strong>Lc</strong>
</p>
</li>
<li>
<p>
(E) one byte 0 and two bytes (big endian) <strong>Lc</strong> 1..65535, APDU length 7+<strong>Lc</strong>
</p>
</li>
</ul></div>
<div class="paragraph"><p><strong>CASE 4</strong>: <strong>Nc</strong> &gt; 0, <strong>Ne</strong> &gt; 0, <strong>Lc</strong>,<strong>DATA</strong>,<strong>Le</strong> present in APDU</p></div>
<div class="ulist"><ul>
<li>
<p>
(S) one byte in range 1..255 as <strong>Lc</strong>, DATA (<strong>Lc</strong> bytes), one byte <strong>Le</strong>
        in range 0..255, represent maximum response length (0=256 bytes).
        APDU length = 6+<strong>Lc</strong>
</p>
</li>
<li>
<p>
(E) one byte 0, two bytes <strong>Lc</strong>, DATA (<strong>Lc</strong> bytes max 65535, 0 is not
        allowed value here), two bytes, <strong>Le</strong> (value 0 represent 65536 bytes
        of response) APDU length = 9+<strong>Lc</strong>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Here (S)/(E) is used to mark Short or Extended variant of APDU.</p></div>
<div class="paragraph"><p>Application access card over card reader, card reader uses communication
protocol to transport APDU from application to card and from card.  This low
level transport uses Transport Protocol Data Unit - TPDU.</p></div>
<div class="paragraph"><p>APDU is mapped into TPDU, but mapping depends on card communication
protocols.  OsEID card uses T0 protocol.  T0 protocol is byte oriented
protocol.  OsEID token can use T0 or T1 protocol.</p></div>
<div class="sect2">
<h3 id="_apdu_mapping_to_t0_protocol">APDU mapping to T0 protocol</h3>
<div class="paragraph"><p>Card is always waiting for 5 bytes (header):</p></div>
<table class="tableblock frame-all grid-all"
style="
width:45%;
">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CLA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">INS</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P3</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p><strong>CLA</strong>, <strong>INS</strong>, <strong>P1</strong>,<strong>P2</strong> and <strong>P3</strong> bytes are transmitted to card.  <strong>P3</strong> byte
is used to inform card about optional command body or requested size of
returned data.  What exactly <strong>P3</strong> represent (command body or response
length) is determined from <strong>INS</strong> byte.</p></div>
<div class="paragraph"><p>Header is transmitted, then reader is waiting for procedure byte from card.
If this procedure byte is not received until some time, card reader reject
card as unresponsive.</p></div>
<div class="paragraph"><p>How procedure byte is processing is described in ISO7816-3/10.3.3 table 11.
If procedure byte is 0x60 (NULL), card reader only extend working time and
is waiting for new procedure byte.  This is used by card to inform card
reader that more time is needed for processing message.  This prevent
rejecting card as unresponsive.</p></div>
<div class="paragraph"><p>If 0x6X or 0x9X is received as procedure byte, this is handled as SW1
(status word), then whole status word (and next byte SW2) is returned to
application.</p></div>
<div class="paragraph"><p>If card reader receives INS (or INS negated, but this in not used in OsEID),
card reader send rest of APDU to card (or receives data from card). Another
values in procedure byte are not allowed.</p></div>
<div class="paragraph"><p>From ISO7816-3/10.3.1: It is assumed that the card and the interface device
know a priori the direction of transfer&#8230; How this can be fulfilled ?</p></div>
<div class="sect3">
<h4 id="_from_reader_view_only_short_cases_of_apdu">From reader view (only short cases of APDU):</h4>
<div class="paragraph"><p><strong>CASE 1</strong> (APDU length 4 bytes) - no <strong>Lc</strong>, no <strong>Le</strong>.  (Nc = 0, Ne = 0).
Because header length is 5 bytes, P3 byte is set to 00.  Header is sent to
card.  Card does not expect data field of APDU because P3 must be
interpreted as <strong>Le</strong> field (<strong>Lc</strong> field is not allowed to be zero).  T0
protocol does not allow us to inform card about Ne = 0 - P3 is interpreted
as <strong>Le</strong> field and card accept this as Ne = 256.</p></div>
<div class="paragraph"><p>Expected response is 2 bytes SW1,SW2.  After receiving procedure byte,
reader test this byte (NULL,INS,SW), and if this is not SW, new procedure
byte is waiting.</p></div>
<div class="paragraph"><p><strong>CASE 2</strong> (APDU length 5 bytes), header is sent to card, P3 represent the
<strong>Le</strong>, <strong>Lc</strong> is not present.  Expected response length is P3 + 2 (SW1,SW2)
bytes, for P3=0, 256 +2 bytes.  After receiving procedure byte, reader test
this byte, and if this is INS, reader reads expected response bytes.  Of
course, card may return different size of response as expected, this is not
an error.</p></div>
<div class="paragraph"><p><strong>CASE 3</strong> (APDU length 5 + P3 bytes), header is sent to card, P3 represent
the <strong>Lc</strong>, <strong>Le</strong> is not present.  Expected response is 2 bytes (SW1,SW2).
After receiving procedure byte, reader test this byte, and if this is INS,
reader transmit P3 bytes (DATA field of APDU) to card, then new procedure
byte is waiting.</p></div>
<div class="paragraph"><p><strong>CASE 4</strong> (APDU length 5 + P3 + 1 bytes) - same as for CASE 3 (there is no
way to transport <strong>Le</strong> to card).</p></div>
<div class="paragraph"><p>Card assumes that <strong>Ne</strong> = 256 in this case.  Card prepares response
data and signalize back to reader how many data bytes can be returned in
next command ( by SW1 = 0x61 or SW1=0x6C, SW2 is length of data, if SW2 is 0,
256 or more data bytes are available).  It is expected, that card
reader/application software then uses GET RESPONSE command for receiving the
data, and <strong>Ne</strong> is handled in procedure that generated GET RESPONSE command.</p></div>
</div>
<div class="sect3">
<h4 id="_from_card_view">From card view:</h4>
<div class="paragraph"><p>Card is waiting for 5 bytes from reader.  These bytes represent the header
of APDU.  If P3 is 0, this can not be a <strong>Lc</strong> field, P3 is then accepted as
<strong>Le</strong>.  If <strong>Lc</strong> is not present in APDU, then DATA field is absent too.  This
correspond to CASE 1 or CASE 2 APDU with <strong>Ne</strong>= 256.</p></div>
<div class="paragraph"><p>If P3 != 0, this is CASE 2 or CASE 3 or CASE 4.  We need INS to determine
APDU CASE 2 - only this case need transfer from card to reader.  For CASEs
3,4 <strong>Ne</strong> is assumed to be 256, P3 is <strong>Lc</strong>/<strong>Nc</strong>.  For CASE 2 <strong>Nc</strong> is 0, P3 is
<strong>Le</strong>/<strong>Ne</strong>.</p></div>
<div class="paragraph"><p>Exact definition if INS represent CASE 2 APDU is not available in ISO7816.</p></div>
<div class="paragraph"><p>From ISO7816-4 all commands where Nc=0 can be assumed as candidate for APDU
CASE 2.</p></div>
<div style="page-break-after:always"></div>
<table class="tableblock frame-all grid-all"
style="
width:100%;
">
<caption class="title">Table 4. Allowed cases for INS byte</caption>
<col style="width:9%;">
<col style="width:45%;">
<col style="width:9%;">
<col style="width:27%;">
<col style="width:9%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">INS</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">command name</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">OsEID</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">allowed cases</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">card to ICC</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">04</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">DEACTIVATE FILE</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0C</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">ERASE RECORD</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0E</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">ERASE BINARY</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 1,3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0F</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">ERASE BINARY</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 1,3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">PERFORM SCQL OPERATION</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">PERFORM TRANSACTION OPERATION</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">14</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">PERFORM USER OPERATION</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">20</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">VERIFY</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 1,3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">21</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">VERIFY</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE (1?),3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">22</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">MANAGE SECURITY ENVIRONMENT</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 1,3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">24</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CHANGE REFERENCE DATA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">26</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">DISABLE VERIFICATION REQUIREMENT</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 1,3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">28</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">ENABLE VERIFICATION REQUIREMENT</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 1,3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2A</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">PERFORM SECURITY OPERATION</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 3,4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2C</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">RESET RETRY COUNTER</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 1,3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">44</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">ACTIVATE FILE</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE (1,3?)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">46</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">GENERATE ASYMMETRIC KEY PAIR</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 1,3,4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">70</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">MANAGE CHANNEL</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 1,2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">82</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">EXTERNAL AUTHENTICATE</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 1,3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">84</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">GET CHALLENGE</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">*</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">86</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">GENERAL AUTHENTICATE</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 3,4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">87</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">GENERAL AUTHENTICATE</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 3,4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">88</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">INTERNAL AUTHENTICATE</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">A0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">SEARCH BINARY</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE (1,2,3,4?)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">A1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">SEARCH BINARY</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 3,4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">A2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">SEARCH RECORD</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 3,4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">A4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">SELECT</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 1,2,3,4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">B0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">READ BINARY</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">*</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">B1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">READ BINARY</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 2,4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">B2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">READ RECORD</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">B3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">READ RECORD</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 2,4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">C0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">GET RESPONSE</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">*</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">C2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">ENVELOPE</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE (1,3,4?)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">C3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">ENVELOPE</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE (1,3,4?)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">GET DATA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 2,(4?)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">*</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CB</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">GET DATA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 2,4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">D0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">WRITE BINARY</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">D1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">WRITE BINARY</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">D2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">WRITE RECORD</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">D6</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">UPDATE BINARY</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">D7</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">UPDATE BINARY</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">DA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">PUT DATA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">DB</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">PUT DATA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">DC</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">UPDATE RECORD</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">DD</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">UPDATE RECORD</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">E0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CREATE FILE</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">E2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">APPEND RECORD</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">E4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">DELETE FILE</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 1,3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">E6</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">TERMINATE DF</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">E8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">TERMINATE EF</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">FE</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">TERMINATE CARD USAGE</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CASE 1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>OsEID column is checked for all INS supported by OsEID.</p></div>
<div class="paragraph"><p>Some CASEs are marked by ?, if you need exact explanation about this
INS/APDU CASE, you need to read whole ISO7816.  ISO7816 is not precise
enough, for example:</p></div>
<div class="paragraph"><p>ENVELOPE ISO7816-4/7.6.2 Lc field present for encoding Nc &gt; 0, there is no
variant Nc=0, but ..  ISO7816-3/12.2.7 describes use of ENVELOPE command and
say: The absence of data bytes means "end of data string". In this case Nc=0.</p></div>
<div class="paragraph"><p>Last column in the table represent INS that need transfer from card to
reader.  Conservative implementation in OsEID uses only GET RESPONSE command
that need transfer from card to reader, because any other commands can
generate status 0x61XX and then GET RESPONSE is used to return data.</p></div>
</div>
<div class="sect3">
<h4 id="_extended_apdu_in_t0_protocol">Extended APDU in T0 protocol</h4>
<div class="paragraph"><p>Card does not have enough information about APDU case after header is
received.  Still INS and P3 can be used to allow transport of extended APDUs
over T0 protocol.</p></div>
<div class="paragraph"><p>There is no way to transport command APDU with data field &gt; 255.  Response
APDU can trasport at maximum 256 byte of response in one APDU.  In some
cases (Nc&lt;256, Ne&gt;256), extended APDU can be mapped to multiple APDUs to
allow receive more than 256 bytes of response.</p></div>
<div class="paragraph"><p>From card view:</p></div>
<div class="paragraph"><p>If card receives P3 == 0, then card assumes CASE 1 or CASE2S/E - same action
as for short APDUs.  INS can be used to determine CASE 1 or CASE 2S/E.  For
CASE 2 card assumes <strong>Ne</strong> 256 or more bytes (for example, RSA 4096 sign
operation a priori generates response with 512 bytes), and returns status
0x61XX.  Application software then reads up to <strong>Ne</strong> bytes by GET RESPONSE
command.  Of course, card may return some data and status 0x9000 - this
signalize us, that no more data are available, or new 0x61XX or 0x6cXX
status signalize us more data are available - GET RESPONSE is then used
until <strong>Ne</strong> bytes are received or status word 0x9000 is returned.</p></div>
<div class="paragraph"><p>What about CASE 3E and 4E?, if <strong>Nc</strong> is &lt; 256, P3 is set (in card reader or
application software) to <strong>Nc</strong> and process continues in same way as for CASE
2 S/E.  For <strong>Nc</strong> &gt; 255 ENVELOPE command can be used (not allowed for now in
OsEID). Alternative to ENVELOPE command is APDU chaining (described below).</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_examples_for_t0_protocol">Examples for T0 protocol</h3>
<div class="sect3">
<h4 id="_transmit_single_command_select_mf">Transmit single command (select MF)</h4>
<table class="tableblock frame-all grid-all"
style="
width:45%;
">
<col style="width:14%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:42%;">
<col style="width:7%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CLA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">INS</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P3/Lc</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">DATA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Le</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">APDU</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">A4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">empty</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">100</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p><strong>P3</strong> in this case represent <strong>Lc</strong> field, value 0 determines here no command body.
Card responds with two bytes <strong>SW1</strong>,<strong>SW2</strong>.</p></div>
<table class="tableblock frame-all grid-all"
style="
width:15%;
">
<col style="width:50%;">
<col style="width:50%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">SW1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">SW2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">61</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">05</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>If <strong>SW1</strong> is 0x61, and <strong>SW2</strong> is zero, this signalize us, that 256 or more
data can be received from card.  If <strong>SW2</strong> is in range 1..255, this represent
exact number of bytes that can be received from card.  To receive response,
<strong>GET RESPONSE</strong> command is used:</p></div>
<table class="tableblock frame-all grid-all"
style="
width:45%;
">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CLA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">INS</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">C0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">05</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>In this case, <strong>P3</strong> represent <strong>Le</strong> field in APDU (requested <strong>Le</strong> 100 is
reduced to number of bytes signalized by <strong>SW2</strong> from card, ISO7816-3
describes value <strong>Na</strong> - bytes available), here 5 bytes is
requested from card.  Card return 5 bytes and new status word <strong>SW1</strong>,<strong>SW2</strong>:</p></div>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:80%;">
<col style="width:10%;">
<col style="width:10%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">RDATA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">SW1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">SW2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00 01 02 00 01</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">90</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>If <strong>SW2</strong> signalize us than 5 bytes are available in card, we can receive
only part of data from card:</p></div>
<table class="tableblock frame-all grid-all"
style="
width:45%;
">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CLA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">INS</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">C0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">03</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Then response consist from RDATA of maximal length of 3 bytes and new status
word <strong>SW1</strong>,<strong>SW2</strong> signalize us, than two more bytes are available in card.
(can be received by subsequent GET RESPONSE command)</p></div>
<table class="tableblock frame-all grid-all"
style="
width:65%;
">
<col style="width:80%;">
<col style="width:10%;">
<col style="width:10%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">RDATA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">SW1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">SW2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00 01 02</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">61</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">02</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>If <strong>GET RESPONSE</strong> command set <strong>P3</strong> byte to value greater that <strong>SW2</strong> (in case
<strong>SW1</strong> ==0x61), then card return new status word:</p></div>
<table class="tableblock frame-all grid-all"
style="
width:15%;
">
<col style="width:50%;">
<col style="width:50%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">SW1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">SW2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">6c</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">02</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>this signalize us, that exact two bytes are available.</p></div>
<div class="paragraph"><p>Application software repeat <strong>GET DATA</strong> command to receive all data from
card, last status word 0x9000 terminates this loop.  All data are
concatenated into <strong>RDATA</strong> and last status word is appended to this block.
This response is then returned as response APDU.  If <strong>RDATA</strong> is longer that
requested <strong>Le</strong> in command APDU, or some of status word <strong>SW1</strong>,<strong>SW2</strong> signalize
warning or error, only status word is returned as response APDU.</p></div>
</div>
<div class="sect3">
<h4 id="_transmit_command_with_data_field">Transmit command with data field</h4>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CLA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">INS</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">DATA1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">DATA2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">A4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">02</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3f</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>This transmit is splitted into two parts, card first receive 5 bytes.  If
<strong>P3</strong> is not ZERO, <strong>INS</strong> is checked to determine meaning of P3 value.  In
case of <strong>SELECT</strong> command, card return <strong>INS</strong> byte back to reader (as
procedure byte) and then card is waiting for <strong>P3</strong> bytes from reader as DATA.</p></div>
<div class="paragraph"><p>Response to this command is handled in same way as in previous example -
<strong>GET RESPONSE</strong> is used to receive <strong>RDATA</strong> from card.</p></div>
<div class="paragraph"><p>T0 protocol limitation allow us to send at maximum 255 bytes of <strong>DATA</strong> bytes.</p></div>
<div class="paragraph"><p><strong>ENVELOPE</strong> command should be used to transmit more data in T0 protocol
(Please read ISO7816-3 12.2.7 for details), but this is not enabled in OsEID
card for now (due limited flash size)..</p></div>
<div class="paragraph"><p>Alternative method may use APDU chaining (ISO7816-4 5.1.1.1).</p></div>
<div class="paragraph"><p>If command generates response 256 or more bytes, 1st status word is 0x6100, and
<strong>GET RESPONSE</strong> is then used to read 256 bytes of response. New status word
(from <strong>GET RESPONSE</strong> command) then can signalize end of transport (0x9000)
or sets <strong>SW1</strong> to 0x61 and <strong>SW2</strong> to remaining bytes count.</p></div>
</div>
<div class="sect3">
<h4 id="_read_data_from_card_no_data_block_in_command">Read data from card (no data block in command)</h4>
<table class="tableblock frame-all grid-all"
style="
width:45%;
">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CLA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">INS</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">B0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">9</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>If <strong>INS</strong> defines read operation (in example <strong>READ BINARY</strong> operation), <strong>P3</strong> value
is used as  number of returned bytes for subsequent <strong>GET RESPONSE</strong>
command. If <strong>P3</strong> is ZERO, this mean 256 bytes is to be returned by card.</p></div>
<div class="paragraph"><p>After card receive this command, there is no <strong>INS</strong> byte returned back to
reader (as in previous example), but <strong>SW1</strong>,<strong>SW2</strong> is returned. If <strong>SW1</strong> is
0x61, similar procedure as in previous example can be used to read response.</p></div>
<div class="paragraph"><p>An attentive reader may notice, that card reader must support (for T0
protocol) transport of 5+255 bytes to card and 256+2 bytes from card in one
transport.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_apdu_mapping_to_t1_protocol">APDU mapping to T1 protocol</h3>
<div class="paragraph"><p>T1 protocol uses packet oriented transport to and from card.  For details
about this, please read ISO7816-3/11.  APDU is splitted into <strong>I</strong> frames and
then reassembled in card back to original APDU.  State machine for this can
be found in opensource project <a href="#CCIDusb">[CCIDusb]</a>, in directory src/towitoko/ and
src/openct/proto-t1.c.  Reverse joining of <strong>I</strong> frames can be found in OsEID
sources, in file targets/xmega128a4u/ccid.c. Of course, response APDU is
splitted in card and reassembed in reader/host.</p></div>
<div class="paragraph"><p>If command APDU uses short case 4 (described above), reader must support at
minimal transport for 4+1+255+1 = 261 bytes.</p></div>
<div class="paragraph"><p>If command APDU uses extended case 4, then minimal transport size is
4+3+256+2 = 265 bytes, and for maximal <strong>Lc</strong> 4+3+65535+2  = 65544 bytes.</p></div>
<div class="paragraph"><p>Transport of responses must support 65536+2 bytes.</p></div>
<div class="paragraph"><p>OsEID token integrated CCID reader allow transport  of 271 bytes in one
transport (dwMaxCCIDMsgLen = 271). CCID header need 10 bytes overhead, then
maximal message length is 261 bytes. Because <strong>I</strong> frames are chained, there
is no limitation in transport of extended APDU over T1 protocol, T0 is
limited - max 255 bytes in DATA field.</p></div>
<div class="paragraph"><p>In this documentation APDU - TPDU mapping is described for all commands (T0
protocol).  Bytes CLA, INS, P1, P2 from APDU is mapped to TPDU without
change, byte P3 in TPDU is mapped to <strong>Lc</strong> or <strong>Le</strong> field of APDU.</p></div>
</div>
<div class="sect2">
<h3 id="_apdu_chaining">APDU chaining</h3>
<div class="paragraph"><p>APDUs CASE 3S/E and 4S/E can be chained.  CLA must be set 0x10 for any
chained APDU and last APDU in chain must have CLA = 0.  For any APDU in
chain with CLA 0x10 <strong>Le</strong> field is ignored.  Only <strong>Le</strong> field from last APDU
in chain (CLA=0) is used.  OsEID allows to chain CLASS 3S with CASE 3E or
4S/4E APDUs. Detail about APDU chaining can be found in ISO7816-4/5.1.1.1</p></div>
<div class="paragraph"><p>Warning, OsEID for now does not have support for signalizing card
capabilities (ISO7816-4/8.1.1.2.7) and because this, APDU chaining is not
signalized.</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_filesystem">Filesystem</h2>
<div class="sectionbody">
<div class="paragraph"><p>Card uses a simple filesystem compatible with ISO7816.  However, the
functions of filesystem do not meet all the requirements defined in ISO7816.
Please, follow the comments on these inconsistencies in the following text.</p></div>
<div class="paragraph"><p>Filesystem is in ATMEGA FLASH.  Security data (PINs, PUKs) are stored in
ATMEGA EEPROM.  Filesystem is organized as simple linear structure, header,
file, header, file&#8230;.  header, file.  Simplicity of filesystem limits file
delete operation.  Delete operation only marks file as deleted.
Deallocation of file space is available only for files at end of filesystem.
There does not exist any CRC data checks or other consistency check in
filesystem.  (Already a BETA version of FLASH friendly COW filesystem
exists, with CRC and other features, but not open source for now.  Because
of the code size it may not be available at all.  The development is
currently frozen.)</p></div>
<div class="paragraph"><p>File size is limited to max 32767 bytes, DF files are always auto sized.  If
DF file is created, only the space for file header is allocated in card.  DF
file does not contain information about children, but children know what DF
is their parent.  There is no limit on number of files on card.  Filesystem
limit is 65536 bytes.  (MyEID uses PUT DATA: INITIALIZE APPLET to set
maximum number of files, this operation is supported, but value is ignored.)</p></div>
<div class="paragraph"><p>Filesystem on blank card already contain two files, the file with ID=3F00
(MF) at top level and DF with ID 5015.  There is way to remove the DF 5015,
please read PUT DATA: INITIALIZE APPLET command description.  There is
difference in MyEID and OsEID card, new MyEID card comes with different
security attributes.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>MyEID (ver 3.3.3/4.0.1                  OsEID:

OpenSC [3F00]&gt; info                     OpenSC [3F00]&gt; info

Dedicated File  ID 3F00                 Dedicated File  ID 3F00

File path:     3F00                     File path:     3F00
File size:     32767 bytes              File size:     32767 bytes
ACL for SELECT:       N/A               ACL for SELECT:       N/A
ACL for LOCK:         N/A               ACL for LOCK:         N/A
ACL for DELETE:       CHV3              ACL for DELETE:       CHV3
ACL for CREATE:       CHV3              ACL for CREATE:       CHV3
ACL for REHABILITATE: N/A               ACL for REHABILITATE: N/A
ACL for INVALIDATE:   N/A               ACL for INVALIDATE:   N/A
ACL for LIST FILES:   N/A               ACL for LIST FILES:   N/A
ACL for CRYPTO:       N/A               ACL for CRYPTO:       N/A
ACL for DELETE SELF:  N/A               ACL for DELETE SELF:  N/A
Proprietary attributes:  00 02          Proprietary attributes:  00 02
Security attributes:     33 3F FF       Security attributes:     11 3F FF

OpenSC [3F00]&gt; cd 5015                  OpenSC [3F00]&gt; cd 5015
OpenSC [3F00/5015]&gt; info                OpenSC [3F00/5015]&gt; info

Dedicated File  ID 5015                 Dedicated File  ID 5015

File path:     3F00/5015                File path:     3F00/5015
File size:     32767 bytes              File size:     32767 bytes
DF name:     \xA0\x00\x00\x00cPKCS-15   DF name:     \xA0\x00\x00\x00cPKCS-15
ACL for SELECT:       N/A               ACL for SELECT:       N/A
ACL for LOCK:         N/A               ACL for LOCK:         N/A
ACL for DELETE:       NEVR              ACL for DELETE:       CHV1
ACL for CREATE:       CHV3              ACL for CREATE:       CHV1
ACL for REHABILITATE: N/A               ACL for REHABILITATE: N/A
ACL for INVALIDATE:   N/A               ACL for INVALIDATE:   N/A
ACL for LIST FILES:   N/A               ACL for LIST FILES:   N/A
ACL for CRYPTO:       N/A               ACL for CRYPTO:       N/A
ACL for DELETE SELF:  N/A               ACL for DELETE SELF:  N/A
Proprietary attributes:  00 02          Proprietary attributes:  00 02
Security attributes:     33 FF FF       Security attributes:     11 1F FF</pre>
</div></div>
<div class="paragraph"><p>If MyEID/OsEID card is erased by <em>pkcs15-init -E</em> command, security
attributes are set at same values as described here for OsEID card.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">hexadecimal values in next text are prefixed by <strong>0x</strong> or suffixed by <strong>h</strong>
for example 0x45 or 45h. In some cases, hexadecimal values are without
prefix/suffix, but it can be deduced from context that this number is
hexadecimal. Sorry about this. This doc is only a draft, not the final version.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">OsEID documentation is still incomplete, please consult MyEID
reference manual 2.1.4, lot of MyEID APDUs are identical with OsEID APDUs.
Do not expect a completely identical functions, keep in mind, OsEID is a hobby
card.</td>
</tr></table>
</div>
<div class="sect2">
<h3 id="_select_file">SELECT FILE</h3>
<div class="paragraph"><p>Selection mechanism manages current DF and current EF. If EF is selected,
parent DF is set as current DF.</p></div>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1  </th>
<th class="tableblock halign-left valign-top" > P2  </th>
<th class="tableblock halign-left valign-top" > P3/Lc </th>
<th class="tableblock halign-left valign-top" > DATA </th>
<th class="tableblock halign-left valign-top" > Le</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xA4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>(CASE 1S, CASE 2S, CASE 3S, CASE 4S)</p></div>
<div class="ulist"><ul>
<li>
<p>
P1 - see below
</p>
</li>
<li>
<p>
P2 - 0 = return <a href="#FCI">[FCI]</a> of selected file, 0x0c - return status only
</p>
</li>
</ul></div>
<div class="paragraph"><p>TPDU:
- P3 - in range 0..0xff, corresponding to DATA field length</p></div>
<div class="paragraph"><p>APDU:
- Lc corresponding to DATA field length
- Data length corresponding to Lc
- Le maximal size of response</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">If Le field is absent (T1 protocol) MyEID (4.0.1) still return FCI,
OsEID return only status bytes.  ISO7816-4:2005(E)/7.1.1: "If the Le field
is absent, ..  the response data field shall also be absent."</td>
</tr></table>
</div>
<div class="paragraph"><p>Select file is controlled by P1, P2 parameters. There are several P1, P2
valid combinations. For some of combinations Lc != 0 and data field must
contain specific data</p></div>
<div class="ulist"><ul>
<li>
<p>
P1 = 0, P2 == 0, P3 = 0, no Lc field
  T0 protocol: CASE 2 APDU, P3 must be set to 0 - corresponds to Ne=256
  T1 protocol: CASE 1 APDU, there is no Lc/DATA/Le field
  T1 protocol: CASE 2 APDU, P3 correspond to Le field
  Select MF (0x3f00)
</p>
</li>
</ul></div>
<div class="paragraph"><p>For rest of commands P2 is 0 or 0x0c:</p></div>
<div class="ulist"><ul>
<li>
<p>
P1 = 3, P3 = 0, no Lc field
  T0 protocol: CASE 2 APDU, P3 must be set to 0 - corresponds to Ne=256
  T1 protocol: CASE 1 APDU, there is no Lc/DATA/Le field
  T1 protocol: CASE 2 APDU, P3 correspond to Le field
  Select parent DF of the current DF
</p>
</li>
<li>
<p>
P1 = 8, P3/Lc &gt;=2, Lc even, Data represents IDs of path to file:
  Select by path from MF (CASE 3/4)
</p>
</li>
<li>
<p>
P1 = 9, P3/Lc &gt;=2, Lc even, Data represents IDs of path to file:
  Select by path from current DF (CASE 3/4)
</p>
</li>
<li>
<p>
P1 = 4, P3/Lc &gt;0, Lc &lt; 17, Data represents filename:
  Select DF by name (CASE 3/4)
</p>
</li>
<li>
<p>
P1 = 1, P3/Lc = 2, Data file ID:
  Select child DF (CASE 3/4)
</p>
</li>
<li>
<p>
P1 = 2, P3/Lc = 2, Data file ID:
  Select EF under current DF (CASE 3/4)
</p>
</li>
<li>
<p>
P1 = 0, P2 = 0, P3/Lc = 2, Data = 0x3f00:
  Select MF (CASE 3/4)
</p>
</li>
<li>
<p>
P1 = 0, P3=Lc = 2, Data = ID:
  Firstly the file with ID in all children of selected DF is searched, if ID is found,
  FCI/status is returned.  If previous search fails, test if parent of selected
  file matches ID.  If this fails too, file in neighbors of selected
  file is searched. (CASE 3/4)
</p>
</li>
<li>
<p>
P2 = 0x0c - do not return <a href="#FCI">[FCI]</a>/<a href="#FCP">[FCP]</a>/<a href="#FMD">[FMD]</a>. This is usefull for T0
  protocol, where Ne is assumed to be 256.  Same functionality can be achieved
  if T1 protocol is used and <strong>Le</strong> is not present in APDU.
</p>
</li>
</ul></div>
<div class="paragraph"><p>If select command failed, last correctly selected file remains selected.</p></div>
<div class="paragraph"><p>MyEID difference: MyEID (according MyEID reference manual 2.1.4) does not
support values 1,2,3 for P1.  MyEID does not support P2 = 0x0c.
MyEID uses T1 protocol, FCI is always returned even Le is not present in
APDU (tested on MyEID 3.3.3/4.0.1).</p></div>
</div>
<div class="sect2">
<h3 id="_create_file">CREATE FILE</h3>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1   </th>
<th class="tableblock halign-left valign-top" > P2   </th>
<th class="tableblock halign-left valign-top" > P3/Lc </th>
<th class="tableblock halign-left valign-top" > DATA </th>
<th class="tableblock halign-left valign-top" > Le</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xE0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">empty</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>(CASE 3S)</p></div>
<div class="paragraph"><p>TPDU:
- P3 - in range 18..255, corresponding to DATA field length</p></div>
<div class="paragraph"><p>APDU:
- Lc corresponding to DATA field length  18..255
- DATA length corresponding to Lc
- Le empty</p></div>
<div class="paragraph"><p>Data must contain File Control Parameters (FCP) information.</p></div>
<div class="paragraph"><div class="title">FCP structure</div><p>First byte (0x62) represents FCP tag, second byte represents sum of length of
all tags in structure. The rest of structure is formed by TLV items. TLV items
order doesn&#8217;t matter. TLV item with the same TAG value overwrites previous item
with the same tag except TAG 0x80 and 0x81, these tags are mutually exclusive and
can not be repeated.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>Value   bytes   description

0x62    1       FCP tag
16..255 1       length of FCP structure

0x80    1       File size TAG (for EF)
1..2    1       length of value
value   1..2    size of file in bytes

0x81    1       File size TAG (for DF and key EF)
2       1       length of value
value   2       size of file in bytes

0x82    1       File description tag
1..6    1       length of value
value   1..6    File description byte(s) check table below

0x83    1       file identifier
2       1       length of value
value   2       File Identifier

0x84    1       DF Name tag    (optional, default none)
1..16   1       length of value
value   1..16   Optional DF name

0x85    1       Proprietary Information (optional, default 0)
2       1       length of value
value   2       check table below

0x86    1       Security Attributes (optional, default 0x000000)
3..16   1       length of value
value   3..16   only first 3 bytes are used, rest of bytes are ignored

0x8A    1       Life Cycle Status (optional, ignored)
1       1       length of value
value   1       check table below</pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">key file size can be specified by tag 0x80.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">DF size is handled in card internally. Size of DF specified by tag 0x81
is only symbolic, card allocates filesystem space for DF dynamically.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">TAG 0x8a (Lifecycle) can be provided in FCP structure, but is ignored by
<strong>CREATE FILE</strong> command</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">Before, between or after BER-TLV data objects, 0x00 or 0xffs without any meaning may occur.</td>
</tr></table>
</div>
<div class="paragraph"><div class="title">File description byte(s)</div><p>only the first byte is used, rest is ignored.</p></div>
<div class="paragraph"><p>allowed values:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>0x01    EF working, transparent structure
0x11    EF proprietary, for RSA key
0x22    EF proprietary, for EC key
0x23    EF proprietary, for EC key secp256k1 Experimental!
0x19    EF proprietary, for DES key
0x29    EF proprietary, for AES key
0x38    DF
0x41    EF Generic secret file (this file can not be used for
           cryptographics operation)</pre>
</div></div>
<div class="paragraph"><p>Any value can be orred with value 0x40, this mark file as shareable.</p></div>
<div class="paragraph"><p>BEWARE! filetype 0x23 is not used by original MyEID card. In future, MyEID card may
use the 0x23 filetype to different purposes. OsEID project will then change
secp256k1 key marking to another filetype or move marking into Proprietary
Information field.</p></div>
<div class="listingblock">
<div class="title">File Identifier</div>
<div class="content monospaced">
<pre>reserved: 0x3f00, 0x3fff, 0xffff</pre>
</div></div>
<div class="listingblock">
<div class="title">KEY EF</div>
<div class="content monospaced">
<pre>1st byte:
X0h - not valid key file
X1h - valid key file
X3h - key valid, key generated on card

X = AC to be cleared after RSA operation - due to incomplete information
about this in MyEID documentation, upper nibble is ignored by OsEID card.

If KEY file is created, 1st byte is always masked to X0h.  After successful
upload of private part of EC key or modulus of RSA key or AES/DES key
upload, the 1st byte of proprietary information is changed.  Beware, file
can be marked as valid, but not all parts of key are in file.  For EC key
this is no problem if public part is missing, but incomplete RSA key then
generates error in RSA security operation.

2nd byte:
00h     - default

OsEID support is planed for next releases (2020XXXX):

bit 0:  if set, object is marked as session object, after card reset
        object is automatycaky removed from card
bi7 3:  for extractable keys, if set, key can be wrapped</pre>
</div></div>
<div class="listingblock">
<div class="title">EF</div>
<div class="content monospaced">
<pre>1st byte: 0x00 RFU
2nd byte: 0x00 RFU</pre>
</div></div>
<div class="listingblock">
<div class="title">DF</div>
<div class="content monospaced">
<pre>1st byte: 0x00 RFU
2nd byte: 0x00 or 0x02 other values RFU
          0x02 = this DF can not be deleted</pre>
</div></div>
<div class="listingblock">
<div class="title">Lifecycle</div>
<div class="content monospaced">
<pre> (card uses only codes 1 and 7)
0       - no info
1*      - creation
3       - initialization
4       - operational (deactivated)
5       - operational (activated)
6       - operational (deactivated)
7*      - operational (activated)</pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">Lifecycle is managed internally (by PUT DATA/initialize applet and ACTIVATE APPLET
commands), value in FCP is ignored</td>
</tr></table>
</div>
<div class="paragraph"><p>You can found more information about key file in PUT DATA and GENERATE
PUBLIC KEY PAIR command.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">OpenSC versions 0.14 to 0.19 (myeid driver) can handle only limited set of key sizes:
512, 768, 1024, 1536, 2048,</td>
</tr></table>
</div>
<div class="paragraph"><p><strong>Example apdu</strong></p></div>
<div class="paragraph"><p>Create working EF with transparent structure, ID 2233, size 511, security
attributes set to 01 1F FF:</p></div>
<div class="exampleblock">
<div class="content">
<div class="paragraph"><p>00 e0 00 00 12 62 10 80 02 01 ff 82 01 01 83 02 22 33 86 03 01 1f ff</p></div>
</div></div>
<div class="paragraph"><p><strong>Responses</strong></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>No error</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x9000
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if P1 != 0 or P2 != 0</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6a86 - Incorrect parameters P1-P2
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if Lc = 0</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6700 - Incorrect length
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if transport of Lc bytes of data fail</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6984 invalid data
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if there is not selected DF</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6a82 - file not found
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>missing FCP template byte (0x62) in 1st position in data</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6984 - invalid data
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>any wrong tag/value in FCP data</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6984 - invalid data
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if DF name already exists</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6A89 - already exists
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>security status (does not allow file creation)</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6982 - security status not satisfied
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>file with same ID already exists in current DF</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6A89 - already exists
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>problem to write file in filesystem</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6985 -  condition not satisfied
</p>
</li>
</ul></div>
</dd>
</dl></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">From ISO 7816-4/7.1.1 <strong>SELECT</strong> APDU with P1 = 0: If P2 is set to 0 and
the command data field provides a file identifier, then that file identifier
shall be unique in the following three environments: the immediate children
of the current DF, the parent DF and the immediate children of the parent
DF.  Function <strong>CREATE FILE</strong> allows to create files with same ID in these
three environments.  Please check <strong>SELECT</strong> command to find how the file
selection is handled.</td>
</tr></table>
</div>
<div style="page-break-after:always"></div>
</div>
<div class="sect2">
<h3 id="_delete_file">DELETE FILE</h3>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1   </th>
<th class="tableblock halign-left valign-top" > P2   </th>
<th class="tableblock halign-left valign-top" > P3/Lc  </th>
<th class="tableblock halign-left valign-top" > DATA </th>
<th class="tableblock halign-left valign-top" > Le</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xE0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">empty</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">empty</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>(CASE 1, in future CASE 3S)</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">CLA A0 is also supported (because OpenSC uses this class for delete
file operation in MyEID driver)</td>
</tr></table>
</div>
<div class="paragraph"><p>TPDU:
- P3 - 0</p></div>
<div class="paragraph"><p>APDU:
- Lc - 0
- DATA not present
- Le - empty</p></div>
<div class="paragraph"><p>The DELETE FILE command does removing of file.  File must be selected by
SELECT command before calling DELETE FILE command.  If DF is selected, whole
subtree of DF is deleted too.  Before deletion of file, access condition is
checked.  After file delete operation a parent DF of deleted file is
selected.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">files are only marked as deleted, and only marked files at end of
filesystem are really deallocated and space is returned to filesystem.
Returned space is filled by value 0xff.</td>
</tr></table>
</div>
<div class="paragraph"><p>If subtree operation is requested, there is no check if some DF in subtree
is marked by proprietary flag as undeletable. Only currentd DF proprietary
flag is checked.</p></div>
<div class="paragraph"><p>For completeness,  ETSI TS 102 222 V7.0.0 (2006-08): Data field can be used
to specify file ID for delete operation, in this case length of data field
(Lc) is set to 2, and fiel ID is in data field.  This is not supported by
OsEID card for now.</p></div>
<div class="paragraph"><p><strong>Responses</strong></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>No error</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x9000
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if P1 != 0 or P2 != 0</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6a86 - Incorrect parameters P1-P2
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if Lc != 0</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6700 - Incorrect length
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if there is not selected file</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6986 command not allowed, (no current EF)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>DF/MF file is marked by proprietary attribute as undeletable</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6985 condition of use not satisfied
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>security status (does not allow file deletion)</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6982 - security status not satisfied
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>select of parent failed</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6A82  File not found
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>memory subsystem error</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6581 memory fail
</p>
</li>
</ul></div>
</dd>
</dl></div>
<div style="page-break-after:always"></div>
</div>
<div class="sect2">
<h3 id="_erase_binary">ERASE BINARY</h3>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1 </th>
<th class="tableblock halign-left valign-top" > P2  </th>
<th class="tableblock halign-left valign-top" > P3/Lc  </th>
<th class="tableblock halign-left valign-top" > DATA </th>
<th class="tableblock halign-left valign-top" > Le</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x0E</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">empty</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>(CASE 1, in future CASE 3S)</p></div>
<div class="ulist"><ul>
<li>
<p>
P1 in range 0-0x7f
</p>
</li>
<li>
<p>
P2 in range 0-0xff
</p>
</li>
</ul></div>
<div class="paragraph"><p>TPDU:
- P3 - 0</p></div>
<div class="paragraph"><p>APDU:
- Lc  0
- DATA empty
- Le empty</p></div>
<div class="paragraph"><p>The ERASE BINARY command fills selected transparent EF with 0xff value. Start
of fill is selectable by P1, P2 parameters. P1 represent bits 14..8, P2
represent bit 7..0 of offset. End of fill arrea is not selectable, file is
filled up to end.</p></div>
<div class="paragraph"><p><strong>Responses</strong></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>No error</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x9000
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if P1,P2 is over 0x7fff</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6a86 - Incorrect parameters P1-P2
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if Lc = 0</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6700 - Incorrect length
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if there is not selected file</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6986 command not allowed,(no current EF)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>file is RSA/EC key file or DF</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6985 condition of use not satisfied
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>security status (does not allow file deletion)</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6982 - security status not satisfied
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>offset in P1,P2 is outside EF size</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6B00 outside EF
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>memory subsystem error</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6581 memory fail
</p>
</li>
</ul></div>
</dd>
</dl></div>
<div class="paragraph"><p>ISO7816-4/7.2.7 allow Lc=2, and in data field end of fill arrea in file can
be specified.  OsEID does not allow Lc=2 for now.</p></div>
<div style="page-break-after:always"></div>
</div>
<div class="sect2">
<h3 id="_update_binary">UPDATE BINARY</h3>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1 </th>
<th class="tableblock halign-left valign-top" > P2  </th>
<th class="tableblock halign-left valign-top" > P3/Lc  </th>
<th class="tableblock halign-left valign-top" > DATA </th>
<th class="tableblock halign-left valign-top" > Le</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xD6</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">empty</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>(CASE 3S)</p></div>
<div class="ulist"><ul>
<li>
<p>
P1 - in range 0..0x7f
</p>
</li>
<li>
<p>
P2 - in range 0..0xff
</p>
</li>
<li>
<p>
P3 - in range 1..0xff
</p>
</li>
</ul></div>
<div class="paragraph"><p>APDU:</p></div>
<div class="ulist"><ul>
<li>
<p>
Lc 1..0xff
</p>
</li>
<li>
<p>
DATA binary data to write into file
</p>
</li>
<li>
<p>
Le 0
</p>
</li>
</ul></div>
<div class="paragraph"><p>The UPDATE BINARY command updates data in selected transparent EF. Start
of update is selectable by P1, P2 parameters. P1 represents bits 14..8, P2
represents bit 7..0 of offset. Lc represents number of updated bytes.</p></div>
<div class="paragraph"><p><strong>Responses</strong></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>No error</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
61 xx - xx of data bytes are available (for GET RESPONSE COMMAND)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if P1,P2 is over 0x7fff</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6a86 - Incorrect parameters P1-P2
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if LE = 0</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6700 - Incorrect length
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if transport of Lc bytes of data fail</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6984 invalid data
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if there is not selected file</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6986 command not allowed,(no current EF)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>file is RSA/EC/DES/AES key file or DF</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6985 condition of use not satisfied
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>security status (does not allow file update)</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6982 - security status not satisfied
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>offset in P1,P2 is outside EF size</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6b00 end of size before LE
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>memory subsystem error</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6581 memory fail
</p>
</li>
</ul></div>
</dd>
</dl></div>
<div style="page-break-after:always"></div>
</div>
<div class="sect2">
<h3 id="_read_binary">READ BINARY</h3>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:8%;">
<col style="width:8%;">
<col style="width:8%;">
<col style="width:66%;">
<col style="width:8%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1 </th>
<th class="tableblock halign-left valign-top" > P2  </th>
<th class="tableblock halign-left valign-top" > P3/Le</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xB0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>(CASE 2S)</p></div>
<div class="ulist"><ul>
<li>
<p>
P1  in range 0..0x7f
</p>
</li>
<li>
<p>
P2  in range 0..0xff
</p>
</li>
<li>
<p>
P3  how many data is requested from card (Le)
</p>
</li>
</ul></div>
<div class="paragraph"><p>APDU:</p></div>
<div class="ulist"><ul>
<li>
<p>
Lc  empty
</p>
</li>
<li>
<p>
Data empty
</p>
</li>
<li>
<p>
Le Number of bytes to read.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The READ BINARY command reads data from selected transparent EF (file type
0x01).  Start of read is selectable by P1, P2 parameters.  P1 represents bits
14..8, P2 represents bits 7..0 of offset.  For Le=0, 256 bytes are to be read;</p></div>
<div class="paragraph"><p>Warning: if Le &gt; 256 (extended APDU) Le is clamped by card to 256</p></div>
<div class="paragraph"><p>If Le is 0 (Ne = 256), up to 256 bytes is to be read from offset in P1,P2 to
end of file. For Le != 0, 0x6282 response is generated if offset + Le is
over file end.</p></div>
<div class="paragraph"><p><strong>Responses</strong></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>No error</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
61 xx - xx of data bytes are available (for GET RESPONSE COMMAND)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if P1,P2 is over 0x7fff</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6a86 - Incorrect parameters P1-P2
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if there is not selected file</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6986 command not allowed, (no current EF)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>file is RSA/EC/DES/AES key file or DF</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6985 condition of use not satisfied
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>security status (does not allow file read)</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6982 - security status not satisfied
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>offset in P1,P2 is outside EF size</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6282 - end of size before LE -  if (P1|P2 + Ne &gt; file size)
  (MyEID 4.0.1 return code in this case: 0x6700)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>memory subsystem error</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6281 part of data is corrupted (older version of OsEID)
</p>
</li>
<li>
<p>
0x6581 Memory failure
</p>
</li>
</ul></div>
</dd>
</dl></div>
<div style="page-break-after:always"></div>
</div>
<div class="sect2">
<h3 id="_get_data">GET DATA</h3>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1   </th>
<th class="tableblock halign-left valign-top" > P2  </th>
<th class="tableblock halign-left valign-top" > P3/Le</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xCA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x01</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>(CASE 2S)</p></div>
<div class="ulist"><ul>
<li>
<p>
P2 = data selector
</p>
</li>
<li>
<p>
P3 = how many data is requested from card (Le)
</p>
</li>
</ul></div>
<div class="paragraph"><p>P2 for global functions:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>0xA0  Get applet information
0xA1  Get file list in current DF
0xA2  Get file list in current DF - list only transparent EF
0xA3  Get file list in current DF - list only DF
0xA4  Get file list in current DF - list only EF with RSA keys
0xA5  Get file list in current DF - list only EF with ECC keys
0xA6  Get file list in current DF - list only EF with DES/AES keys
0xAA  Get card capabilities
0xAC  Get access condition table</pre>
</div></div>
<div class="paragraph"><p>All <strong>get file list</strong> operations are limited to list maximum 128 files.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">MyEId 4.0.1 does not use <strong>Le</strong> here, for example "Get card capabilities"
returns always 11 bytes even if <strong>Le</strong> is set to 10,11,12, 0 or 255.
OsEID uses <strong>Le</strong>, if <strong>Le &lt; number of available bytes</strong>, 0x6cXX status is
returned.</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="_applet_informations">Applet informations</h4>
<div class="paragraph"><p>New firmware uses version 4.5.1, old (up to version 20190102) 4.2.16.</p></div>
<table class="tableblock frame-all grid-all"
style="
width:100%;
">
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">version major</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">version minor</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">revision</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">serial number</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Counter</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">"OsEID"</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x0x4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x05</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x01</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">10 bytes</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x0000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">"OsEID"</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x0x4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x02</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x10</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">10 bytes</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x0000</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Warning!  OsEID versioning does not corresponds to values in this table.
MyEID driver in OpenSC uses version major/minor to determine capabilities of
card, and OsEID card sets these values to correspond to the functions in
this driver.</p></div>
<div class="paragraph"><p>Counter bytes are used in MyEID to count write updates into applet. OsEID
always set this counter to 0</p></div>
</div>
<div class="sect3">
<h4 id="_applet_capabilities_informations">Applet capabilities informations</h4>
<table class="tableblock frame-all grid-all"
style="
width:100%;
">
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Version</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CAPS</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">RSA length</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">DES length</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">AES length</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">ECC length</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x01</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2 bytes</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2 bytes</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2 bytes</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2 bytes</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2 bytes</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>OsEID defaults:</p></div>
<div class="paragraph"><p>CAPS:
bit 0: RSA support      YES
bit 1: DES support      YES
bit 2: AES support      YES
bit 3: ECC support      YES
bit 4: Grid PIN support NO
bit 5: PIV Emulation    NO</p></div>
<div class="paragraph"><p>RSA length 2048
DES length  192
AES length  256
ECC length  384 or 521 (depends on device version)</p></div>
</div>
<div class="sect3">
<h4 id="_access_condition_table">Access condition table</h4>
<div class="paragraph"><p>Bits in this table (16 bits) represents AC status:
bits 0..14 - which PIN is active (by VERIFY operation)
bit 14 is set if global unblocker status is activated
bit 15 is set if admin stale is activated</p></div>
<div class="paragraph"><p>P2 for key file GET DATA:
(Key file must be selected before GET DATA command)</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>0x00  Get algorithm identifier
0x01  Get modulus
0x02  Get public exponent
0x81  Get ECC curve parameter prime
0x82  Get ECC curve parameter A
0x83  Get ECC curve parameter B
0x84  Get ECC Generator point (X and Y)
0x85  Get ECC curve parameter Order
0x86  Get ECC public key (uncompressed)</pre>
</div></div>
<div class="paragraph"><p>GET DATA  PIN information:</p></div>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1  </th>
<th class="tableblock halign-left valign-top" > P2    </th>
<th class="tableblock halign-left valign-top" > P3/Le</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xCA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x01</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xBX</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>(CASE 2S)</p></div>
<div class="ulist"><ul>
<li>
<p>
X in range 1..E
</p>
</li>
</ul></div>
<div class="paragraph"><p>This function returns PIN parameters as 9 bytes structure:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>PIN retries - actual state
PUK retries - actual state
PIN max retries - initial state
PUK max retries - initial state
FLAGS
PIN type (for now always 0, normal PIN)
Grid size (for GRID PIN, not implemented for now)
PIN minimal length
PUK minimal length</pre>
</div></div>
<div style="page-break-after:always"></div>
</div>
</div>
<div class="sect2">
<h3 id="_put_data">PUT DATA</h3>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1 </th>
<th class="tableblock halign-left valign-top" > P2  </th>
<th class="tableblock halign-left valign-top" > P3/Lc </th>
<th class="tableblock halign-left valign-top" > Data </th>
<th class="tableblock halign-left valign-top" > Le</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xDA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">..</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">empty</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>(CASE 3S)</p></div>
<div class="sect3">
<h4 id="_initialize_applet">INITIALIZE APPLET</h4>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CLA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">INS</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Lc</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Data</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Le</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xDA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">01</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">E0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">empty</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xDA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">01</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">E0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">08</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">XX XX ACL0 ACL1 ACL2 ACL3 ACL4 ACL5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">empty</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xDA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">01</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">E0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">05</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">XX XX ACL0 ACL1 ACL2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">empty</p></td>
</tr>
</tbody>
</table>
<div class="ulist"><ul>
<li>
<p>
LE empty
</p>
</li>
<li>
<p>
data lenght must correspond to Lc value.
</p>
</li>
<li>
<p>
XX XX in data field are ignored by OsEID card.
</p>
</li>
</ul></div>
<div class="paragraph"><p>This function can be used to erase card and return card into creation state
(Lifecycle = 1).  All PINs are erased, filesystem is erased.  Then MF and DF
5015 is recreated.  For Lc&lt;5 MF and DF 5015 is created, default ACL are used
for this files: MF [11 3F FF], DF 5015 [11 1F FF]</p></div>
<div class="paragraph"><p>If ACL0, ACL1, ACL2, are present in data (Lc &gt;=5), MF access conditions are
set to values specified by ACL0, ACL1, ACL2.</p></div>
<div class="paragraph"><p>If ACL4, ACL5, ACL6, are present in data (Lc &gt;=8), DF 5015 access conditions are
set to values specified by ACL4, ACL5, ACL6.</p></div>
<div class="paragraph"><p>If APDU provide only ACL0, ACL1, ACL2 and ACL4, ACL5, ACL6 bytes are not
available (Lc in rande 5..7), DF 5015 is not created.</p></div>
<div class="paragraph"><p>If Lc&gt; 8, unspecified data bytes will be ignored.</p></div>
<div class="paragraph"><p>If card is already in creation state, no access condition is checked, card
is erased.  If card is in activated state, access condition is checked first
(MF recreation access condition).</p></div>
</div>
<div class="sect3">
<h4 id="_initialize_pin">INITIALIZE PIN</h4>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CLA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">INS</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P3/Lc</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Data</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Le</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xDA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">01</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">ID</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">empty</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>(CASE 3S)</p></div>
<div class="ulist"><ul>
<li>
<p>
Le empty
</p>
</li>
<li>
<p>
ID PIN ID 1 .. 14
</p>
</li>
</ul></div>
<div class="paragraph"><p>This function is available only in card creation state (Lifecycle = 1). No
access conditions are checked in this state, PIN 1 to 14 can be
initialized. If PIN is already initialized, new initialization overwrites
old PIN data.</p></div>
<div class="paragraph"><p>If card is in activated state (Lifecycle = 7), this function returns SW1,2 = 0x6982
(security status not satisfied).</p></div>
</div>
<div class="sect3">
<h4 id="_key_load_operations">Key load operations</h4>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:6%;">
<col style="width:6%;">
<col style="width:6%;">
<col style="width:18%;">
<col style="width:6%;">
<col style="width:50%;">
<col style="width:6%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CLA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">INS</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P3/Lc</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Data</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Le</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xDA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">01</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Key Part ID</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">empty</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>(CASE 3S)</p></div>
<div class="ulist"><ul>
<li>
<p>
Le empty
</p>
</li>
<li>
<p>
Part = key part identification
</p>
</li>
<li>
<p>
Lc corresponding to data field length
</p>
</li>
</ul></div>
<div class="paragraph"><p>Key part identification numbers:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre> 80  modulus P*Q - (for keys &lt; 2048)
 80  modulus 2048 bit key, APDU chaining is used to transport 256 bytes
 81  public exponent (65537 or 3)
 82  private exponent (not CRT, for keys &lt; 2048)
 83  prime P
 84  prime Q
 85  d mod (p-1)
 86  d mod (q-1)/EC publickey
 87  q-1 mod p/EC private key
 88  modulus (1st part for 2048 key)
 89  modulus (2nd part for 2048 key)
 8A  private exponent (not CRT, 1st part for 2048 key)
 8B  private exponent (not CRT, 2nd part for 2048 key)
 A0  symmetric key (DES/3DES/AES128/AES192/AES256)</pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content"><a href="#CRT">[CRT]</a> here is Chinese remainder theorem</td>
</tr></table>
</div>
<div class="paragraph"><p>Key file length in bytes must match key size in bits (for any type of keys,
symmetric/ECC or RSA).</p></div>
<div class="paragraph"><p>Before Key load operation, key file must be selected.</p></div>
<div class="paragraph"><p>OsEID internally uses SIMPLE TLV to represent key parts.  Tag <strong>T</strong> is coded
as one 8 bit value, value 0xff is not allowed.  Because ISO7816 does not
allow value 0x00 here, there is recommended to not use key part with tag
0x00.  Length <strong>L</strong> represents number of bytes in field <strong>V</strong>.  <strong>L</strong> is coded as 8
bit value in range 1..254.  There is one byte at end of last component
(padding, 0xff).</p></div>
<div class="paragraph"><p>OsEID allows to create key file of arbitrary size, but key upload fail if file
size does not correspond to allowed key sizes for selected cipher.</p></div>
<div class="paragraph"><p>Only proprietary EF files can be used to hold key data. Please use
the <em>File description byte</em> values as described in the CREATE FILE
command.</p></div>
<div class="paragraph"><p>For DES,  allowed size are: 56 or 64 bytes = standard DES, 128 bytes 2DES
(EDE mode), 256 bytes for 3DES (EDE mode).</p></div>
<div class="paragraph"><p>For AES,  allowed sizes are: 128, 192, or 256 bytes.</p></div>
<div class="paragraph"><p>For ECC keys, only private key must be uploaded, public key is not needed.
File type is 0x22.  Allowed key sizes: 192, 256, 384 or 521 bits.  For
secp256k1 curve file type must be set to 0x23 and only 256 bit key is
allowed.  Byte size of uploaded parts must match key size i.e.  48 bytes for
384 bit private key, 66 bytes for 521 bit private key.  Public key start
with byte 04 - uncompressed indicator and consist of two coordinates witch
same length as private key i.e public key for 256 bit EC is loaded into card
as structure of 65 bytes.</p></div>
<div class="paragraph"><p>For RSA keys, card uses only CRT algo, if some of CRT component is not
available, RSA operation fails.  You need to upload at least: <strong>prime P</strong>,
<strong>prime Q</strong>, <strong>d<sup>-1</sup> mod (p-1)</strong>, <strong>d<sup>-1</sup> mod (q-1)</strong>, <strong>q<sup>-1</sup> mod P</strong>.</p></div>
<div class="paragraph"><p>For now, public exponent is not needed by OsEID card, card internaly uses
hardcoded public exponent 65537. Future version of OsEID card may need this
part too (for message blinding and Belcore attack protection), therefore,
it is recommended to upload <strong>public exponent</strong>.</p></div>
<div class="paragraph"><p>Card allows upload modulus, but internaly this operation does nothing. If
card is asked for modulus (GET DATA), modulus is calculated from P and Q.</p></div>
<div class="paragraph"><p>2048 bit modulus is uploaded in two parts, order of part upload  does not
matter (MyEID need first upload 1st part, the second). There is alternative
upload method for 2048 bit modulus, APDU chaining can be used to put whole
modulus in one operation.</p></div>
<div class="paragraph"><p>Card allows to upload <strong>private exponent</strong>, but this operation does nothing.</p></div>
<div class="paragraph"><p>Upload operation does not check size/value of modulus and private exponent.</p></div>
<div class="paragraph"><p>Components with ID 0xA3/0xB3 and 0xA4/0xB4 are not standard CRT components.
Precalculating of these values allows us to speed up RSA calculation. Card
automatically calculates these values from P and Q components, user is not
allowed to upload these components.  This functionality is optional, can be
turned off at compilation time.</p></div>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:33%;">
<col style="width:11%;">
<col style="width:11%;">
<col style="width:11%;">
<col style="width:11%;">
<col style="width:11%;">
<col style="width:11%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >                       </th>
<th class="tableblock halign-left valign-top" >Key part ID</th>
<th class="tableblock halign-left valign-top" > 512  </th>
<th class="tableblock halign-left valign-top" > 768  </th>
<th class="tableblock halign-left valign-top" > 1024  </th>
<th class="tableblock halign-left valign-top" > 1536  </th>
<th class="tableblock halign-left valign-top" >  2048</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">modulus P*Q</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">80</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">public exp d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">81</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">priv. exp</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">82</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">83</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+32</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+48</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+64</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+96</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+128</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Q</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">84</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+32</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+24</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+32</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+48</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+128</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P<sup>-1</sup> mod 2<sup>0.5n+1</sup></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">A3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+16</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+24</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+32</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+48</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Q<sup>-1</sup> mod 2<sup>0.5n+1</sup></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">A4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+16</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+48</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+64</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+96</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2<sup>1.5n+1</sup> mod P</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">B3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+32</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+48</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+64</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+96</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+128</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2<sup>1.5m+1</sup> mod Q</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">B4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+32</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+48</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+64</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+96</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+128</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">d<sup>-1</sup> mod (Q-1)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">85</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+32</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+48</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+64</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+96</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+128</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">d<sup>-1</sup> mod (P-1)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">86</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+32</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+48</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+64</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+96</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+128</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Q<sup>-1</sup> mod P</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">87</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+32</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+48</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+64</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+96</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+128</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">mod2048 part1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">88</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">mod2048 part2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">89</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">exp2048 part1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">8A</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">exp2048 part2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">8B</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">File size</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">512</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">768</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1024</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1536</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2048</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>MyEID allows to upload <strong>private exponent</strong>, but thes components may
overwrite some of CRT components. Please consult MyEID reference manual.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_generate_public_key_pair">GENERATE PUBLIC KEY PAIR</h3>
<div class="paragraph"><p>This command generates RSA/ECC keys.  This command operates on current
selected file.  Key type and size is determined from selected file.  If file
type/size does not match allowed key length for cipher, operation fails.</p></div>
<div class="paragraph"><p>RSA key generation APDU:</p></div>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1 </th>
<th class="tableblock halign-left valign-top" > P2 </th>
<th class="tableblock halign-left valign-top" > P3/Lc </th>
<th class="tableblock halign-left valign-top" > Data                               </th>
<th class="tableblock halign-left valign-top" > Le</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x46</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x46</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">07</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x30 0x05 0x02 0x03 0x01 0x00 0x01</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x46</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">07</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x30 0x05 0x81 0x03 0x01 0x00 0x01</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>(CASE 4S)</p></div>
<div class="paragraph"><p>P1,P2=0, this indicate proprietary format of data field (ISO7816-8).</p></div>
<div class="paragraph"><p>RSA key for now uses fixed public exponent 65537.  For RSA key, user can set
Lc to 0 or set Lc and data field with this public exponent:</p></div>
<div class="paragraph"><p>All three formats are identical. First format  does not define public
exponent, the card then uses default public exponent. If Lc is not 0, data
field contain ASN1 formated data for public exponent. Only value 65537 is
accepted.</p></div>
<div class="paragraph"><p>Data field is ASN1 formated, 0x30 is SEQUENCE indicator, and value 0x02 or
0x81 is used as "public exponent" tag.  (ASN.1 uses 0x02 as tag for INTEGER,
MyEID 2.1.4 manual defines here tag 0x02 too. Opensc 0.17 send
0x81 here, OsEID for now allows both values).</p></div>
<div class="paragraph"><p>If key is successfully generated, key file is filled with key data and card
returns public modulus.</p></div>
<div class="paragraph"><p>ECC key generation APDU:</p></div>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CLA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">INS</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P3/Lc</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Data</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Le</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x46</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>(CASE 4S)</p></div>
<div class="ulist"><ul>
<li>
<p>
P1,P2=0, this indicate proprietary format of data field (ISO7816-8).
</p>
</li>
<li>
<p>
P3 = 0
</p>
</li>
<li>
<p>
Lc = empty
</p>
</li>
<li>
<p>
Data empty
</p>
</li>
<li>
<p>
LE 3 + [key size in bites] * 2 / 8
</p>
</li>
</ul></div>
<div class="paragraph"><p>This APDU is same as specified in MyEID reference manual 2.1.4. As you can
see, there is no information about key size or OID of cipher. Only one way to
detect number of key bits exists -  key file size. If you need to generate ECC
key on card, key file size in bytes must match key length in bits.</p></div>
<div class="paragraph"><p>APDU returns public key in format:
0x86 - TAG
0xXX - LEN (or 0x81, LEN for 521 bit key)
0x04 - uncompressed indicator
0xXX .. 0xXX - X coordinate of public key
0xXX .. 0xXX - Y coordinate of public key</p></div>
<div class="paragraph"><p>It is surprising that MyEID does not use for example OID of curve in the
DATA section to specify the key absolutely precisely. OsEID may in future use
proprietary APDU thats allows to specify OID of curve in data field, but if
<strong>OpenSC</strong> does not support this information, this feature is for now not
interesting.</p></div>
</div>
<div class="sect2">
<h3 id="_card_security_mechanism_functions">Card security mechanism functions</h3>
<div class="paragraph"><p>Files and directories on card are protected by access flags. If file
operation is protected by access flag, access flag can deny or allow
operation on file.</p></div>
<div class="paragraph"><p>PIN create is allowed only before using ACTIVATE APPLET command.</p></div>
<div class="sect3">
<h4 id="_verify">VERIFY</h4>
<div class="paragraph"><p>Verify command is used to authenticate user/application to card.
Command allows to send verification data (e.g password/PIN) to card.
The verification data is compared to reference data stored in card.
The card security status is modified according to this comparison.</p></div>
<div class="paragraph"><p>Card supports maximal 14 security access conditions.</p></div>
<div class="paragraph"><p>A successful comparison enables use of card function controlled by security
access condition, which number is in P2 parameter of APDU.  Counter
of unsuccessful verify attempts is then cleared.</p></div>
<div class="paragraph"><p>For unsuccessful comparison, counter of unsuccessful verify attempts is
incremented and if this counter is over predefined value, PIN
is blocked. PIN can be unblocked by PUK.</p></div>
<div class="paragraph"><p>PIN can be optionally marked as LOCKED, verification to locked PIN always fails.
For more about PIN LOCK feature check CHANGE REFERENCE DATA command.</p></div>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1   </th>
<th class="tableblock halign-left valign-top" > P2  </th>
<th class="tableblock halign-left valign-top" > P3/Lc  </th>
<th class="tableblock halign-left valign-top" > Data </th>
<th class="tableblock halign-left valign-top" > LE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x20</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">empty</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>(CASE 3S)</p></div>
<div class="ulist"><ul>
<li>
<p>
P2 must specify PIN number
</p>
</li>
<li>
<p>
Lc 0 to 255
</p>
</li>
<li>
<p>
Data - length corresponding to Lc
</p>
</li>
<li>
<p>
LE empty
</p>
</li>
</ul></div>
<div class="paragraph"><p>If Lc is 0, this command returns how many authorization retries are left for
PIN specified by parameter P2 in APDU.</p></div>
<div class="paragraph"><p>If Lc != 0, data in APDU are used as verification data. Normally exact 8
bytes are present in APDU Data section and Lc is set to 8.  PIN in Data
section of APDU is padded by 0xff or 0x00.  If APDU present more data, rest
of data is ignored.  If APDU presents data below 8 bytes, data are internally
padded with 0xff.</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Responses
</dt>
<dt class="hdlist1">
<strong>if P1 != 0</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6a86 - Incorrect parameters P1-P2
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if P2 &lt;1 or &gt;14</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6a86 - Incorrect parameters P1-P2
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if Lc = 0</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6983 - PIN fail, no more auth retries, PIN is blocked
</p>
</li>
<li>
<p>
0x6985 - PIN is locked
</p>
</li>
<li>
<p>
0x63cX - X present number of retries left
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if Lc != 0</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6983 - PIN fail, no more auth retries, PIN is blocked
</p>
</li>
<li>
<p>
0x6985 - PIN is locked
</p>
</li>
<li>
<p>
0x63cX - PIN fail, X present number of retries left
</p>
</li>
<li>
<p>
0x9000 - PIN ok, access is enabled for all functions controlled by pin P2
</p>
</li>
</ul></div>
</dd>
</dl></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">MyEID - from reference manual Ver 1.7.7,  APDU need exact 0 or 8 bytes
in data (Lc = 0 or 8).
NOTE: response codes are organized in same order as tests in code</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_activate_applet">ACTIVATE APPLET</h3>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1 </th>
<th class="tableblock halign-left valign-top" > P2  </th>
<th class="tableblock halign-left valign-top" > P3/Lc  </th>
<th class="tableblock halign-left valign-top" > Data </th>
<th class="tableblock halign-left valign-top" > Le</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x44</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">empty</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>(CASE 3S)</p></div>
<div class="ulist"><ul>
<li>
<p>
P1, P2, Lc, Data, - arbitrary data are accepted
</p>
</li>
</ul></div>
<div class="paragraph"><p>This command activates card security mechanism of card, all access conditions
become active.</p></div>
<div class="paragraph"><p>Difference to MyEID: MyEID needs applet <a href="#AID">[AID]</a> in Data field, P1 must be set to
4 and P2 to 0.  Applet AID must be set to A000000063504B43532D3135.  MyEID
card allow activation only if PIN corresponding to MF recreation access
condition is already initialized, otherwise card return SW1,2 = 0x6985
(Conditions not satisfied).  OsEID always allow activation.  If PIN that
allow recreation of MF is not initialized, there is no possibility to erase
the activated card (only way for reuse activated card is reprogramming card
CPU).</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cryptographic_functions">Cryptographic functions</h2>
<div class="sectionbody">
<div class="paragraph"><p>Card supports several cryptographic functions. Symmetric cryptographic
functions are available and asymmetric cryptography is available.</p></div>
<div class="paragraph"><p>Support for symmetric cryptography is experimental for now, because it is based
only on MyEID 2.1.4 reference manual.  Internally OsEID support AES
encrypt/decrypt with standard block size 16 bytes, and key sizes 128/192/256
bits in ECB mode.  DES encrypt/decrypt in ECB is supported with standard
block size 8 bytes, and standard key size 64 bits (56 bits + parity bits,
but all parity bits are ignored).  Support for 3DES encrypt/decrypt is for
192 bit key size, all three keys independent (3TDEA).  Only EDE keying is
supported, no EEE.  This allow run 2 DES too, if 3rd key is copy of 1st key
(2TDEA).  Maximal key size is then 192 bits, but real security of this cipher
is about 112 bits.</p></div>
<div class="paragraph"><p>Block chaining is not available for now, but it seems that MyEID uses CBC
mode, and in future this mode is planed as default.  OsEID for now uses only
ECB mode for AES and DES.  Data size for DES operation is then limited for
only 8 bytes block per operation (APDU) and one 16 bytes block AES operation.</p></div>
<div class="paragraph"><p>Asymmetric cryptography supports RSA with key sizes 512 to 2048 bits
(512,768,1024,1536,2048).  There is support for private operation only.
This allows to use RSA for decipher and for sign operation.  Elliptic curve
cryptography support is available for small set of curves: prime192v1,
prime256v1, secp384r1, secp256k1.  ECDH and ECDSA are supported.</p></div>
<div class="paragraph"><p>The following procedure is recommended for the execution of a security
operation:</p></div>
<div class="ulist"><ul>
<li>
<p>
use SELECT FILE operation to specify file with key/private key
</p>
</li>
<li>
<p>
use VERIFY command to get access condition for key file
</p>
</li>
<li>
<p>
use MANAGE SECURITY ENVIRONMENT command to set parameters of security
</p>
</li>
<li>
<p>
use PERFORM SECURITY OPERATION or GENERAL AUTHENTICATE to perform
  requested operation
</p>
</li>
</ul></div>
<div class="sect2">
<h3 id="_manage_security_environment">MANAGE SECURITY ENVIRONMENT</h3>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1 </th>
<th class="tableblock halign-left valign-top" > P2  </th>
<th class="tableblock halign-left valign-top" > P3/Lc  </th>
<th class="tableblock halign-left valign-top" > Data </th>
<th class="tableblock halign-left valign-top" > Le</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x22</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">empty</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>(CASE 3S)</p></div>
<div class="paragraph"><p>P1 structure:
  X1h - set security environment
  X2h - store security environment
  X3h - restore security environment
  X4h - erase security environment</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>1Xh - Secure Messaging (command)
2Xh - Secure Messaging (response)
4Xh - Computation, decipherment, internal authentication and key agreement
8Xh - Verification, encipherment, external authentication and key agreement</pre>
</div></div>
<div class="paragraph"><p>Any other value RFU (ISO7816-4, Table 78)</p></div>
<div class="paragraph"><p>P2 value is used to determine <strong>Control Reference Template</strong> in data field.</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>0xA4 = Authentication Template (AT)
0xA6 = Key Agreement Template (KAT)
0xAA = Hash-code Template (HT)
0xB4 = Cryptographic Checksum Template (CCT)
0xB6 = Digital Signature Template (DST)
0xB8 = Confidentiality Template (CT)</pre>
</div></div>
<div class="paragraph"><p>Any other value RFU (ISO7816-4, Table 79)</p></div>
<div class="paragraph"><p>OsEID allow only limited set of P1/P2 values:</p></div>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:33%;">
<col style="width:33%;">
<col style="width:33%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >   P1  </th>
<th class="tableblock halign-left valign-top" >  P2  </th>
<th class="tableblock halign-left valign-top" > operation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xF3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">restore empty security environment</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x41</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xA4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">set SE for ECDH operation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x41</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xB6</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">set SE for digital signature</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x41</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xB8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">set SE for decipher operation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x81</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xB8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">set SE for encipher operation</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>If P2 != 0 there is Lc != 0, LE = 0 and corresponding template must be
filled in data field.</p></div>
<div class="paragraph"><p>Data field represents concatenated Tag Len Value objects.</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>TAG 80h Algorithm reference,
LEN 1 Value: XXh

Value specification:

X0h - RAW RSA signature/decipher
X1h - RSA signature, IEC9796-2  randomized  with hash (below hash specifications)
X2h - pad data to match modulus (PKCS#1 padding)
X4h - ECDSA/ECDH

0Xh - no hash algo
1Xh - SHA1
2Xh - RIPEMD-160
3Xh - SHA-2 224 bit
4Xh - SHA-2 256 bit
5Xh - SHA-2 384 bit
6Xh - SHA-2 512 bit
80h - PKCS#7 padding</pre>
</div></div>
<div class="paragraph"><p>OsEID supports only small set of algorihm reference</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>00h - Raw operation - data length must match key modulus length

02h - for decipher: remove padding from data
02h - for signatures: concatenate PKCS#1 padding || signature data
      (do not use data over 60% of key size, minimal padding is 11 bytes)
12h - for decipher: same as raw operation
12h - for signatures: concatenate padding || SHA1 OID || signature data
      (here always 20 bytes of signature data is allowed)

04h - ECDSA, ECDH operation</pre>
</div></div>
<div class="paragraph"><p>For LEN = 10, OID of cryptograhics mechanism in data field (not supported in
OsEID)</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>TAG 81h, File reference
LEN 2 Value: XXXXh file ID</pre>
</div></div>
<div class="paragraph"><p>ID is used to select the file which contains the key for the next security
operation.  This file is selected by same way as SELECT operation with
P1 = 2 (DF can not be selected here).  If file is not selectable, operation
return <em>Conditions not satisfied</em> return code (0x6985).  This operation does
not affect current selected file selected by previous SELECT command.</p></div>
<div class="paragraph"><p>Any other length is not supported by OsEID (More about referencing in ISO7816-4,
5.3.1.2)</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>TAG 0x82  DF id/name - is not used in OsEID (More about referencing DF in
ISO7816-4, 5.3.1.1)</pre>
</div></div>
<div class="literalblock">
<div class="content monospaced">
<pre>TAG 83h or 84h, LEN 1</pre>
</div></div>
<div class="paragraph"><p>Tag 83h is for key file with symmetric key, 84h for file with asymmetric key.
Not used, must not be present. Reference for key in keyfile.
If present, only value 0 is correct.</p></div>
<div class="paragraph"><p>TAG 83h or 84, LEN 2
Tag 83h is used here for ID of target file for UNWRAP operation. File is
searched in same way as for tag 0x81.</p></div>
<div class="paragraph"><p>From ISO 7816-4 terminology for 0x83/0x84 tag:
0x83: reference for a secret key (direct use), or reference of a public key
or qualifier of reference data
0x84: reference for computing a session key or reference of a private key</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>TAG 0x85 and 0x86 is not used</pre>
</div></div>
<div class="literalblock">
<div class="content monospaced">
<pre>TAG 87h</pre>
</div></div>
<div class="paragraph"><p>Set initialization vector.  Must not be present.  If not present, then
initialization vector is undefined. Length from 1 to 16 bytes.</p></div>
<div class="paragraph"><p>In future, for length = 0, previous IV +1 is to be used. Beware, OsEID
functions with symmetric keys is still experimental.</p></div>
<div class="paragraph"><p>Minimal template must have tag 0x80 and tag 0x81.</p></div>
</div>
<div class="sect2">
<h3 id="_perform_security_operation">PERFORM SECURITY OPERATION</h3>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1 </th>
<th class="tableblock halign-left valign-top" > P2  </th>
<th class="tableblock halign-left valign-top" > Lc  </th>
<th class="tableblock halign-left valign-top" > Data </th>
<th class="tableblock halign-left valign-top" > LE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x2A</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>(CASE 4S)</p></div>
<div class="paragraph"><p>Before security operation correct security environment must be set.
Access condition must allow use of selected key file.</p></div>
<div class="paragraph"><p>Command uses key file defined by SET SECURITY ENVIRONMENT command. Actualy
selected file by SELECT command is not affected by this operation.</p></div>
<div class="paragraph"><p>More types of security operations exists:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Compute digital signature (ECC/RSA)
  (In case of RSA, use data field length max 40% of modulus length)
</p>
<div class="ulist"><ul>
<li>
<p>
CLA = 00h or 80h
</p>
</li>
<li>
<p>
P1 = 9Eh perform digital signature
</p>
</li>
<li>
<p>
P2 = 9Ah data to be signed in data field (plain data)
</p>
</li>
<li>
<p>
Lc = length of data
</p>
</li>
</ul></div>
</li>
</ol></div>
<div class="paragraph"><p>MyEID as described in reference manual 2.1.4 does not support RSA 2048 raw
sign operation, but this operation is identical to raw decipher operation.
Please use <strong>OpenSC</strong> version from <strong>git</strong>, there is already fix that allows raw
2048 bit signature.
<a href="https://github.com/OpenSC/OpenSC/commit/deab9cce73377f973d2020ab5ab7adc302018bf6">https://github.com/OpenSC/OpenSC/commit/deab9cce73377f973d2020ab5ab7adc302018bf6</a>
Opensc 0.18.0 already contain this patch.</p></div>
<div class="paragraph"><p>APDU chaining is available in OsEID card, for 2048 raw signature this
transport is preferred.  (MyEID from version 4.5.X allow use of APDU
chaining too).</p></div>
<div class="paragraph"><p>+
Alternatives not supported by OsEID:</p></div>
<div class="ulist"><ul>
<li>
<p>
P2 = ACh BER-TLV data (only value field is to be signed) in data field
</p>
</li>
<li>
<p>
P2 = BCh BER-TLV to be signed in data field
</p>
</li>
<li>
<p>
Lc = 0 data already present in card
</p>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Encipher plaintext (DES/3DES/AES128/AES192/AES256)
</p>
</li>
</ol></div>
</li>
<li>
<p>
CLA = 80h
</p>
</li>
<li>
<p>
P1 = 84h - return encrypted data
</p>
</li>
<li>
<p>
P2 = 80h - plaintext in data field
</p>
</li>
<li>
<p>
P2 = 00h - data field absent, use data from file (wrap)
</p>
</li>
<li>
<p>
Lc = length of plaintext
</p>
</li>
</ul></div>
<div class="paragraph"><p>+
Alternatives not supported by OsEID:</p></div>
<div class="ulist"><ul>
<li>
<p>
P1 = 82h return encrypted SM object
</p>
</li>
<li>
<p>
P1 = 86h return encrypted data (this depend on padding indicator)
</p>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Decipher ciphertext (RSA/DES/3DES/AES128/AES192/AES256)
</p>
</li>
</ol></div>
</li>
<li>
<p>
CLA = 00h or 80h
</p>
</li>
<li>
<p>
P1 = 0 - no data is to be returned, result of operation is in file
            specified in security environment (tag 0x84) - used in UNWRAP operation
</p>
</li>
<li>
<p>
P1 = 80h - return plain value
</p>
</li>
<li>
<p>
P2 = 84h - data field contain ciphertext (Experimental)
</p>
</li>
<li>
<p>
P2 = 86h - data field contain padding indicator, then partial or full ciphertext
</p>
</li>
<li>
<p>
Lc = length of ciphertext/ciphertext part + length of padding indicator if used
</p>
</li>
</ul></div>
<div class="paragraph"><p>APDU chaining is available in OsEID card, for 2048 decipher operation  this
transport is preferred.  (MyEID from version 4.5.X allow use of APDU
chaining too).</p></div>
<div class="paragraph"><p>+
Alternatives not supported by OsEID:</p></div>
<div class="ulist"><ul>
<li>
<p>
P2 = 82h encrypted SM objects in data field
</p>
</li>
</ul></div>
<div class="paragraph"><p>Rest of commands are not supported by OsEID:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Compute Cryptographic Checksum
</p>
<div class="ulist"><ul>
<li>
<p>
P1 = 0x8E
</p>
</li>
<li>
<p>
P2 = 0x80
</p>
</li>
</ul></div>
</li>
<li>
<p>
Verify Cryptographic Checksum
</p>
<div class="ulist"><ul>
<li>
<p>
P1 = 0    - do no treturn any data
</p>
</li>
<li>
<p>
P2 = 0xA2
</p>
</li>
</ul></div>
<div class="literalblock">
<div class="content monospaced">
<pre>Return codes are 0x9000, 0x6987 - checksum fail, 0x6988 - SM object(s) incorrect</pre>
</div></div>
</li>
<li>
<p>
Verify Digital Signature
</p>
<div class="ulist"><ul>
<li>
<p>
P1 = 0  - do not return any data (SW1,2 is used to test if signature is valid)
</p>
</li>
<li>
<p>
P2 = 0xA8
</p>
</li>
</ul></div>
</li>
<li>
<p>
Verify certificate
</p>
<div class="ulist"><ul>
<li>
<p>
P1 - 0x00  do not return any data (SW1,2 is used to test if cert is valid)
</p>
</li>
<li>
<p>
P2 - 0x92
</p>
</li>
<li>
<p>
P2 - 0xBE, or 0xAE self-descriptive/non-self descriptive certificate
</p>
</li>
<li>
<p>
data      Certificate in the data field, signed signature input consists of non
              BER-TLV-coded data: the certificate content is a concatenation of
              <a href="#DE">[DE]</a>s)
</p>
</li>
</ul></div>
</li>
<li>
<p>
Hash
</p>
<div class="ulist"><ul>
<li>
<p>
P1 = 0x90
</p>
</li>
<li>
<p>
P2 = 0x80 or 0xa0
</p>
</li>
</ul></div>
</li>
</ol></div>
<div class="sect3">
<h4 id="_padding_methods">Padding methods</h4>
<div class="paragraph"><p>If P2 = 0x86, 1st byte of ciphertext is padding byte. Allowed padding bytes:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>00h = rest of data field is ciphertext (no futher indication)
02h = rest of data field is ciphertext (No padding) (Not supported by OsEID)
81h = rest of data field is 1st part of ciphertext (MyEID/OsEID proprietary)
82h = rest of data field is last part of ciphertext (MyEID/OsEID proprietary)</pre>
</div></div>
<div class="paragraph"><p>If padding indicator is set to 0, rest of data is handled as ciphertext.
APDU chaining is allowed to allow transport up to 256 bytes of data.</p></div>
<div class="paragraph"><p>If paddig indicator set to 0x81, card saves 1st part of ciphertext in
temporary buffer.  Status 0x9000 is returned.  In all other cases the card
returns result of security operation and status bytes.  If APDU with padding
indicator 0x82 is received, new data are concatenated with data from
privious APDU (with padding indicator 0x81) and card performs security
operation.  Maximum length of concatenated ciphertext is 256 bytes.  APDU
chaining is not allowed with this type of padding indicators.</p></div>
<div class="paragraph"><p>Warning, temporary buffer is overwritten by any command that returns data
(not only status bytes).</p></div>
<div class="paragraph"><p>MyEID manual 2.1.4 limits P2 = 0x84 (ISO7816-4 0x84: cryptogram plain value
encoded in BER-TLV, not SM data object) for AES/DES decipher.  For RSA
decipher P2 = 0x86 is requested.  OsEID allows both values for AES/DES/RSA
decipher.  OsEID allows arbitrary length of ciphertext parts for padding
indicators 81h and 82h.  MyEID manual 2.1.4 defines use of this padding
indicators for 2048 bit keys.</p></div>
<div class="paragraph"><p>WARNING!  OsEID support for DES and AES security operation is experimental.
If selected key file contain AES/DES key, security operation is allowed only
for CLA = 0x80.  Digital signature security operation is not supported if
AES/DES key is selected. Data size (Lc) must match block size of DES /AES
block.</p></div>
<div class="paragraph"><p>OsEID does not support templates for now, but for completeness:</p></div>
<div class="paragraph"><p>Templates:
0xA0 - Input template to calculate the hash code (template hashed)
0xA2 - Input template for checking a cryptographic checksum (template is integrated)
0xA8 - Digital signature verification input template (template signed)
0xAC - Input template for calculating the digital signature (the associated value fields are signed)
0xAE - Certificate Input Verification Template (associated value field certified)
0xBC - Input template for calculating a digital signature (template signed)
0xBE - Entry Template for Certificate Verification (Certified Template)</p></div>
<div class="paragraph"><p>Input data object</p></div>
<div class="paragraph"><p>0x80 Explicit meaning           All templates
0x8E Cryptographic checksum     0xA2,0xAE,0xBE
0x90 Hash                       All except 0xA2
0x92 Certificate                0xAE,0xBE
0x9C Public key                 0xA8,0xAE,0xBE
0x9E digital signature          0xA8,0xAE,0xBE</p></div>
<div class="paragraph"><p>ECDH security operation is handled by GENERAL AUTHENTICATE command.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_general_authenticate">GENERAL AUTHENTICATE</h3>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1 </th>
<th class="tableblock halign-left valign-top" > P2  </th>
<th class="tableblock halign-left valign-top" > Lc  </th>
<th class="tableblock halign-left valign-top" > Data </th>
<th class="tableblock halign-left valign-top" > LE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x86</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">..</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>(CASE 4S)</p></div>
<div class="paragraph"><p>This command is used to provide ECDH operation. Before calling this command,
correct security environment must be set and key file must be selected.</p></div>
<div class="paragraph"><p>Lc   - correspond to length of data field
Data - peer public key in format:  0x7c, Lc-2 0x85 Lc-4 0x04 point_data
Here: 0x7c is Dynamic Authentication Template tag
      0x85 public key in data field
      0x04 uncompressed key indicator</p></div>
<div class="paragraph"><p>In addition to tag 0x85 tag 0x80 (Witness tag) is allowed with an arbitrary
length.  This tag is ignored for now.</p></div>
<div class="paragraph"><p>Card returns shared secret derived from private key in selected file and
public key provided in APDU. Technically, this operation does a point
multiplication and X coordinate of calculated point is returned.</p></div>
<div class="paragraph"><p>For more info, please read <strong>OsEID-tool</strong> - ECDH operation.</p></div>
</div>
<div class="sect2">
<h3 id="_get_challenge">GET CHALLENGE</h3>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1 </th>
<th class="tableblock halign-left valign-top" > P2  </th>
<th class="tableblock halign-left valign-top" > P3/Le</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x84</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>(CASE 2S)</p></div>
<div class="paragraph"><p>Le - number of requested random data (1..255)</p></div>
<div class="paragraph"><p>Card return 1..255 bytes of random data.</p></div>
<div class="paragraph"><p>Please read appendix <strong>Random generator implementation</strong> about random number
generator.</p></div>
<div class="paragraph"><p>Return values:
- 0x9000 - All OK
- 0x6f00 - if number of requested bytes is zero.</p></div>
<div class="paragraph"><p>Note: In future here comes more P1/P2 values, thats allow us to
authenticate by challenge/response.  There is consideration about requested
number of random data bytes, for Le=0, 256 bytes of random data may be
returned.</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendixA">Appendix A: PCB ver 0.1</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="images/OsEID_pcb_ver0.1.svg" alt="PCB0.1">
</div>
</div>
<div style="page-break-after:always"></div>
</div>
</div>
<div class="sect1">
<h2 id="appendixB">Appendix B: Schematics ver 0.1</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="images/OsEID_sch_ver0.1.svg" alt="SCH0.1">
</div>
</div>
<div style="page-break-after:always"></div>
</div>
</div>
<div class="sect1">
<h2 id="appendixC">Appendix C: APDU summary</h2>
<div class="sectionbody">
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">All APDU numbers in hexadecimal format, APDU format for T0 protocol</td>
</tr></table>
</div>
<div class="sect2">
<h3 id="_class_0">CLASS 0</h3>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>ERASE BINARY</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 0E P1 P2 00 (P1 0-0x7f, P2 0-0xff)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>VERIFY</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 20 00 P2 00  (P2 in range 1 to 0x0e)
</p>
</li>
<li>
<p>
00 20 00 P2 Lc [data] (P2 in range 1 to 0x0e)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>MANAGE SECURITY ENVIRONMENT</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 22 F3 00 00        reset sec env
</p>
</li>
<li>
<p>
00 22 41 B6 Lc [data] perform digital signature
</p>
</li>
<li>
<p>
00 22 41 B8 Lc [data] perform decipher
</p>
</li>
<li>
<p>
00 22 81 B8 Lc [data] perform encipher
</p>
</li>
<li>
<p>
00 22 41 A4 Lc [data] perform ECDH operation
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>CHANGE REFERENCE DATA</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 24 00 P2 10 [data] (P2 in range 1 to 0x0e)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>PERFORM SECURITY OPERATION</strong> 
</dt>
<dd>
<p>
-00 2A 9E 9A Lc [data]
</p>
</dd>
<dt class="hdlist1">
<strong>RESET RETRY COUNTER</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 2C 00 P2 00  (P2 in range 1 to 0x0e)
</p>
</li>
<li>
<p>
00 2C 00 P2 10 [data] (P2 in range 1 to 0x0e)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>DEAUTHENTICATE</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 2E 00 P2 00  (P2 in range 0 to 0x0e)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>ACTIVATE APPLET</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 44 P1 P2 Lc [data](P1,P2,Lc, does not matter to values)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>GENERATE PUBLIC KEY PAIR</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 46 00 00 Lc
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>GET CHALLENGE</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 84 00 00 LE [data] (LE in range 1 - 255)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>GENERAL AUTHENTICATE</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 86 00 00 Lc [data]
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>SELECT FILE</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 A4 P1 P2 Lc [data]
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>READ BINARY</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 B0 P1 P2 LE (P1 0-0x7f, P2 0-0xff, LE 1..0xff)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>GET RESPONSE</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 C0 00 00 LE
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>GET DATA</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 CA 01 00 00 Get algorithm identifier
</p>
</li>
<li>
<p>
00 CA 01 01 00 Get modulus
</p>
</li>
<li>
<p>
00 CA 01 02 00 Get public exponent
</p>
</li>
<li>
<p>
00 CA 01 81 00 Get ECC curve parameter prime
</p>
</li>
<li>
<p>
00 CA 01 82 00 Get ECC curve parameter A
</p>
</li>
<li>
<p>
00 CA 01 83 00 Get ECC curve parameter B
</p>
</li>
<li>
<p>
00 CA 01 84 00 Get ECC Generator point (X and Y)
</p>
</li>
<li>
<p>
00 CA 01 85 00 Get ECC curve parameter Order
</p>
</li>
<li>
<p>
00 CA 01 86 00 Get ECC public key (uncompressed)
</p>
</li>
<li>
<p>
00 CA 01 A0 00 Get applet information
</p>
</li>
<li>
<p>
00 CA 01 A1 00 Get file list in current DF
</p>
</li>
<li>
<p>
00 CA 01 A2 00 Get file list in current DF - list only EF
</p>
</li>
<li>
<p>
00 CA 01 A3 00 Get file list in current DF - list only DF
</p>
</li>
<li>
<p>
00 CA 01 A4 00 Get file list in current DF - list only EF with RSA keys
</p>
</li>
<li>
<p>
00 CA 01 A5 00 Get file list in current DF - list only EF with ECC keys
</p>
</li>
<li>
<p>
00 CA 01 A6 00 Get file list in current DF - list only EF with DES/AES keys
</p>
</li>
<li>
<p>
00 CA 01 AA 00 Get card capabilities
</p>
</li>
<li>
<p>
00 CA 01 AC 00 Get access condition table
</p>
</li>
<li>
<p>
00 CA 01 BX 00 Get PIN parameters (X in range 1 - 0x0e)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>UPDATE BINARY</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 D6 P1 P2 Lc [data] (P1 0-0x7f, P2 0-0xff, Lc 1..0xff)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>PUT DATA/initialize pin</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 DA 01 P2 Lc [data] (P2 in range 1..14)
</p>
</li>
</ul></div>
</dd>
</dl></div>
<div class="paragraph"><p>*PUT DATA/INITIALISE PIV EMULATION
- 00 DA 01 50 14 [data] not supported by OsEID /planed in future release</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>PUT DATA/load key</strong> 
</dt>
<dd>
<p>
NOTE: only CRT algo is supported, loading modulus and private exponent does
nothing (return code 0x9000)
</p>
<div class="ulist"><ul>
<li>
<p>
00 DA 01 80 Lc [data] private modulus
</p>
</li>
<li>
<p>
00 DA 01 81 Lc [data] public exponent
</p>
</li>
<li>
<p>
00 DA 01 82 Lc [data] private exponent (not CRT)
</p>
</li>
<li>
<p>
00 DA 01 83 Lc [data] prime P
</p>
</li>
<li>
<p>
00 DA 01 84 Lc [data] prime Q
</p>
</li>
<li>
<p>
00 DA 01 85 Lc [data] d<sup>-1</sup> mod (p-1)
</p>
</li>
<li>
<p>
00 DA 01 86 Lc [data] d<sup>-1</sup> mod (q-1) /EC publickey
</p>
</li>
<li>
<p>
00 DA 01 87 Lc [data] q<sup>-1</sup> mod p /EC private key
</p>
</li>
<li>
<p>
00 DA 01 88 Lc [data] modulus (1st part for 2048 key)
</p>
</li>
<li>
<p>
00 DA 01 89 Lc [data] modulus (2nd part for 2048 key)
</p>
</li>
<li>
<p>
00 DA 01 8A Lc [data] private exponent 1st part for 2048 key (not CRT)
</p>
</li>
<li>
<p>
00 DA 01 8B Lc [data] private exponent 2nd part for 2048 key (not CRT)
</p>
</li>
<li>
<p>
00 DA 01 A0 Lc [data] symmetric key (DES/3DES/AES128/AES192/AES256)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>PUT DATA/initialize applet</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 DA 01 E0 Lc [data]
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>CREATE FILE</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 E0 00 00 Lc [data] (Lc in range 25 to 49 bytes)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>DELETE FILE</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 E4 00 00 00
</p>
</li>
</ul></div>
</dd>
</dl></div>
</div>
<div class="sect2">
<h3 id="_class_a0">CLASS A0</h3>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>DELETE FILE</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 E4 00 00 00
</p>
</li>
</ul></div>
</dd>
</dl></div>
</div>
<div class="sect2">
<h3 id="_class_80">CLASS 80</h3>
<div class="dlist"><dl>
<dt class="hdlist1">
Proprietary, change file type of EC key from 0x22 to 0x23 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
80 DA 00 00 Lc [data]
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
Proprietary, DES and AES ciphers 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
80 2A xx xx xx
</p>
</li>
</ul></div>
</dd>
</dl></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendixD">Appendix D: OsEID token</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="images/token1.png" alt="OeEID-token">
</div>
</div>
<div class="sect2">
<h3 id="_features_2">Features</h3>
<div class="ulist"><ul>
<li>
<p>
Based on easily accessible microcontroller Microchip/Atmel xmega128A4U
</p>
</li>
<li>
<p>
single sided PCB
</p>
</li>
<li>
<p>
integrated CCID reader and card in one microcontroller
</p>
</li>
<li>
<p>
no driver needed for windows/linux - emulation of Gemalto reader
</p>
</li>
<li>
<p>
T0 and T1 protocol, TPDU exchange level
</p>
</li>
<li>
<p>
RSA speed: 2048 - about 10 second, 1536 about 5 seconds, 1024 about 1.7 seconds
</p>
</li>
<li>
<p>
ECC speed: secp384r1 about 2.5 seconds, prime256v1 about 1.1 seconds
</p>
</li>
<li>
<p>
low suspend current
</p>
</li>
<li>
<p>
two LEDs to signalize reader/card operation
</p>
</li>
<li>
<p>
optional button to approve sign/decrypt operations
</p>
</li>
<li>
<p>
full speed USB device with electrostatic discharge protection
</p>
</li>
</ul></div>
<div class="paragraph"><p>(RSA speed tested on decrypt operation, time is difference between transmit
ciphertext and receive decrypted data.  The time may vary depending on the
USB host.)</p></div>
</div>
<div class="sect2">
<h3 id="_drawbacks_2">Drawbacks</h3>
<div class="paragraph"><p>Drawback are similar to OsEID card. But one significant drawback should be
pointed up:</p></div>
<div class="ulist"><ul>
<li>
<p>
USB and CCID code in same microcontroller as card code reduces security of device
  (due complexity of code, bug in CCID/USB code can compromise card code
  and lead to getting private keys from card.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_components">Components</h3>
<div class="paragraph"><p>1x ATMEL ATXMEGA128A4U-AU - microcontroller
<a href="https://www.tme.eu/en/details/atxmega128a4u-au/8-bit-avr-family/microchip-atmel/">https://www.tme.eu/en/details/atxmega128a4u-au/8-bit-avr-family/microchip-atmel/</a></p></div>
<div class="paragraph"><p>1x NXP PRTR5V0U2X.215  - ESD protection
<a href="https://www.tme.eu/en/details/prtr5v0u2x.215/transil-diodes-arrays/nexperia/">https://www.tme.eu/en/details/prtr5v0u2x.215/transil-diodes-arrays/nexperia/</a></p></div>
<div class="paragraph"><p>1x MCP1700T3302E/TT LTO 3.3V - LDO stabilizer (quiescent current 1.6uA package SOT23)
<a href="https://www.tme.eu/en/details/mcp1700t3302ett/ldo-unregulated-voltage-regulators/microchip-technology/mcp1700t-3302ett/">https://www.tme.eu/en/details/mcp1700t3302ett/ldo-unregulated-voltage-regulators/microchip-technology/mcp1700t-3302ett/</a></p></div>
<div class="paragraph"><p>1x DL1206-4.7  4.7H  - inductor package 1206  0.9ohm 50mA
<a href="https://www.tme.eu/en/details/dl1206-4.7/smd-1206-inductors/ferrocore/dl1206-4r7/">https://www.tme.eu/en/details/dl1206-4.7/smd-1206-inductors/ferrocore/dl1206-4r7/</a></p></div>
<div class="paragraph"><p>1x  DS1097-BN0  - USB connector
<a href="https://www.tme.eu/en/details/usba-lp/usb-ieee1394-connectors/connfly/ds1097-bn0/">https://www.tme.eu/en/details/usba-lp/usb-ieee1394-connectors/connfly/ds1097-bn0/</a></p></div>
<div class="paragraph"><p>4x SMD capacitors in 1206 package (values from schematics)
4x SMD resistors  in 1206 package (values from schematics)
2x SMD LED in 1206 package (red/green or red/blue)</p></div>
<div class="paragraph"><p>1x Optional button OMRON B3U-3100PM
<a href="https://www.tme.eu/en/details/b3u-3100pm/microswitches-tact/omron/">https://www.tme.eu/en/details/b3u-3100pm/microswitches-tact/omron/</a></p></div>
<div class="paragraph"><p>P2 connector is realized only by pads on PCB. Connector is used to program
xmega by PDI programmer.  Needle spring probe is used to connect programmer
to P2 connector.</p></div>
</div>
<div class="sect2">
<h3 id="_programming">Programming</h3>
<div class="paragraph"><p>You need programmer that support PDI programming. One open source/open
hardware can be found at:</p></div>
<div class="paragraph"><p><a href="https://www.olimex.com/Products/AVR/Programmers/AVR-ISP-MK2/open-source-hardware">https://www.olimex.com/Products/AVR/Programmers/AVR-ISP-MK2/open-source-hardware</a></p></div>
<div class="paragraph"><p>To connect programmer to token, you need connector with spring needles
(contacts pitch 2mm).  Create a reduction from this connector to your PDI
programmer.  Use schematics of token and pin description of your programmer,
to get correct connection.  (P2 connector: 1st PIN to CPU is PDI, then
RESET, + and GND).  Make sure that programmer is set up to power device with
3.3V!</p></div>
<div class="imageblock">
<div class="content">
<img src="images/xmega_prog.png" alt="xmega-prog">
</div>
<div class="title">Figure 1. Connector with spring needles, mechanical adaptor which simplifies the placement of needles.</div>
</div>
<div class="paragraph"><p>Example for <strong>avrdude</strong> and <strong>avrispmkII</strong> programmer:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ avrdude -p x128a4u -c avrispmkII -e -v -U flash:w:download/OsEID_token.hex
$ avrdude -p x128a4u -c avrispmkII -v -U fuse2:w:0xBF:m</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_compiling_from_sources_2">Compiling from sources</h3>
<div class="paragraph"><p>Compiling is similar to ATmega128 version:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>make -f Makefile.xmega128a4u
make -f Makefile.xmega128a4u fuses
make -f Makefile.xmega128a4u program</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_overclocking">Overclocking</h3>
<div class="paragraph"><p>Overclocking is not recommended, but if someone need this, there is a simple
way to do this. CPU clock is defined in file <strong>targets/xmega128a4u/avr_os.c</strong></p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>// use PLL - multiply 2MHz RC oscilator to 32MHz
  OSC.PLLCTRL = OSC_PLLSRC_RC2M_gc | (32 / 2);</pre>
</div></div>
<div class="paragraph"><p>Overwrite multiplication factor <strong>(32 / 2)</strong> to requested value (for example
<strong>(48 / 2)</strong>). Recompile and program your token.</p></div>
<div class="paragraph"><p>There is lot of information about XMEGA overclocking on internet.  Some
people run XMEGA over 50MHz and more without any problems.  Some other
people report problems with EEPROM on overclocked XMEGAs.  If your XMEGA
burns, this is your problem.  Please, read again disclaimer section in this
manual.</p></div>
</div>
<div class="sect2">
<h3 id="_schematics">Schematics</h3>
<div class="imageblock">
<div class="content">
<img src="images/OsEID_token.sch.svg" alt="SCH0.1">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pcb">PCB</h3>
<div class="paragraph"><p>There exists two version of PCB, one for classical photographic method and
etching in ferric chloride and second version for CNC routing.  You can
found OsEID_token.ngc file in download section.  This file is designed for
<strong>linuxcnc</strong> <a href="http://linuxcnc.org">http://linuxcnc.org</a>.  Please read this file, adjust feed rate,
check safe Z position, tune spindle commands, tool number etc.  Dimensions
in file are given in mm, make sure your machine uses metric, not imperial
units.  Use 0.3 up to 0.5mm milling tool.  PCB is positioned at Z=-1, Z=1 is
used for traverse.  Run your machine without tool first!</p></div>
<div class="paragraph"><p>AUTHOR IS NOT RESPONSIBLE FOR ANY DAMAGE OF YOUR MACHINE, TOOL OR ANY ANOTER
EQUIPMENTS. USE AT YOUR OWN RISK ONLY!</p></div>
<div class="imageblock">
<div class="content">
<img src="images/OsEID_token-F.Cu.svg" alt="PCB0.1">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/OsEID_token-Dwgs.User.svg" alt="PCBcut0.1">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/OsEID_token_vis1.png" alt="VIS0.1">
</div>
</div>
<div class="paragraph"><p>There is a plan for dual side PCB, with SD card reader. Development of this
model is frozen for now.</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendixE">Appendix E: AVR arithmetics</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_addition_subtraction_and_rotate_shift_operations">Addition, subtraction and rotate/shift operations</h3>
<div class="paragraph"><p>These operations are relatively simple, but to achieve desired speed,
operations are partially unrolled.  In one unrolled step 32 or 64 bit of
operands are processed.</p></div>
</div>
<div class="sect2">
<h3 id="_multiplication">Multiplication</h3>
<div class="paragraph"><p>AVR multiplication is based on karatsuba multiplication.  It uses modified
open source (public domain) implementation from Michael Hutter and Peter
Schwabe <a href="#AVR_KARATSUBA">[AVR_KARATSUBA]</a>.  256 bit multiplication code is fully revised to
enable run in interrupt safe way (stack pointer change is protected by CLI
instruction.) Code is faster, original code took 4797 clock cycles (in
branched version), new code is about 6% faster and about 7% smaller.
Similar changes are made in 192 bit multiplication.</p></div>
<div class="paragraph"><p>The 128 bit multiplication is used only for 512 bit RSA.  Because 512 bit
key is not safe today, it makes no sense to waste lot of flash for this
multiplication.  Here simple looped code is used and this code is able to
calculate truncated multiplication (low part of result) too. Another 128 bit
multiplication (karatsuba based) is integrated inside truncated 256 bit
multiplication.</p></div>
<table class="tableblock frame-all grid-all"
style="
width:80%;
">
<caption class="title">Table 5. Multiplication speed</caption>
<col style="width:12%;">
<col style="width:12%;">
<col style="width:12%;">
<col style="width:12%;">
<col style="width:12%;">
<col style="width:12%;">
<col style="width:12%;">
<col style="width:12%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">operands size</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">192</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">256</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">384</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">512</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">X  521</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">X  768</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">X 1024</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">clock cycles</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2860</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4500</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">9986</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">15330</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">17568</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">33201</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">50276</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>X - inclusive function call overhead (respect standard AVR ABI)</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">clock cycles are measured by <strong>simulavr</strong>. More info in
<strong>targets/simulavr/Readme</strong> from OsEID tarball.</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="_truncated_multiplication_speed">Truncated multiplication speed</h4>
<div class="paragraph"><p>Result of this multiplication is in same length as operand length. Only low
bits from result are available at end of this operation.</p></div>
<table class="tableblock frame-all grid-all"
style="
width:80%;
">
<caption class="title">Table 6. Trucnated multiplication speed</caption>
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">operands size</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">128</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">192</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">256</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">384</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">512</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">clock cycles</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">---</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1625</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2904</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">6558</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">10876</p></td>
</tr>
</tbody>
</table>
<div style="page-break-after:always"></div>
</div>
</div>
<div class="sect2">
<h3 id="_squaring">Squaring</h3>
<div class="paragraph"><p>192 and 256 bit squaring was written from scratch, it uses similar method as
described in <a href="#AVR_SQUARING">[AVR_SQUARING]</a>.  Code is designed as non branched.  Squaring
code is interrupt safe too.</p></div>
<table class="tableblock frame-all grid-all"
style="
width:80%;
">
<caption class="title">Table 7. Squaring speed</caption>
<col style="width:12%;">
<col style="width:12%;">
<col style="width:12%;">
<col style="width:12%;">
<col style="width:12%;">
<col style="width:12%;">
<col style="width:12%;">
<col style="width:12%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">operand size</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">192</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">256</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">384</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">512</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">X 521</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">768</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1024</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">clock cycles</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1847</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3093</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">6556</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">10644</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">12855</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">21864</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">34842</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>X - inclusive function call overhead (respect standard AVR ABI)</p></div>
<div class="paragraph"><p><a href="#AVR_SQUARING">[AVR_SQUARING]</a> is running in 1966/3253 clock cycles for 192/256 bit
squaring.</p></div>
</div>
<div class="sect2">
<h3 id="_modular_multiplicative_inversion">Modular multiplicative inversion</h3>
<div class="paragraph"><p>Modular multiplicative inversion is based on left shift, similar to
<a href="#Lorencz">[Lorencz]</a> or more similar to <a href="#Hars">[Hars]</a> shifting Euclidean algorithm.  AVR
microcontroller shift/rotate instruction allow us to rotate 8 bit value only
by one bit in one instruction cycle.  Original Hars algorithm is not usable
without modifications (very slow repetitive rotations of V/S by <em>f</em>).  The
goal is to minimize the number of rotations.</p></div>
<div class="paragraph"><p>In each step of algorithm <em>U</em> and <em>V</em> is aligned (by left rotations) on
highest non zero bit, then this bit is eliminated by subtraction.  <em>R</em> and
<em>S</em> are kept updated similar to <em>U</em> and <em>V</em>.  This step is repeating, but
align is done by right rotation, until bit size of <em>U</em> is bigger that bit
size of <em>V</em>.  If this is not true, <em>U</em> and <em>V</em> (<em>R</em> and <em>S</em>) are swapped, and
all rotations are returned back (right).  This procedure is repeating until
bit size of <em>U</em> is zero or one (no inversion exists or inversion found).</p></div>
<div class="paragraph"><p>The <em>U</em> and <em>V</em> are represented as unsigned number, but there are helper
variables <em>sU</em> and <em>sV</em> for storing the signs of <em>U</em> and <em>V</em>.  <em>R</em> and <em>S</em>
variables use 64 more bits (this is enough to use 1 more bit to represent
two&#8217;s complement number, but arithmetics routines are unrolled and use 8 bytes
step).</p></div>
<div class="paragraph"><p>Only C code is available for now, ASM version is planned.  Implementation
allows us to calculate inversion for even modulus too (this is needed for
calculation of CRT components).  Code is designed to be small, the speed of
the algorithm is not significant.  (In versions before 20171231, right shift
binary Euclidean algorithm was used, but this doesn&#8217;t allows us to calculate
CRT components because modulus is always even number.  This code is smaller
as new code but is slower too.)</p></div>
</div>
<div class="sect2">
<h3 id="_modulo_operation_and_modular_reduction">Modulo operation and modular reduction</h3>
<div class="sect3">
<h4 id="_modulo_operation">Modulo operation</h4>
<div class="paragraph"><p>Up to the  version 20190102 modulo operation uses binary division algorithm.
The rotate/shift operation, as mentioned before, is slow on AVR devices,
table of 8 rotated modulus values are used to save lot of rotate
instructions.  AVR assembler version of this code needs 262593 clock cycles
for 1024 bit number (575021 clock cycles for 1536, 1008281 clock cycles for
2048).  The code run in constant time.</p></div>
<div class="paragraph"><p>To speed up this part of code, new code uses precalculated constant <em>Bc</em>.
Reduction speed up is based on modificied Barrett method described in
<a href="#Hasenplaugh">[Hasenplaugh]</a>.</p></div>
<div class="paragraph"><p>Let <em>M</em> be modulus of <em>n</em> bits length.  Number <em>N</em> is to be reduced by <em>M</em>.
Maximal bit length of <em>N</em> is <em>2n</em>.  Constant <em>Bc</em> of maximal bit length <em>n</em>
is calculated from:</p></div>
<div class="paragraph"><p><em>Bc = 2<sup>1.5n</sup> mod M                             (1)</em></p></div>
<div class="paragraph"><p>To calculate <em>Bc</em> binary division algorithm is used. Number <em>N</em> can be
reduced to partial result number <em>Rp</em> (maximal bit length <em>1.5n+1</em>):</p></div>
<div class="paragraph"><p><em>Rp = N mod 2<sup>1.5n</sup> + (N &gt;&gt; 1.5n) * Bc          (2)</em></p></div>
<div class="paragraph"><p>Calculating <em>N mod 2<sup>1.5n</sup></em> is not an extensive operation - low part of <em>N</em> up
to <em>1.5n</em> bits is a result of this operation.  Rotation <em>&gt;&gt;</em> is not extensive
too, upper <em>0.5n</em> bits of <em>N</em> is a result of this operation.  Multiplication
with <em>Bc</em> uses two <em>0.5n</em> bits multiplications.</p></div>
<div class="paragraph"><p><em>Rp</em> is then reduced to final <em>R</em> (<em>R &lt; M</em>) by  binary division algorithm
but there is only <em>1+1.5n</em> bits to reduce not <em>2n</em> bits.</p></div>
<div class="paragraph"><p>Only for completeness, there is some things that can be observed:</p></div>
<div class="paragraph"><p>If number <em>N</em> is result of multiplication of two numbers  <em>A &lt; M</em>, <em>B &lt; M</em>,
and <em>Rp</em> of bit length <em>1+1.5n</em> is result form (2), then result <em>R &lt; M</em> can
be computed by at most three subtractions of <em>M &lt;&lt; 0.5n</em> from <em>Rp</em></p></div>
<div class="paragraph"><p>In RSA cryptosystem, prime <em>P</em> and <em>Q</em> has highest bit always set to 1 (i.e.
0x8001 for n=16, <em>M</em> in this calculation corresponds to <em>P</em> or <em>Q</em>).  At
most two substraction of <em>M &lt;&lt; 0.5n</em> is enough to reduce <em>Rp</em> to maximum
<em>1.5n</em> bits.  This is also true for any <em>A &lt; 2<sup>n</sup>, B &lt; 2<sup>n</sup></em></p></div>
</div>
<div class="sect3">
<h4 id="_modular_reduction_inside_rsa_exponentiation">Modular reduction inside RSA exponentiation</h4>
<div class="paragraph"><p>For commonly used  Montgomery exponentiation we need to calculate two values:
<em>x1 = 1 * r mod M</em> and <em>x2 = msg * r mod M</em>.  Additionally we need
precomputed constant <em>Mc</em> calculated from <em>r * r<sup>-1</sup> - M * Mc = 1</em>.  Here
<em>r</em> is in form <em>r = 2<sup>k</sup></em>.  The smallest possible <em>k</em> is chosen so that
<em>r &gt; N</em>. "M' must be a odd number (<em>M</em> and <em>r</em> must be relatively prime).</p></div>
<div class="paragraph"><p>For calculation of <em>Mc</em> modified Euclidean algorithm is used, where similar
table for <em>N</em> is used as in modulo operation.  Code is in AVR assembler,
calculation needs only 188300 clock cycles for 512 bit modulus length
(400684 clock cycles for 768 bit, 694988 clock cycles for 1024).</p></div>
<div class="paragraph"><p>For calculating <em>x1 = 1 * r mod n</em> similar code can be used as for
calculating <em>x2 = msg * r mod n</em>, but we can use special property of <em>r</em> to
avoid division in this calculation ( <a href="#RSA_high_speed">[RSA_high_speed]</a> page 48, chapter 3.8.1.
claims need of division in this step ).</p></div>
<div class="paragraph"><p>If <em>n &lt; 2<sup>k</sup> &lt; 2 * n</em>,  then <em>2<sup>k</sup> mod n = 2<sup>k</sup> - n</em>.  Here negated <em>n</em>
(<em>0 - n</em>) can be used directly as <em>x</em>.</p></div>
<div class="paragraph"><p>Reduction steps to reduce <em>N</em> of size <em>2n</em> bits to result <em>Rp</em> of maximal
bit length <em>n+1</em>:</p></div>
<div class="paragraph"><p><em>a = ((N mod 2<sup>n</sup> ) * Mc ) mod 2<sup>n</sup>             (3)</em></p></div>
<div class="paragraph"><p><em>b = a * N                                      (4)</em></p></div>
<div class="paragraph"><p><em>Rp = (N + b) &gt;&gt; n                              (5)</em></p></div>
<div class="paragraph"><p>If <em>Rp &gt; M</em>, one subtraction of <em>Rp - M</em> is sufficient to get result <em>R &lt;
M</em>.</p></div>
<div class="paragraph"><p>OsEID used Montgomery reduction up to version 20190102. Newer version uses
better method.</p></div>
<div class="paragraph"><p>Because <em>N</em> can be reduced to <em>Rp</em>  with bit length <em>1+1.5n</em> by algorithm
described above in modulo operation, only <em>0.5n</em> bits from low part of <em>Rp</em>
must be reduced by Montgomery reduction.  This allows us to choose <em>k</em> as
<em>1+0.5n</em>.  Calculation of <em>x1 = 1 * r mod N</em> is then eliminated, because <em>1 *
r</em> is always below <em>N</em>.  Calculation of <em>x2</em> is faster, only <em>1+1.5n</em> must
be reduced instead of <em>2n</em> bits.  Calculation of <em>Mc</em> is faster, we need
only <em>0.5n</em> bits.</p></div>
<div class="paragraph"><p>Reduced Montgomery algorithm first calculates help variable <em>a</em> with bit
size <em>0.5n</em> from already reduced <em>Rp</em> by truncated multiplication (only low
<em>0.5n</em> bits  are used):</p></div>
<div class="paragraph"><p><em>a = ((Rp mod 2<sup>0.5n</sup>) *  Mc) mod 2<sup>0.5n</sup>               (3*)</em></p></div>
<div class="paragraph"><p>For reducing <em>Rp</em> we need to calculate number <em>b</em> which is added to <em>Rp</em>
and this addition zeroize low <em>0.5n</em> bits in <em>Rp</em></p></div>
<div class="paragraph"><p><em>b = a * N                                              (4*)</em></p></div>
<div class="paragraph"><p>Computing <em>b</em> cost only two half sized (0.5n) multiplications. Finally result
<em>R</em> is calculated:</p></div>
<div class="paragraph"><p><em>R = (Rp + b) &gt;&gt; (0.5n)                                 (5*)</em></p></div>
<div class="paragraph"><p>Maximal bit length of <em>R</em> is <em>2+n</em> bits and to reduce this to bit length not
greater that <em>n</em> up to two subtractions of <em>N</em> is needed. Of course, result
<em>R</em> is in Montgomery form and it is not necessarily that <em>R &lt; M</em>.</p></div>
<div class="paragraph"><p>To get final result after exponentiation, one more step is needed -
multiplication by <em>1</em> and Montgomery reduction.  This reduction always need
at maximum one subtraction of <em>M</em> to guarantee final result <em>R &lt; M</em>.</p></div>
<div class="paragraph"><p>Old code uses three <em>0.5n</em>  sized multiplications in Karatsuba
multiplication, then one <em>0.5n</em> sized multiplication and two <em>0.5n</em> sized
truncated multiplications are used to construct one <em>n</em> sized truncated
multiplication.</p></div>
<div class="paragraph"><p>New code need only <em>0.5n</em> sized truncated multiplications and four <em>0.5n</em>
sized multiplications.</p></div>
<div class="paragraph"><p>Old and new code need some overhead for additions  and subtractions. Finally,
old code with full sized  Montgomery reduction for reducing 1024 bit to 512
bit need about 27000 clock cycles. New code needs only 24300 clock cycles.
This speed up calculation of RSA in about 10%.</p></div>
<div class="paragraph"><p>Maybe this algorithm reminds someone of so-called bipartite Modular
multiplication but there is difference in reduction of upper bits. Bipartite
method uses some multiply of <em>n</em> to reduce upper part of <em>N</em>. This code is
different, there is no multiply of <em>n</em> added to <em>N</em>.</p></div>
<div class="paragraph"><p>Someone may ask, why there is not used Barrett folding as described in
<a href="#Hasenplaugh">[Hasenplaugh]</a>.  This method need multiplication of operands with <em>1+0.5n</em>
and <em>0.5n</em> size.  Even this can be calculated with normal <em>0.5n</em>
multiplication and some addition (using the AND instruction for one more bit
in operand), it will introduce more overhead as in explained algorithm.
Then there is <em>1+n</em> and <em>n</em> operand size in final part of folding, this
introduce second overhead.  It can be guessed, that currently implemented
algorithm is faster (on 8 bit AVR platform).</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_ecc_operation_speed">ECC operation speed</h3>
<div class="paragraph"><p>EC calculation uses projective coordinates.  Lot of code is inspired by NIST
<a href="#NIST_ECC">[NIST_ECC]</a> and <a href="#OPENCRYPTOTOKEN">[OPENCRYPTOTOKEN]</a> EC point doubling is optimized for NIST
curves and for secp256k1 curve.  EC point multiplication is designed as
constant time, with multiplication window of 4 bits.  Point multiplication
is blinded.  For each supported curve, a separate fast reduction algorithm
is used. The secp521r1 curve is supported only on devices with 8KB RAM and
more (ATmega 1284, xmega128A4U). Firmware for atmega128 microcontroller can
be recompiled with two bits multiplication window, then secp521r1 is running
on this device.</p></div>
<table class="tableblock frame-all grid-all"
style="
width:80%;
">
<caption class="title">Table 8. ECDSA operation timing, blinded, in millions of clock cycles</caption>
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<col style="width:20%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" colspan="2" ><p class="tableblock">window 4</p></td>
<td class="tableblock halign-left valign-top" colspan="2" ><p class="tableblock">window 2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">32 bit blinding</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">not blinded</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">32 bit blinding</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">not blinded</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">prime192v1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">15,5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">13,5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">19,0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">-----</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">prime256v1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">38,7</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">34,6</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">48,7</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">-----</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">secp256k1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">----</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">47,1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">----</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">-----</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">secp384r1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">82,9</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">76,8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">106,1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">-----</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">secp521r1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">140,9</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">133,8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">182,5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">-----</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_rsa_operation_speed">RSA operation speed</h3>
<div class="paragraph"><p>In the next table, there is  RSA calculation timing in clock cycles (normal
RSA / precalculated constants for modulo and P<sup>-1</sup> mod R and Q<sup>-1</sup> mod R in
key file), interrupt always enabled.  Exponentiation window is not optimal
to any key size - optimal window for key size 512/768 is 4 bits, not 5, but
code uses fixed size defined at compilation time (based on RAM size of
device) for all key sizes.  Because 512/768 bit key is not safe today, it
makes no sense to optimize 512/768 bit calculation for window size 5 bits.</p></div>
<div style="page-break-after:always"></div>
<table class="tableblock frame-all grid-all"
style="
width:80%;
">
<caption class="title">Table 9. RSA private operation timing (in millions of clock cycles)</caption>
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" colspan="2" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" colspan="2" ><p class="tableblock">no blinding</p></td>
<td class="tableblock halign-left valign-top" colspan="2" ><p class="tableblock">precalc, blinding</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">key size</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">window</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">precalc</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">no precalc</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Bellcore.prot</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="6" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="3" ><p class="tableblock">512</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">16,17</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">16,81</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">18,22</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">19.01</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">14,29</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">14,43</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">15,57</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">16,35</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">14,61</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">14,75</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">15,87</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">16,66</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="6" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="3" ><p class="tableblock">768</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">27,47</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">27,67</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">29,17</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">30,01</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">23,08</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">23,38</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">24,48</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">25,32</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">22,97</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">23,26</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">24,61</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">25,44</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="6" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="3" ><p class="tableblock">1024</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">57,16</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">57,66</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">59.83</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">61,14</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">47,81</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">48,32</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">50,01</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">51,32</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">47,29</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">47,79</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">49,45</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">50,75</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="6" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="3" ><p class="tableblock">1536</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">178,4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">179,5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">184,0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">186,7</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">147,8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">148,9</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">152,4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">155,1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">144,4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">145,5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">148,9</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">151,6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="6" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="3" ><p class="tableblock">2048</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">365,7</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">367,6</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">374,3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">378,5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">302,7</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">304,6</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">309,7</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">313,9</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">293,8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">295,7</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">302,1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">306,4</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>To reach this, lot of  assembler routines are used, especially Montgomery
algo and function like mul256 mod 2<sup>256</sup> (truncated multiplication).  To get
best possible performance, the 384, 512, 768 and 1024 bit squaring and
multiplication are unrolled as possible, with respect to flash memory size
in AVR.</p></div>
<div class="paragraph"><p>Code size: about 20 000 lines in AVR assembler, about 10000 lines in C. AVR
flash in ATmega128 is occupied by ~ 63kB code, 64Kb is used as data space for
card filesystem. RAM is almost full, there is approximately 80 bytes free in
atmnega128 (4kB RAM space).</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendixF">Appendix F: Cryptographic algorithm security</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_rsa_security">RSA security</h3>
<div class="paragraph"><p>OsEID implements several protections to generally known attacks to RSA
cryptosystem. There exists several types of side channel attacks:</p></div>
<div class="sect3">
<h4 id="_simple_power_analysis_spa_timing_attack">Simple Power Analysis (SPA) / timing attack</h4>
<div class="paragraph"><p>To prevent this type of attack, OsEID uses:</p></div>
<div class="ulist"><ul>
<li>
<p>
constant time calculation (time does not depend on key or message value)
</p>
</li>
<li>
<p>
Exponentiation uses fixed window size, window is not sliding, zeros
   are not skipped.
</p>
</li>
</ul></div>
<div class="paragraph"><p><em>RSA implementation in OsEID card is resistant to SPA / timing attack.</em></p></div>
</div>
<div class="sect3">
<h4 id="_differential_power_analysis_dpa">Differential Power Analysis (DPA)</h4>
<div class="paragraph"><p>To prevent this type of attack, OsEID uses:</p></div>
<div class="ulist"><ul>
<li>
<p>
card uses exponent blinding
</p>
</li>
</ul></div>
<div class="paragraph"><p>In default settings 24 bits random value is used to blind private exponent
parts (dP and dQ).  Exponent blinding is a big barrier for lot of advanced
techniques that allow use of side channel attack to expose private keys.</p></div>
<div class="ulist"><ul>
<li>
<p>
Card does not support message blinding <a href="#RSA_MSG_BLINDING">[RSA_MSG_BLINDING]</a>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Due constant time of operation (no variable length sliding window), it is
not possible to use known attacks which could work due to the absence of a
message blinding.</p></div>
<div class="ulist"><ul>
<li>
<p>
Card does not support modulus blinding
</p>
</li>
</ul></div>
<div class="paragraph"><p>Modular reduction is needed to calculate Montgomery product like <span class="monospaced">1 * r mod
n</span> and <span class="monospaced">M * r mod n</span>.  In both cases, <span class="monospaced">n</span> is secret value P or Q.  Due CRT
calculation there are operations like <span class="monospaced">M mod P</span> and <span class="monospaced">M mod Q</span>.  Modular
reduction is running in constant time, but is not blinded.  There is a way
to extract power fingerprint from this operation.  It is necessary to run
lot of power traces to get reliable power fingerprint from the same message.
Several special formated messages must be traced to get some information
about P/Q.  Because number of analyzed messages run over 30 000, this type
of attack is not realistic for now.  More about this attack to this function
can be found in <a href="#DPA_on_modular_reduction">[DPA_on_modular_reduction]</a>.</p></div>
<div class="paragraph"><p>Because missing message blinding, there is another point that allow extract
some information from card.  CRT recombination (Garner`s algorithm)
produce result, that need conditional addition.  This addition is always
realized, but power trace can be used to detect which of two possible
results is used as return value.  It&#8217;s not easy to detect this step in one
power trace, but the correlation of a very large number of power traces may
leak some information about this step.</p></div>
<div class="paragraph"><p>Montgomery product needs <span class="monospaced">n'</span> from equation <span class="monospaced">r* r^-1 - n * n' = 1</span>.  This
calculation is running in constant time, but is not blinded.  There is a way
to use DPA for extracting some information about P and Q from card.  In
default firmware configuration, this calculation is running only in key
upload operation, therefore the security of this algorithm is for now
irrelevant.</p></div>
<div class="paragraph"><p><em>RSA implementation in OsEID card is (reasonably) resistant to DPA attack</em></p></div>
</div>
<div class="sect3">
<h4 id="_algorithm_problem">Algorithm problem</h4>
<div class="paragraph"><p>RSA implementation uses <a href="#CRT">[CRT]</a> (China Remainder Theorem).  <a href="#SINGLE_ERROR">[SINGLE_ERROR]</a>
in CRT implementation can expose private key.  This is also known as
<a href="#BELLCORE">[BELLCORE]</a> attack. To prevent this type of attack, OsEID uses:</p></div>
<div class="ulist"><ul>
<li>
<p>
result of exponentiation is checked by public exponent.
</p>
</li>
</ul></div>
<div class="paragraph"><p>This extends the calculation time by approximately 2% for 2048 bits to 5%
for 512 bits RSA.  CRT recombination is not protected, but injecting fault
precisely into this point is very difficult.  Implementing full check
(exponenting signature by public exponent) is problematic due RAM and FLASH
size limitation.  There is not protection against wrong loaded P or Q from
key storage!  There is about 10 msec interval for 1024 bit key for
injecting error in message mod P/Q calculation and about 38 msec if 2048
bit key is used. Intervals for OsEID token are about 2.5x shorter.</p></div>
<div class="paragraph"><p>There is lot of methods to inject error into microcontroller calculation,
fotons from laser/flash light can be used or some particle from radioactive
isotope or electrostatic discharge etc.  Is very difficult to hit exact time
and exact part of microcontroller (for example do not hit program counter but
hit only some of registers or ALU, exact part of RAM etc.), lot of attempt
is needed and lot of luck is needed.  Usually any of attempts ends with
halted microcontroller or in worst case with total damage of
microcontroller.</p></div>
<div class="paragraph"><p><em>RSA implementation in OsEID card is (reasonably) resistant to Bellcore attack</em></p></div>
</div>
<div class="sect3">
<h4 id="_rsa_key_generation">RSA key generation</h4>
<div class="paragraph"><p>OsEID supports RSA key generation.  This operation is really slow, but is
not subject to <a href="#ROCA">[ROCA]</a>.  There is really random prime selection algorithm
used for RSA key generation.</p></div>
<div class="paragraph"><p>Number from random generator is modified - highest  and lowest bit are set
to 1 and this number is then tested by simple sieve - division by 1st 130
primes - and then Miller-Rabin test is used as primality test.  There is no
hardware divisor in AVR devices, GCD is used to check all 130 primes in one
step (product of 1st 130 primes can be fitted into 1024 bit value, this
value is one operand in GCD, second operand is tested number).</p></div>
<div class="paragraph"><p>Number is considered to be a prime number if pass the Rabin-Miller test.
Rabin-Miller test consider number to be a prime after several loops with
different parameter <em>A</em>.  Number of loops is based on length of a tested
prime.  (Listed in row  "MR loop pass").</p></div>
<table class="tableblock frame-all grid-all"
style="
width:100%;
">
<caption class="title">Table 10. RSA key generation statistics (for 10 000 keys)</caption>
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">key size</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">512</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">768</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1024</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1536</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2048</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">prime size</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">256</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">384</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">512</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">768</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1024</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">total primes generated</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">33600</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">33164</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">32964</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">33082</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">33216</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rejected, small product P * Q</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">6551</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">6312</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">6213</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">6300</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">6350</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">rejected P,Q too close</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">249</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">270</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">269</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">238</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">258</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">average GCD op. for one prime</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">73.83</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">110.64</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">146.83</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">222.95</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">295.65</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">average MR op. for one prime</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">13.97</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">22.53</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">28.87</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">44.7</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">59.18</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">MR loop pass</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>When both primes are found, they are tested if they are not too close to
each other.  Then modulus is calculated, and tested if modulus is not too
short (if highest bit is not set - short modulus).  Finally RSA components
are calculated.  If some of test fails, both primes are discarded and two
new primes are searched.  This handling prevents unnecessary bias of
prime/modulus value.</p></div>
<div class="paragraph"><p>Most often, we need to generate 4 primes (only 33% probability to generate
good P,Q who are not rejected due small product P*Q or P,Q is too close
together).</p></div>
<table class="tableblock frame-all grid-all"
style="
width:100%;
">
<caption class="title">Table 11. average GCD speed (in millions of clock cycles)</caption>
<col style="width:25%;">
<col style="width:25%;">
<col style="width:25%;">
<col style="width:25%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">key size (bits)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">512</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1024</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2048</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">prime size (bits)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">256</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">512</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1024</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">clock cycles</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1.7</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2.0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2.4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">time - card  (seconds)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.126</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.148</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.178</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">time - token (seconds)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.054</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.063</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.075</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>For one prime (512 bit) we need in average 147 GCD operations, total time
147*0.148 = about 22 seconds.  Then 29+6 Miller-Rabin test (one about 1.9 sec)
= about 66.5 seconds.  For one prime we need in average 89 seconds.</p></div>
<div class="paragraph"><p>Generation of 1024 bit key (4 primes ) then take in average about 6 minutes,
but in worst case over 30 minutes.</p></div>
<div class="paragraph"><p>When generating a 2048 bit key you have to be very patient.  Count with time
1 to 3 hours.  (One Miller-Rabin test run in about 11 second - there is
really no way to run this faster with only one 8 bit multiplier in AVR)</p></div>
<div class="paragraph"><p>Keep in mind, if you generate a key, operation is not blinded.
Exponentiation in Miller-Rabin test, squaring, and CRT components
calculation (3x modular multiplicative inverse) is not blinded too.  SPA,
DPA or IPA can be used to extract some informations about generated key.
Therefore it is recommended to generate key only in secure environment, if
key security is important.</p></div>
<div class="paragraph"><p>OsEID project does not use strong primes for P and Q.  Strong primes can
protect us from faktorization of modulus using Pollard&#8217;s algorithm, but
strong primes do not protect us against new methods of modulus factorization
for example Lenstra elliptic curve factorization or Number Field Sieve.</p></div>
<div class="paragraph"><p><em>RSA key generation is not resistant to side channels attack</em></p></div>
<div class="paragraph"><p>Please read more about <a href="#RSA_attack_resistance">[RSA_attack_resistance]</a>, OsEID is hobby card, you
can not expect perfect resistance to all attacks.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_ecc_security">ECC security</h3>
<div class="paragraph"><p>Briefly, all implemented curves are not secure enough, more info at
<a href="#SAFECURVES">[SAFECURVES]</a>.  Apart from this information, implemented elliptic curves
are widely used on the Internet.  If you have any doubts about the safety of
NIST curves, please search internet about rigidity of NIST curves.  Some
information can be found here: <a href="#NIST_RIGGED">[NIST_RIGGED]</a></p></div>
<div class="paragraph"><p>To prevent SPA, EC calculation is running in constant time (but not perfect
constant time, for example, modular multiplicative inversion run time
depends on input numbers).  OsEID implementation also uses blinding in point
multiplication.  Random 32 bit value is used to blind private key in point
multiplication.  SPA attack is not very effective.  Still DPA/IPA can be
used to extract some of sensitive information from other functions.  It is,
however, much more problematic as the attack on not blinded point
multiplication.</p></div>
<div class="paragraph"><p><em>Card firmware implementation may also have some security bugs.  You have
been warned.</em></p></div>
<div class="paragraph"><p>(Do you know about these shortcomings in the world of commercial cards?)</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendixG">Appendix G: Literature</h2>
<div class="sectionbody">
<div class="paragraph"><p>sorry, no paper literature, only internet links</p></div>
<div class="sect2">
<h3 id="_card_iso7816_related_literature">Card/ISO7816 related literature</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="https://en.wikipedia.org/wiki/ISO/IEC_7816">https://en.wikipedia.org/wiki/ISO/IEC_7816</a>
</p>
</li>
<li>
<p>
<a href="http://www.cardwerk.com/smartcards/smartcard_standard_ISO7816.aspx">http://www.cardwerk.com/smartcards/smartcard_standard_ISO7816.aspx</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_avr">AVR</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.atmel.com/images/Atmel-0856-AVR-Instruction-Set-Manual.pdf">http://www.atmel.com/images/Atmel-0856-AVR-Instruction-Set-Manual.pdf</a>
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_atmega128">atmega128</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.microchip.com/wwwproducts/ATmega128">http://www.microchip.com/wwwproducts/ATmega128</a>
</p>
</li>
<li>
<p>
<a href="http://ww1.microchip.com/downloads/en/DeviceDoc/doc2467.pdf">http://ww1.microchip.com/downloads/en/DeviceDoc/doc2467.pdf</a>
</p>
</li>
<li>
<p>
<a href="http://www.atmel.com/Images/Atmel-8151-8-bit-AVR-ATmega128A_Datasheet.pdf">http://www.atmel.com/Images/Atmel-8151-8-bit-AVR-ATmega128A_Datasheet.pdf</a>
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_atxmega128a4u">atxmega128a4u</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.microchip.com/wwwproducts/en/ATxmega128A4U">http://www.microchip.com/wwwproducts/en/ATxmega128A4U</a>
</p>
</li>
<li>
<p>
<a href="http://ww1.microchip.com/downloads/en/DeviceDoc/Atmel-8331-8-and-16-bit-AVR-Microcontroller-XMEGA-AU_Manual.pdf">http://ww1.microchip.com/downloads/en/DeviceDoc/Atmel-8331-8-and-16-bit-AVR-Microcontroller-XMEGA-AU_Manual.pdf</a>
</p>
</li>
<li>
<p>
<a href="http://ww1.microchip.com/downloads/en/DeviceDoc/Atmel-8387-8-and16-bit-AVR-Microcontroller-XMEGA-A4U_Datasheet.pdf">http://ww1.microchip.com/downloads/en/DeviceDoc/Atmel-8387-8-and16-bit-AVR-Microcontroller-XMEGA-A4U_Datasheet.pdf</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_mathematics_implementations_in_avr">Mathematics implementations in AVR</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="https://cryptojedi.org/papers/avrmul-20140715.pdf">https://cryptojedi.org/papers/avrmul-20140715.pdf</a>
</p>
</li>
<li>
<p>
<a id="AVR_KARATSUBA"></a>[AVR_KARATSUBA] <a href="https://eprint.iacr.org/2014/592.pdf">https://eprint.iacr.org/2014/592.pdf</a>
</p>
</li>
<li>
<p>
<a id="AVR_SQUARING"></a>[AVR_SQUARING] <a href="https://eprint.iacr.org/2014/817.pdf">https://eprint.iacr.org/2014/817.pdf</a>
</p>
</li>
<li>
<p>
<a href="http://mhutter.org/research/avr/">http://mhutter.org/research/avr/</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_modular_multiplicative_inversion_2">Modular Multiplicative Inversion</h3>
<div class="ulist"><ul>
<li>
<p>
<a id="Hars"></a>[Hars] <a href="https://pdfs.semanticscholar.org/2e6e/fa126c2f1e719489df30b22c4ec42a7212c8.pdf">https://pdfs.semanticscholar.org/2e6e/fa126c2f1e719489df30b22c4ec42a7212c8.pdf</a>
</p>
</li>
<li>
<p>
<a id="Lorencz"></a>[Lorencz] <a href="https://link.springer.com/content/pdf/10.1007%2F3-540-36400-5_6.pdf">https://link.springer.com/content/pdf/10.1007%2F3-540-36400-5_6.pdf</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_ecc">ECC</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.johannes-bauer.com/compsci/ecc/">http://www.johannes-bauer.com/compsci/ecc/</a>
</p>
</li>
<li>
<p>
<a id="NIST_ECC"></a>[NIST_ECC] <a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.204.9073&amp;rep=rep1&amp;type=pdf">http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.204.9073&amp;rep=rep1&amp;type=pdf</a>
  (<a href="https://apps.nsa.gov/iaarchive/library/ia-guidance/ia-solutions-for-classified/algorithm-guidance/mathematical-routines-for-the-nist-prime-elliptic-curves.cfm">https://apps.nsa.gov/iaarchive/library/ia-guidance/ia-solutions-for-classified/algorithm-guidance/mathematical-routines-for-the-nist-prime-elliptic-curves.cfm</a>)
</p>
</li>
<li>
<p>
<a id="SAFECURVES"></a>[SAFECURVES] <a href="https://safecurves.cr.yp.to/">https://safecurves.cr.yp.to/</a>
</p>
</li>
<li>
<p>
<a id="NIST_RIGGED"></a>[NIST_RIGGED] <a href="https://crypto.stackexchange.com/questions/12898/is-there-a-feasible-method-by-which-nist-ecc-curves-over-prime-fields-could-be-i">https://crypto.stackexchange.com/questions/12898/is-there-a-feasible-method-by-which-nist-ecc-curves-over-prime-fields-could-be-i</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_rsa">RSA</h3>
<div class="ulist"><ul>
<li>
<p>
<a id="CRT"></a>[CRT] <a href="http://www.di-mgt.com.au/crt_rsa.html">http://www.di-mgt.com.au/crt_rsa.html</a>
</p>
</li>
<li>
<p>
<a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.538.4909&amp;rep=rep1&amp;type=pdf">http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.538.4909&amp;rep=rep1&amp;type=pdf</a>
</p>
</li>
<li>
<p>
<a id="RSA_high_speed"></a>[RSA_high_speed] <a href="ftp://ftp.rsasecurity.com/pub/pdfs/tr201.pdf">ftp://ftp.rsasecurity.com/pub/pdfs/tr201.pdf</a>
</p>
</li>
<li>
<p>
<a href="https://crypto.stanford.edu/~dabo/papers/RSA-survey.pdf">https://crypto.stanford.edu/~dabo/papers/RSA-survey.pdf</a>
</p>
</li>
<li>
<p>
<a href="https://www.nics.uma.es/pub/seciot10/files/pdf/liu_seciot10_paper.pdf">https://www.nics.uma.es/pub/seciot10/files/pdf/liu_seciot10_paper.pdf</a>
</p>
</li>
<li>
<p>
<a id="RSA_MSG_BLINDING"></a>[RSA_MSG_BLINDING] <a href="https://eprint.iacr.org/2014/869.pdf">https://eprint.iacr.org/2014/869.pdf</a>
</p>
</li>
<li>
<p>
<a href="https://www.cryptoexperts.com/ches2015/slides/day2/session1/talk2.pdf">https://www.cryptoexperts.com/ches2015/slides/day2/session1/talk2.pdf</a>
</p>
</li>
<li>
<p>
<a id="ROCA"></a>[ROCA] <a href="https://github.com/crocs-muni/roca">https://github.com/crocs-muni/roca</a>
</p>
</li>
<li>
<p>
<a id="SINGLE_ERROR"></a>[SINGLE_ERROR] <a href="https://www.cryptologie.net/article/371/fault-attacks-on-rsas-signatures/">https://www.cryptologie.net/article/371/fault-attacks-on-rsas-signatures/</a>
</p>
</li>
<li>
<p>
<a id="BELLCORE"></a>[BELLCORE] <a href="https://eprint.iacr.org/2012/553.pdf">https://eprint.iacr.org/2012/553.pdf</a>
</p>
</li>
<li>
<p>
<a id="DPA_on_modular_reduction"></a>[DPA_on_modular_reduction] <a href="https://link.springer.com/content/pdf/10.1007/3-540-36400-5_18.pdf">https://link.springer.com/content/pdf/10.1007/3-540-36400-5_18.pdf</a>
</p>
</li>
<li>
<p>
<a id="RSA_attack_resistance"></a>[RSA_attack_resistance] <a href="https://www.bsi.bund.de/SharedDocs/Downloads/DE/BSI/Zertifizierung/Interpretationen/AIS_46_BSI_guidelines_SCA_RSA_V1_0_e_pdf.pdf">https://www.bsi.bund.de/SharedDocs/Downloads/DE/BSI/Zertifizierung/Interpretationen/AIS_46_BSI_guidelines_SCA_RSA_V1_0_e_pdf.pdf</a>
</p>
</li>
<li>
<p>
<a id="Hasenplaugh"></a>[Hasenplaugh] <a href="https://www.lirmm.fr/arith18/papers/hasenplaugh-FastModularReduction.pdf">https://www.lirmm.fr/arith18/papers/hasenplaugh-FastModularReduction.pdf</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_rng">RNG</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.chronox.de/lrng/doc/lrng.pdf">http://www.chronox.de/lrng/doc/lrng.pdf</a>
</p>
</li>
<li>
<p>
<a href="https://csrc.nist.gov/projects/random-bit-generation/documentation-and-software">https://csrc.nist.gov/projects/random-bit-generation/documentation-and-software</a>
</p>
</li>
<li>
<p>
<a href="http://www.phy.duke.edu/~rgb/General/dieharder.php">http://www.phy.duke.edu/~rgb/General/dieharder.php</a>
</p>
</li>
<li>
<p>
<a href="http://www.fourmilab.ch/random/">http://www.fourmilab.ch/random/</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_usb_related_literature_software">USB related literature/software</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.beyondlogic.org/usbnutshell/usb1.shtml">http://www.beyondlogic.org/usbnutshell/usb1.shtml</a>
</p>
</li>
<li>
<p>
<a href="http://www.fourwalledcubicle.com/LUFA.php">http://www.fourwalledcubicle.com/LUFA.php</a>
</p>
</li>
<li>
<p>
<a href="https://www.obdev.at/products/vusb/index.html">https://www.obdev.at/products/vusb/index.html</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_ccid">CCID</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="https://usb.org.10-1-108-210.causewaynow.com/sites/default/files/DWG_Smart-Card_CCID_Rev110.pdf">https://usb.org.10-1-108-210.causewaynow.com/sites/default/files/DWG_Smart-Card_CCID_Rev110.pdf</a>
</p>
</li>
<li>
<p>
<a id="CCIDusb"></a> <a href="https://github.com/LudovicRousseau/CCID">https://github.com/LudovicRousseau/CCID</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_myeid">MyEID</h3>
<div class="ulist"><ul>
<li>
<p>
<a id="MyEID"></a>[MyEID] <a href="https://webservices.aventra.fi/wordpress/wp-content/downloads/MyEID%20PKI%20JavaCard%20Applet%20Reference%20Manual%202-3-0.pdf">https://webservices.aventra.fi/wordpress/wp-content/downloads/MyEID%20PKI%20JavaCard%20Applet%20Reference%20Manual%202-3-0.pdf</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_related_projects">Related projects</h3>
<div class="ulist"><ul>
<li>
<p>
<a id="OpenSC"></a>[OpenSC] <a href="https://github.com/OpenSC/OpenSC/wiki">https://github.com/OpenSC/OpenSC/wiki</a>
</p>
</li>
<li>
<p>
<a id="OPENCRYPTOTOKEN"></a>[OPENCRYPTOTOKEN] <a href="https://github.com/sa2ajj/opencryptotoken/tree/master/opencryptotoken">https://github.com/sa2ajj/opencryptotoken/tree/master/opencryptotoken</a>
</p>
</li>
<li>
<p>
<a href="http://wiki.seeed.cc/FST-01/">http://wiki.seeed.cc/FST-01/</a>
</p>
</li>
<li>
<p>
<a href="http://www.fsij.org/category/gnuk.html">http://www.fsij.org/category/gnuk.html</a>
</p>
</li>
<li>
<p>
<a href="https://trezor.io/">https://trezor.io/</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_pkcs11">pkcs11</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="https://github.com/Pkcs11Interop/PKCS11-SPECS/tree/master/v2.20">https://github.com/Pkcs11Interop/PKCS11-SPECS/tree/master/v2.20</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_piv">PIV</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="http://csrc.nist.gov/groups/SNS/piv/index.html">http://csrc.nist.gov/groups/SNS/piv/index.html</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_minidriver">minidriver</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="https://msdn.microsoft.com/en-us/library/windows/hardware/dn631754(v=vs.85).aspx">https://msdn.microsoft.com/en-us/library/windows/hardware/dn631754(v=vs.85).aspx</a>
</p>
</li>
<li>
<p>
<a href="http://download.microsoft.com/download/7/E/7/7E7662CF-CBEA-470B-A97E-CE7CE0D98DC2/sc-minidriver_specs_V7.docx">http://download.microsoft.com/download/7/E/7/7E7662CF-CBEA-470B-A97E-CE7CE0D98DC2/sc-minidriver_specs_V7.docx</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_licence">Licence</h3>
<div class="ulist"><ul>
<li>
<p>
<a id="GPL"></a>[GPL] <a href="https://www.gnu.org/licenses/licenses.en.html">https://www.gnu.org/licenses/licenses.en.html</a>
</p>
</li>
</ul></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendixH">Appendix H: Opensc patches</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_opensc_0_20">Opensc 0.20</h3>
<div class="paragraph"><p>Card is automaticaly detected. No patch is needed. If you need support for
secp256k1, please read about experimental support for secp256k1 below.</p></div>
</div>
<div class="sect2">
<h3 id="_opensc_0_17_018_and_0_19">Opensc 0.17, 018 and 0.19</h3>
<div class="paragraph"><p>Opensc 0.17, 0.18 and 0.19 can detect all features of OsEID except of
support for secp256k1.  To use myeid driver for OsEID card you need to
configure OpenSC package only.  Please insert OsEID ATR into <strong>opensc.conf</strong>
file.</p></div>
<div class="sect3">
<h4 id="_experimental_support_for_secp256k1">Experimental support for secp256k1</h4>
<div class="paragraph"><p>Opensc can signalize support for secp256k1 curve.  For Opensc 0.17, 0.18 and
0.19 following patch is suggested:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>--- opensc-0.17rc1/src/libopensc/card-myeid.c.orig     2017-06-13 13:23:53.000000000 +0200
+++ opensc-0.17rc1-patched/src/libopensc/card-myeid.c  2017-06-20 08:58:43.650806261 +0200
@@ -79,6 +79,7 @@
        "3B:89:80:01:09:38:33:B1:4D:79:45:49:44:4C",
        "3B:F5:96:00:00:80:31:FE:45:4D:79:45:49:44:15", /* Infineon's chip */
        "3B:F5:96:00:00:81:31:FE:45:4D:79:45:49:44:14",
+       "3B:F5:18:00:02:10:80:4F:73:45:49:44",          /* OsEID */
+       "3B:F5:18:00:02:80:01:4F:73:45:49:44:1A",       /* OsEID token*/
        NULL
 };

@@ -113,6 +114,7 @@
        {"secp384r1", {{1, 3, 132, 0, 34, -1}},         384},
        {"secp521r1", {{1, 3, 132, 0, 35, -1}},         521},
        {NULL, {{-1}}, 0},
+       {"secp256k1", {{1, 3, 132, 0, 10, -1}},         256},   /* OsEID */
 };

 static int myeid_get_info(struct sc_card *card, u8 *rbuf, size_t buflen);
@@ -227,6 +229,9 @@
                if (card_caps.max_aes_key_length &gt;= 256)
                        _sc_card_add_symmetric_alg(card, SC_ALGORITHM_AES, 256, flags);
        }
+        /* OsEID support for secp256k1 */
+        if (0 == memcmp("OsEID", card-&gt;atr.value + card-&gt;atr.len - 5, 5))
+               _sc_card_add_ec_alg(card,  ec_curves[5].size, flags, ext_flags, &amp;ec_curves[5].curve_oid);
+        if (0 == memcmp("OsEID", card-&gt;atr.value + card-&gt;atr.len - 6, 5))
+               _sc_card_add_ec_alg(card,  ec_curves[5].size, flags, ext_flags, &amp;ec_curves[5].curve_oid);

        /* State that we have an RNG */
        card-&gt;caps |= SC_CARD_CAP_RNG | SC_CARD_CAP_ISO7816_PIN_INFO;</pre>
</div></div>
<div class="paragraph"><p>With this patch you can upload secp256k1 key into card. You can generate key
by openssl and upload to card by standart opensc tool:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>pkcs1515-init --store-private-key key.pem</pre>
</div></div>
<div class="paragraph"><p>There is no simple way to decide what curve is used (secp256k1/secp256r1) in
card firmware/OpenSC.  Original MyEID card does not support curve OID
specification in key upload/key generate functions.  It is not simple to
design a reasonable method for specifying curve OID, which does not affect
compatibility with newer versions of MyEID card.  For now, filetype 0x23 is
used to mark secp256k1 internal key file.</p></div>
<div class="paragraph"><p>After uploading secp256k1 key, you need to determine key file path (use
pkcs15-tool -D command).  Then change type of this file.  For this purpose
proprietary APDU can be used.  This proprietary APDU is a special variant of
PUT DATA command, but with CLA code 0x80:</p></div>
<div class="paragraph"><p>0x80 0xDA 0x00 0x00 0x00</p></div>
<div class="paragraph"><p>Before use of this APDU, SELECT and VERIFY command must be issued on key
file. (Key file path can be determined by pkcs15-tool -D command)</p></div>
<div class="paragraph"><p>Please read OsEID-tool script for example usage.</p></div>
<div class="paragraph"><p>Card can generate secp256k1 key, but this needs more patches in OpenSC
(before key is generated, key file must be created with 0x23 value in tag
0x82).  Unfortunately, there is no curve type information available in this
part of OpenSC (ver 0.16.0) code and there is no simple way to determine
what curve is to be used (secp256k1/prime256v1).</p></div>
<div class="paragraph"><p>To test key generation, there is a simple way - recompile OpenSC to always
generate 0x23 value in tag 0x82 for EC keys.</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>--- opensc-0.16.0/src/libopensc/cardctl.h       2016-05-31 09:36:09.000000000 +0200
+++ opensc-0.16.0-patched/src/libopensc/cardctl.h       2016-12-13 13:19:23.461149289 +0100
@@ -856,7 +856,7 @@
  */
        enum SC_CARDCTL_MYEID_KEY_TYPE {
                SC_CARDCTL_MYEID_KEY_RSA = 0x11,
-               SC_CARDCTL_MYEID_KEY_EC  = 0x22
+               SC_CARDCTL_MYEID_KEY_EC  = 0x23
        };

        struct sc_cardctl_myeid_data_obj {</pre>
</div></div>
<div class="paragraph"><p>After generating secp256k1 key, recompile opencs with original
libopensc/cardctl.h, and load/generate rest of normal (NIST) EC keys, RSA
keys etc.</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendixI">Appendix I: Random generator implementation</h2>
<div class="sectionbody">
<div class="paragraph"><p>Both  implementations (ATmega128  and xmega) use similar and very simple
random number generator.  There is no seed, no hash function, no reseed
function.</p></div>
<div class="paragraph"><p>Xmega uses 12 bit ADC to measure internal temperature sensor (to internal
band gap reference).  Only bit 0 from ADC conversion is used as entropy
value.</p></div>
<div class="paragraph"><p>Generator tests by <strong>ent</strong> software from <a href="http://www.fourmilab.ch/random/">http://www.fourmilab.ch/random/</a> (This
tests are made with small data blocks, random generator quality is here well
demonstrated - RSA key generation and ECC cryptography uses small data
blocks)</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>File parsed as the bit stream:
==============================
Entropy = 1.000000 bits per bit.

Optimum compression would reduce the size
of this 83264 bit file by 0 percent.

Chi square distribution for 83264 samples is 0.04, and randomly
would exceed this value 75.00 percent of the times.

Arithmetic mean value of data bits is 0.5003 (0.5 = random).
Monte Carlo value for Pi is 3.155709343 (error 0.45 percent).
Serial correlation coefficient is -0.000145 (totally uncorrelated = 0.0).

File parsed as the byte stream:
===============================
Entropy = 7.981877 bits per byte.

Optimum compression would reduce the size
of this 10408 byte file by 0 percent.

Chi square distribution for 10408 samples is 258.70, and randomly
would exceed this value 50.00 percent of the times.

Arithmetic mean value of data bytes is 127.4115 (127.5 = random).
Monte Carlo value for Pi is 3.155709343 (error 0.45 percent).
Serial correlation coefficient is 0.001352 (totally uncorrelated = 0.0).</pre>
</div></div>
<div class="paragraph"><p>The result is excellent for such a simple generator.</p></div>
<div class="paragraph"><p>Unfortunately, similar result is not available on atmega with 10 bit ADC.
There is no temperature sensor.  ADC is set to measure input voltage (to
internal band gap reference).  Only bit 0 from ADC conversion is used as
entropy value.</p></div>
<div class="paragraph"><p>Result of this RNG is not good.  Random generator is strongly affected by
input voltage characteristics (this depends on card reader, USB host,
cables, external interference etc..).  For example, in some environments
random generated data are significantly biased - arithmetic mean value over
160 or higher, Monte Carlo value for PI below 0.1, Chi square never exceed
0.01 percent, etc&#8230;  In some other environment RNG data are relatively good,
but still Chi square is wrong.</p></div>
<div class="paragraph"><p>To get better result, DES cipher is used on 16 bytes from ADC random data (8
bytes data, 8 bytes key) and resulting 8 bytes from DES cipher xored with
key are used as return value from RNG.</p></div>
<div style="page-break-after:always"></div>
<div class="paragraph"><p>In next tables results for OsEID token/card and MyEID card can be compared.
(Beware, in this table, result for atmega generator without DES is one of the
good ones /one of the best, but still with very wrong chi square value)</p></div>
<div class="paragraph"><p>Small data set 10408 bytes:</p></div>
<table class="tableblock frame-all grid-all"
style="
width:80%;
">
<col style="width:42%;">
<col style="width:14%;">
<col style="width:14%;">
<col style="width:14%;">
<col style="width:14%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >                         </th>
<th class="tableblock halign-left valign-top" >xmega      </th>
<th class="tableblock halign-left valign-top" > atmega    </th>
<th class="tableblock halign-left valign-top" > atmega+DES </th>
<th class="tableblock halign-left valign-top" >MyEID 3.3.3</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Entropy per bit</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1.000000</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.999766</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.999993</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.999997</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Entropy per byte</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">7.981877</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">7.781246</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">7.982590</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">7.982021</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Chi square (bit stream)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">75.00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.01</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">50.00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">54.64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Chi square (byte stream)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">50.00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.01</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">50.00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">38.19</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Arithmetic mean (bit)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.5003</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.5090</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.5016</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.5010</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Arithmetic mean (byte)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">127.4115</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">123.8805</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">128.1469</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">127.4539</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Serial correlation (bit)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">-0.000145</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.111164</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.004077</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.000332</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Serial correlation (byte)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.001352</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.046713</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">-0.009899</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.005033</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Monte Carlo value for Pi</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.155709343</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.158016148</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.106751298</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.111367571</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Big data set (about 100 MBytes):</p></div>
<table class="tableblock frame-all grid-all"
style="
width:80%;
">
<col style="width:33%;">
<col style="width:33%;">
<col style="width:33%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >                         </th>
<th class="tableblock halign-left valign-top" >xmega      </th>
<th class="tableblock halign-left valign-top" > atmega+DES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Entropy per bit</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1.000000</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1.000000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Entropy per byte</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">7.999998</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">7.999998</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Chi square (bit stream)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">41.54</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">78.08</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Chi square (byte stream)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">41.47</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">23.43</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Arithmetic mean (bit)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.5000</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.5000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Arithmetic mean (byte)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">127.5091</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">127.4966</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Serial correlation (bit)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.000010</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.000017</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Serial correlation (byte)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">-0.000078</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">-0.000194</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Monte Carlo value for Pi</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.140210247</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.141706616</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>More tests with big data sets (100MB) were made by <strong>dieharder</strong> software
(<a href="http://www.phy.duke.edu/~rgb/General/dieharder.php">http://www.phy.duke.edu/~rgb/General/dieharder.php</a>).</p></div>
<div class="paragraph"><p>(In doc directory you can found output from <strong>dieharder</strong> software for card and token
RNG.)</p></div>
<div class="sect2">
<h3 id="_random_generator_speed">Random generator speed</h3>
<div class="paragraph"><p>Speed measurement is only approximate, speed depend on card reader, 3.8MHz reader was used.
USB utilization  also have an impact on speed tests.</p></div>
<table class="tableblock frame-all grid-all"
style="
width:80%;
">
<col style="width:42%;">
<col style="width:14%;">
<col style="width:14%;">
<col style="width:14%;">
<col style="width:14%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >                  </th>
<th class="tableblock halign-left valign-top" > xmega        </th>
<th class="tableblock halign-left valign-top" > atmega       </th>
<th class="tableblock halign-left valign-top" > atmega+DES   </th>
<th class="tableblock halign-left valign-top" > MyEID 3.3.3</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">240 bytes in APDU</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4661 bytes/sec</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1346 bytes/sec</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">640 bytes/sec</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2670 bytes/sec</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">32 bytes in APDU</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">750 bytes/sec</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">340 bytes/sec</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">225 bytes/sec</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">340 bytes/sec</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Note: OsEID card uses T0 protocol, MyEID and OsEID token use T1 protocol.</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendixJ">Appendix J: Card simulator</h2>
<div class="sectionbody">
<div class="paragraph"><p>All card functions can be tested without any hardware.  Card simulation is
then running as one task in OS.  Simulation is attached to pseudoterminal.
This pseudoterminal is then connected to simulated card reader, and this
reader is attached to <strong>pcscd</strong>.  Simulation creates one file <strong>card_mem</strong>,
where it maintains the FLASH and EEPROM memory of card.</p></div>
<div class="paragraph"><p>For now, this simulator must run with <strong>root privileges</strong>.  <strong>Consider this before
running</strong> this on your computer.  You need <strong>socat</strong> package to run simulation.
This simulation is tested on DEBIAN 9.1 system.</p></div>
<div class="paragraph"><p>Steps to use:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>1. Unpack OsEID tarball
2. cd src
3. make -f Makefile.console
4. su / sudo to get root
5. systemctl stop pcscd.socket
6. systemctl stop pcscd.service
7. build/console/run_pcscd.sh
8. switch to another window/console
9. pcsc_scan</pre>
</div></div>
<div class="paragraph"><p>If card is available, You can use <strong>OsEID-tool</strong> to test functionality of card
(OsEID-tool is in tool directory included in tarball)</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>./OsEID-tool INIT
./OsEID-tool RSA-CREATE-KEYS
./OsEID-tool RSA-UPLOAD-KEYS
pkcs15-tool -D
./OsEID-tool RSA-DECRYPT-TEST</pre>
</div></div>
<div class="paragraph"><p><strong>WARNING!</strong> all other readers in system are available to <strong>pcscd</strong> too, please
disconnect all other readers  or remove another cards from reader to
prevent unwanted modification of your real card.</p></div>
<div class="paragraph"><p>Better (but slower) simulation uses <strong>simulavr</strong>. This allow us to test card
functionality inclusive ASM routines for AVR, measuring speed of procedures
and debugging card function in native AVR instructions. Please read
<strong>targets/simulavr/Readme</strong> from OsEID tarball.</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
<div class="sect1">
<h2 id="appendixK">Appendix K: DES and AES implementation</h2>
<div class="sectionbody">
<div class="paragraph"><p>Both ciphers are optimized to minimal flash size.  Of course, the code is
written in assembler, but C version is available to.  Both ciphers are
optimized to run on 8 bit AVR microcontroller.  Xmega microcontroller
already contains DES instruction, but due absence of this instruction in
atmega, both microcontrollers uses same code (without special DES
instructions).  Xmega contains accelerated engine for 128 bit AES.  This is
not used for the same reason - atmega does not contain this accelerator.
Limiting AES to 128 bit is another reason to do not use xmega accelerator.</p></div>
<div class="paragraph"><p>Both ciphers are designed to run in constant time (time does not depend on
message or key bits).  Timing attack is protected, but differential power
attack is not protected.  (similar problem is in XMEGA accelerated engine:
<a href="https://www.cryptolux.org/images/7/7b/Xmegarump.pdf">https://www.cryptolux.org/images/7/7b/Xmegarump.pdf</a>,
<a href="https://wiki.newae.com/Tutorial_A6_Replication_of_Ilya_Kizhvatov%27s_XMEGA%C2%AE_Attack">https://wiki.newae.com/Tutorial_A6_Replication_of_Ilya_Kizhvatov%27s_XMEGA%C2%AE_Attack</a>
or location dependent EM leakage, please search internet for this keywords).</p></div>
<div class="sect2">
<h3 id="_des">DES</h3>
<div class="paragraph"><p>Code is modified, does not use standard permutations as described by DES
original (NIST) description.</p></div>
<div class="paragraph"><p>Message expansion (E), Permuted choice 1 (PC-1) and Permuted choice 2 (PC-2)
are merged into one 56 bit long message expansion.  This expanded message is
directly XORed by plain key.  S-box addresses are selected from result of
XOR operation by table.  S-boxes are merged to one table (256 bytes).</p></div>
<div class="paragraph"><p>Initial and inverse initial permutation is done by procedures.  Key
expansion is in procedure too.  Only the permutation (P) is unchanged.</p></div>
<div class="paragraph"><p>Code is really small, 800 bytes for DES or 828 bytes if 3DES is needed.
Speed about 50 000 clock cycles for DES decipher or encipher.</p></div>
<div class="paragraph"><p>More informations can be found in C and ASM sources.</p></div>
</div>
<div class="sect2">
<h3 id="_aes">AES</h3>
<div class="paragraph"><p>AES supports key sizes 128/192/256 bits.  AES code is extra small, below 600
bytes.  S-BOX is calculated into RAM.  About 800 bytes of RAM is needed (for
S-box, inverse S-box and expanded key).  Code is compact, does not use
context and therefore the S-box must be calculated repeatedly for every run
of AES.  Speed is sufficient, about 40 000 clock cycles for one AES encipher
or decipher with 256 bit key.</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendixL">Appendix L: Application setup</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_openvpn">openvpn</h3>
<div class="paragraph"><p>Insert path to pkcs11 library into openvpn config file:</p></div>
<div class="paragraph"><p>pkcs11-providers /usr/lib/x86_64-linux-gnu/opensc-pkcs11.so</p></div>
<div class="paragraph"><p>Determine serialized ID of your card/token:</p></div>
<div class="paragraph"><p>openvpn --show-pkcs11-ids /usr/lib/x86_64-linux-gnu/onepin-opensc-pkcs11.so</p></div>
<div class="paragraph"><p>Copy <em>Serialized id</em> from previous command output, and insert this into your
openvpn config file:</p></div>
<div class="paragraph"><p>pkcs11-id ' --- here serialized id&#8201;&#8212;&#8201;'</p></div>
</div>
<div class="sect2">
<h3 id="_openssh">openssh</h3>
<div class="paragraph"><p>Insert path to pkcs11 library into <em>.ssh/config</em> file:</p></div>
<div class="paragraph"><p>PKCS11Provider /usr/lib/x86_64-linux-gnu/opensc-pkcs11.so</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendixM">Appendix M: RSA calculation in <em>genius</em></h2>
<div class="sectionbody">
<div class="paragraph"><p>This part of doc is only for explanation how RSA cryptosystem works.
Especially, here is explained how message and exponent blinding can be
implemented and how can single error in CRT calculation expose P and Q.</p></div>
<div class="paragraph"><p>To run calculation from this appendix, please use <em>genius</em>  calculator
available from <a href="http://www.jirka.org/genius.html">http://www.jirka.org/genius.html</a>.  Code from this appendix
can be pasted directly into <em>genius</em> console. To track calculation, do
not paste whole code at once, code is divided by lines with asteriskses,
paste only partial code and check results in <em>genius</em> console.</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre># This is part of OsEID project documentation,
# https://sourceforge.net/projects/oseid/
.
#
#
# key calculation: choice prime numbers p,q, calculate totient
# ------------------------------------------------------------
.
p = 251
q = 337
totient = (p - 1) * (q - 1)

# choice public exponent
# most commonly used public exponent is 65537
# --------------------------------------------------------
.
pub_exp = 65537

# calculate private exponent
# --------------------------
.

priv_exp = pub_exp ^ -1 mod totient
# calculate n
n = p * q

# calculate  CRT components
# ------------------------
.
dP = (pub_exp^-1) mod (p-1)
dQ = (pub_exp^-1) mod (q-1)
qInv = q ^ -1  mod p

# encipher and decipher
# ---------------------
.
msg = 41444
ciphertext = msg ^ pub_exp mod n
plaintext = ciphertext ^ priv_exp mod n

#
# if calculation is correct, plaintext is 41444
# *****************************************************************
.

# decipher with message blinding
# ------------------------------
.
blind_msg_rnd = 54       # random number

blind_cipher_msg_rnd = blind_msg_rnd ^ pub_exp mod n
blind_cipher         = blind_cipher_msg_rnd * ciphertext mod n
blind_plain          = blind_cipher ^ priv_exp mod n

blind_msg_rnd_inv = blind_msg_rnd ^ -1 mod n
plaintext         = blind_msg_rnd_inv * blind_plain mod n

#
# if calculation is correct, plaintext is 41444
# *****************************************************************
.

# decipher with exponent blinding
# -------------------------------
.
blind_exp_rnd = 56      # random number

blind_exp = blind_exp_rnd * totient + priv_exp
plaintext = ciphertext ^ blind_exp mod n

#
# if calculation is correct, plaintext is 41444
# *****************************************************************
.

# CRT decipher
# ------------
.
cipher_m1 =  ciphertext mod p
cipher_m2 =  ciphertext mod q

m1 = cipher_m1 ^ dP mod p
m2 = cipher_m2 ^ dQ mod q
h = qInv * (m1 - m2) mod p
plaintext = m2 + h * q
#
# if calculation is correct, plaintext is 41444
# *****************************************************************
.

# CRT single error explanation:
# -----------------------------
# calculation of m2 fail:
.
m2 = 123
h = qInv * (m1 - m2) mod p
plaintext = m2 + h * q
# failed plaintext is used to reconstruct 'p'
# -------------------------------------------
.
reconstructed_p = gcd (plaintext - msg, n)
reconstructed_q = n / rp
#
# if calculation is correct, 'p' = 251 and 'q' = 337
# message blinding or exponent blinding does not eliminate single error!
# *****************************************************************
.
# CRT decipher with message blinding
# ----------------------------------
cipher_m1 =  ciphertext mod p
cipher_m2 =  ciphertext mod q

blind_msg_rnd = 54     #random number

blind_msg_p = blind_msg_rnd ^ pub_exp mod p
blind_cipher_p = blind_msg_p * cipher_m1
blind_cipher_m1 = blind_cipher_p mod p

blind_msg_q = blind_msg_rnd ^ pub_exp mod q
blind_cipher_q = blind_msg_q * cipher_m2
blind_cipher_m2 = blind_cipher_q mod q

blind_m1 = blind_cipher_m1 ^ dP mod p
blind_m2 = blind_cipher_m2 ^ dQ mod q

blind_inv_msg = blind_msg_rnd ^ -1 mod n

blind_inv_msg_p = blind_inv_msg mod p
m1 = blind_m1 * blind_inv_msg_p mod p

blind_inv_msg_q = blind_inv_msg mod q
m2 = blind_m2 * blind_inv_msg mod q

h = qInv * (m1 - m2) mod p
plaintext = m2 + h * q
#
# if calculation is correct, plaintext is 41444
# *****************************************************************
.

# similar, but unblinding after recombination:
.
h = qInv * (blind_m1 - blind_m2) mod p
plaintext_blindend = blind_m2 + h * q
plaintext = plaintext_blindend * blind_inv_msg mod n

#
# if calculation is correct, plaintext is 41444
# *****************************************************************
.

# CRT decipher with message and exponent blinding
# -----------------------------------------------
cipher_m1 =  ciphertext mod p
cipher_m2 =  ciphertext mod q

blind_msg_rnd = 54

blind_msg_p = blind_msg_rnd ^ pub_exp mod p
blind_cipher_p = blind_msg_p * cipher_m1
blind_cipher_m1 = blind_cipher_p mod p

blind_msg_q = blind_msg_rnd ^ pub_exp mod q
blind_cipher_q = blind_msg_q * cipher_m2
blind_cipher_m2 = blind_cipher_q mod q

blind_dP_rnd = 34
blind_dQ_rnd = 89

blind_dP = dP + blind_dP_rnd * (p -1)
blind_dQ = dQ + blind_dQ_rnd * (q -1)

blind_m1 = blind_cipher_m1 ^ blind_dP mod p
blind_m2 = blind_cipher_m2 ^ blind_dQ mod q

blind_inv_msg = blind_msg_rnd ^ -1 mod n

blind_inv_msg_p = blind_inv_msg mod p
m1 = blind_m1 * blind_inv_msg_p mod p

blind_inv_msg_q = blind_inv_msg mod q
m2 = blind_m2 * blind_inv_msg mod q

h = qInv * (m1 - m2) mod p
plaintext = m2 + h * q
#
# if calculation is correct, plaintext is 41444
# *****************************************************************
.</pre>
</div></div>
<div class="paragraph"><p>Fermat primality test and Miller-Rebin test</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre># use internal test to determine if number is prime
# prime
IsPrime(41051)
# no prime
IsPrime(41053)
# prime
IsPrime(41057)
#
# Carmichael number (no prime, but fails in Fermat test)
IsPrime(41041)
#
# Fermat tests of abowe numbers (result is always 1)
# you can use differenst bases, here 2 is used as base
2^41050 mod 41051
2^41052 mod 41053
2^41056 mod 41057
2^41040 mod 41041
#
# Miller-Rabin test (base 10, one loop)
#
# initialization:
N=41057
E=N-1
D=1
#
# calculate squaring loops
do D=D+1;E=trunc(E/2) while IsOdd(E)!=true
#
# do exponentation (here base 10 is used)
EE = 10^E mod N
if ((EE == 1 or EE == N-1)) then (
        print ("prime candidate")
) else (
        print("squaring");
        while D&gt;0 do (
                D=D-1;
                EE=EE^2 mod N;
                print(EE);
                if(EE==N-1) then (
                        print("prime candidate");
                        break;
                        );
                if(EE==1) then (
                        print ("no prime");
                        break;
                        );
        );
        if(D==0) then print("no prime")
)
# you can repeat this with N=41051,41053,41041 and observe intermediate results</pre>
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="appendixZ">Appendix N: Abbreviations</h2>
<div class="sectionbody">
<div class="paragraph"><p><a id="ATR"></a>   ATR   = Answer to Reset</p></div>
<div class="paragraph"><p><a id="ACL"></a>   ACL   = Access control list</p></div>
<div class="paragraph"><p><a id="AID"></a>   AID   = Application Identifier</p></div>
<div class="paragraph"><p><a id="CCID"></a>  CCID  = chip card interface device</p></div>
<div class="paragraph"><p><a id="Crt"></a>   Crt   = Control Reference Template
          CRT   = Chinese remainder theorem</p></div>
<div class="paragraph"><p><a id="DE"></a>    DE    = Data Element</p></div>
<div class="paragraph"><p><a id="DF"></a>    DF    = Dedicated File</p></div>
<div class="paragraph"><p><a id="EC"></a>    EC    = Elliptic curve (cryptography)</p></div>
<div class="paragraph"><p><a id="ECC"></a>   ECC   = Elliptic curve cryptography</p></div>
<div class="paragraph"><p><a id="ECDSA"></a> ECDSA = Elliptic curve Digital Signature</p></div>
<div class="paragraph"><p><a id="ECDH"></a>  ECDH  = Elliptic curve Diffie-Hellman</p></div>
<div class="paragraph"><p><a id="EF"></a>    EF    = Elementary File</p></div>
<div class="paragraph"><p><a id="FCI"></a>   FCI   = File Control Information</p></div>
<div class="paragraph"><p><a id="FCP"></a>   FCP   = File control parameter</p></div>
<div class="paragraph"><p><a id="FMD"></a>   FMD   = File management data</p></div>
<div class="paragraph"><p><a id="MF"></a>    MF    = Master file</p></div>
<div class="paragraph"><p><a id="OID"></a>   OID   = Object Identifier</p></div>
<div class="paragraph"><p><a id="PIN"></a>   PIN   = Personal Identification Number</p></div>
<div class="paragraph"><p><a id="PUK"></a>   PUK   = Personal unlocking key</p></div>
<div class="paragraph"><p><a id="RSA"></a>   RSA   = Rivest, Shamir, Adleman asymmetric cipher</p></div>
<div class="paragraph"><p><a id="SE"></a>    SE    = Security Environment</p></div>
</div>
</div>
</div>
<div id="footnotes"><hr></div>
<div id="footer">
<div id="footer-text">
Last updated
 2019-09-30 09:59:44 CEST
</div>
</div>
</body>
</html>
