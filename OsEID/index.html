<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="AsciiDoc 8.6.9">
<title>OsEID smart card &amp; OsEID token</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


@media screen {
  body {
    max-width: 50em; /* approximately 80 characters wide */
    margin-left: 16em;
  }

  #toc {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    width: 13em;
    padding: 0.5em;
    padding-bottom: 1.5em;
    margin: 0;
    overflow: auto;
    border-right: 3px solid #f8f8f8;
    background-color: white;
  }

  #toc .toclevel1 {
    margin-top: 0.5em;
  }

  #toc .toclevel2 {
    margin-top: 0.25em;
    display: list-item;
    color: #aaaaaa;
  }

  #toctitle {
    margin-top: 0.5em;
  }
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>OsEID smart card &amp; OsEID token</h1>
<span id="author">Peter Popovec</span><br>
<span id="email" class="monospaced">&lt;<a href="mailto:popovec.peter@gmail.com">popovec.peter@gmail.com</a>&gt;</span><br>
<span id="revdate">Wed Jan  2 10:08:18 CET 2019</span>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>Copyright &#169; 2015-2018 Peter Popovec &lt;<a href="mailto:popovec.peter@gmail.com">popovec.peter@gmail.com</a>&gt;</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph"><p>OsEID is amateur/hobby smart card with RSA and EC cryptography support. It
is designed on low cost and easily accessible microcontroller Atmel ATmega
128 or ATmega 128A. Alternative hardware uses atmega 1284 microcontroller.</p></div>
<div class="paragraph"><p><span class="image">
<img src="images/card_3x.png" alt="OsEID">
</span></p></div>
<div class="paragraph"><p>OsEID token is amateur/hobby USB token based on Atmel xmega128a4u
microcontroller.  This projects implements USB reader (CCID class) with
built in OsEID card.</p></div>
<div class="imageblock">
<div class="content">
<img src="images/token2.png" alt="OeEID-token">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_project_website">Project website</h2>
<div class="sectionbody">
<div class="paragraph"><p>OsEID projects releases can be found at  at <a href="https://oseid.sourceforge.io">https://oseid.sourceforge.io</a> or <a href="https://sourceforge.net/projects/oseid/">https://sourceforge.net/projects/oseid/</a></p></div>
<div class="sect2">
<h3 id="_features">Features</h3>
<div class="ulist"><ul>
<li>
<p>
Open source code (ASM and C)
</p>
</li>
<li>
<p>
OsEID card  - simple mechanical construction, only one integrated circuit!
</p>
</li>
<li>
<p>
OsEID token - single sided PCB, only 15 components
</p>
</li>
<li>
<p>
Based on easily accessible microcontroller Atmel ATmega 128A / xmega128A4U
</p>
</li>
<li>
<p>
ISO 7816 compatible
  note:[Not all ISO specifications are respected, for example, card thickness cannot be accomplished.]
</p>
</li>
<li>
<p>
Support for pkcs#15 structure
</p>
</li>
<li>
<p>
RSA cryptography with side channel attack protection (key size 512 up to 2048 bits)
</p>
<div class="ulist"><ul>
<li>
<p>
onboard key generation
</p>
</li>
</ul></div>
</li>
<li>
<p>
Elliptic cryptography with side channel attack protection
</p>
<div class="ulist"><ul>
<li>
<p>
ECDSA operation
</p>
</li>
<li>
<p>
ECDH operation
</p>
</li>
<li>
<p>
onboard key generation
</p>
</li>
<li>
<p>
nistp192/prime192v1/secp192r1 OID 1.2.840.10045.3.1.1
</p>
</li>
<li>
<p>
nistp256/prime256v1/secp256r1 OID 1.2.840.10045.3.1.7
</p>
</li>
<li>
<p>
secp384r1 OID 1.3.132.0.34
</p>
</li>
<li>
<p>
secp521r1 OID 1.3.132.0.35
</p>
</li>
<li>
<p>
secp256k1 OID1.3.132.0.10, experimental support, opensc patch required
</p>
</li>
</ul></div>
</li>
<li>
<p>
symmetric cryptography: DES, 3DES, AES128, AES192, AES256
</p>
</li>
<li>
<p>
Onboard random number generator
</p>
</li>
<li>
<p>
PIN / PUK controlled access to files on card
</p>
</li>
<li>
<p>
64 kbyte file space (for keys /certificates etc.)
</p>
</li>
<li>
<p>
auto size DF
</p>
</li>
<li>
<p>
Supported in Linux/Windows by opensc package - MyEID driver
</p>
</li>
<li>
<p>
OsEID card: Communication speed 161290 bits/s for 5MHz readers
</p>
</li>
<li>
<p>
OsEID token: no special card reader driver needed for Linux/WIN/MAC
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_drawbacks">Drawbacks</h3>
<div class="ulist"><ul>
<li>
<p>
No Warranty, use at your own risk.
</p>
</li>
<li>
<p>
Insufficient doc (only this html/pdf file and comments in sources)
</p>
</li>
<li>
<p>
It is not possible to buy it, you have to make it.
</p>
</li>
<li>
<p>
card - only T0 protocol, T1 available only in token/simulator
</p>
</li>
<li>
<p>
RSA operations slow (depends on ATmega RC oscillator, usually max about 13.5MHz)
</p>
<div class="ulist"><ul>
<li>
<p>
about 26.4 seconds for 2048 bit key / token about 12 seconds,
</p>
</li>
<li>
<p>
about 12.7 seconds for 1536 bit key / token about 6 seconds,
</p>
</li>
<li>
<p>
about 4.2  seconds for 1024 bit key / token about 2 seconds,
</p>
</li>
<li>
<p>
about 2.5  seconds for 768 and 512 bit keys / token about 1 second
</p>
</li>
</ul></div>
</li>
<li>
<p>
EC operations slow ECDSA operation timing:
</p>
<div class="ulist"><ul>
<li>
<p>
secp521r1  11 seconds  / token about 5 seconds
</p>
</li>
<li>
<p>
secp384r1  5.9 seconds / token about 2.5 seconds
</p>
</li>
<li>
<p>
prime256v1 2.7 seconds / token about 1.5 seconds
</p>
</li>
<li>
<p>
prime192v1 1.1 second / token about 0.5 seconds
</p>
</li>
<li>
<p>
secp256k1  3.6 seconds / token about 2 seconds
</p>
</li>
</ul></div>
</li>
<li>
<p>
not perfect constant time EC operations
</p>
</li>
<li>
<p>
OsEID card - ESD (electrostatic discharge) protection implemented only on token
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_oseid_myeid_differences">OsEID - MyEID differences</h3>
<div class="paragraph"><p>OsEID tries to support all features which are available in commercial card
<a href="#MyEID">[MyEID]</a>.  Thanks to that, no special software/drivers is needed for
commonly used operating systems.  For Windows, Linux and Mac OS opensource
project <a href="#OpenSC">[OpenSC]</a> can be used as driver for OsEID card.</p></div>
<div class="paragraph"><p>OsEID disadvantages to MyEID card (mechanical)</p></div>
<div class="ulist"><ul>
<li>
<p>
no SIM version of card
</p>
</li>
<li>
<p>
mechanical construction - big, not compact as one plastic card
</p>
</li>
</ul></div>
<div class="paragraph"><p>OsEID disadvantages to MyEID card applet version 4.X:</p></div>
<div class="paragraph"><p>(These functionalities are not supported by MyEID driver in opensc up to
0.18, perhaps OsEID will support these functions in future)</p></div>
<div class="ulist"><ul>
<li>
<p>
RSA - only value 65537 is allowed as public exponent
</p>
</li>
<li>
<p>
experimental support for symmetric encrypt/decrypt - DES and AES
</p>
</li>
<li>
<p>
experimental challenge response PIN
</p>
</li>
<li>
<p>
experimental Admin state and Global unblocker state
</p>
</li>
<li>
<p>
no PIV/CIV emulation
</p>
</li>
<li>
<p>
no Auto size files (only auto size DF)
</p>
</li>
<li>
<p>
no 224 bit NIST curve
</p>
</li>
<li>
<p>
slow RSA
</p>
</li>
<li>
<p>
slow ECC
</p>
</li>
</ul></div>
<div class="paragraph"><p>(experimental = feature is supported by OsEID card, but original MyEID
card function can work differently. There is no enough information in
MyEID applet reference manual 2.1.4 and no opensc implementation to test
all functions.</p></div>
<div class="paragraph"><p>OsEID disadvantages to MyEID card, applet version below 3.5:</p></div>
<div class="paragraph"><p>(MyEID in version below 3.5 does not support EC cryptography)</p></div>
<div class="ulist"><ul>
<li>
<p>
slow RSA
</p>
</li>
</ul></div>
<div class="paragraph"><p>For a comparison, here is table showing the execution time of RSA decrypt
operation (time in seconds) for MyEID (3.3.3), OsEID and OsEID with exponent
blinding turned on:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>pkcs11-tool --decrypt --slot 1 -m RSA-PKCS ..</pre>
</div></div>
<table class="tableblock frame-all grid-all"
style="
width:80%;
">
<col style="width:37%;">
<col style="width:12%;">
<col style="width:12%;">
<col style="width:12%;">
<col style="width:12%;">
<col style="width:12%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >  key size               </th>
<th class="tableblock halign-left valign-top" > 512 </th>
<th class="tableblock halign-left valign-top" > 768 </th>
<th class="tableblock halign-left valign-top" > 1024 </th>
<th class="tableblock halign-left valign-top" > 1536 </th>
<th class="tableblock halign-left valign-top" > 2048</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">MyEID (3.3.3)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.6</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">OsEID card</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2.8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5.3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">13.3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">25.9</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">OsEID card (blinding on)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.7</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5.7</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">13.8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">26.7</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">OsEID token</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1.8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1.8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2.5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">6.0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">11.8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">OsEID token (blinding on)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1.8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1.8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2.5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">6.2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">12.1</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Times in this table are higher then times given in Features section, because
here the time of all operations that opensc runs on card is indicated, e.g. card
identification, reading PKCS#15 files, reading public key.</p></div>
<div class="paragraph"><p>MyEID card seems to be slower in filesystem operations, listing all card
objects by <strong>pkcs15-tool -D</strong> command run in 2.8 second for 5 RSA keys on card.
OsEID runs the same command, the same set of keys in 1.9 second.</p></div>
<div class="paragraph"><p>Time depends on card reader too.  Both cards allow the same communication speed -
161290 bits/s for 5MHz readers, for tests 3.7MHz reader was used (about
120kbit/s).</p></div>
<div class="paragraph"><p>OsEID benefits to MyEID card:</p></div>
<div class="ulist"><ul>
<li>
<p>
secp256k1 curve
</p>
</li>
<li>
<p>
open source - can be reprogrammed for different usage
</p>
</li>
<li>
<p>
for people who don&#8217;t trust commercial solutions because of backdoors
</p>
</li>
<li>
<p>
for people who are happy to make a card by themselves
</p>
</li>
<li>
<p>
card and reader simulation (without real card/reader)
</p>
</li>
<li>
<p>
AES192 (MyEID reference manual 2.1.4 documents only AES128 and AES256)
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_disclaimer">Disclaimer</h3>
<div class="paragraph"><p>Whole project is published in good faith and is to be used for educational
purposes only, however, amateur/hobby usage is also possible.  When you
decide to use this project in other way, keep in mind all drawbacks.
Particularly take care that the card may be damaged and you may lose access
to devices, that need authentication with card.  Please, consider creating
backup card/backup access for this situation.  AUTHOR IS NOT RESPONSIBLE FOR
ANY DAMAGE OF CARD READERS, COMPUTER EQUIPMENTS OR DATA LOSS/DATA LEAKAGE!
USE AT YOUR OWN RISK ONLY! Please read information about RSA and ECC
security in this manual.</p></div>
</div>
<div class="sect2">
<h3 id="_code_license">Code LICENSE</h3>
<div class="paragraph"><p>Code is licensed by GNU GENERAL PUBLIC LICENSE Version 3, 29 June 2007.
Please read Licence.txt in code root directory. <a href="#GPL">[GPL]</a></p></div>
<div class="paragraph"><p>128,192 and 256 bit multiplication source files were originally public
domain (Authors: Michael Hutter and Peter Schwabe, Version: 2014-07-25,
downloaded from <a href="http://mhutter.org/research/avr/">http://mhutter.org/research/avr/</a> ), but have been modified
for OsEID project (to allow run this code in interrupt enabled environment,
and to improve speed). I decided to release this modified version under the
GPL.</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_making_oseid_card">Making OsEID card</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_mechanical_construction">Mechanical construction</h3>
<div class="sect3">
<h4 id="_card_components">Card components</h4>
<div class="paragraph"><p>Card is a composition of two components. First component is ATmega 128
microcontroller or ATmega 128A microcontroller.</p></div>
<div class="paragraph"><p><span class="image">
<img src="images/atmega128A_small.png" alt="Atmega128A">
</span></p></div>
<div class="paragraph"><p>ATmega 128A microcontroller is available with a number of vendors.  You can
buy ATMEGA128A-AU in TQFP64 package from <a href="http://www.farnell.com">http://www.farnell.com</a> by sale code
1773397 (about 4.8E / Dec 31 2017).  Alternatively you can buy ATMEGA128A-AU from
<a href="https://www.tme.eu/en/details/atmega128a-au/8-bit-avr-family/microchip-atmel/">https://www.tme.eu/en/details/atmega128a-au/8-bit-avr-family/microchip-atmel/</a>
(price about 5.5E / Dec 31 2017).</p></div>
<div class="paragraph"><p>The second component is single sided printed circuit board (PCB) in the form of plastic
payment card.</p></div>
<div class="paragraph"><p><span class="image">
<img src="images/pcb_scan.png" alt="PCB">
</span></p></div>
<div class="paragraph"><p>This board is designed to match card dimensions and card contact pads positions
defined by ISO 7816-1.  PCB also connects microcontroller leads to card
contact pads.  There is no vendor for this PCB, but you can produce this PCB at
your local PCB producer.  Your producer needs gerber file or PDF file or
simple image as a manufacturing data for PCB production.  Please check
download section for these files.  Thickness of PCB must be about 0.8mm to
meet dimensions of card recommended by ISO 7816-1. Picture of PCB is also
included in <a href="#appendixA">appendix A</a>.</p></div>
</div>
<div class="sect3">
<h4 id="_soldering_microcontroller_to_pcb">Soldering microcontroller to PCB</h4>
<div class="paragraph"><p>PCB and microcontroller together form final smartcard. The components are
connected by soldering.  ATmega128A microcontroller is available in TQFP or
QFN/MLF package.  Thickness of QFN/MLF packages is in range 0.8 to 1mm but
soldering this package in amateur condition is very difficult.  Because of
soldering difficulty TQFP package was preferred.</p></div>
<div class="paragraph"><p>Unfortunately, ATmega128A microcontroller in TQFP64 package thickness is
slightly below 1.2mm precisely in range 0.95 to 1.05mm + lead thickness
about 0.05 to 0.15mm.</p></div>
<div class="paragraph"><p>If we solder TQFP package directly on PCB board, we can achieve thickness
slightly below 2mm.  That is not good.  To get minimal thickness of card,
microcontroller is imbedded into printed circuit board.  In the position of
microcontroller there is a rectangular hole created in PCB with dimensions about 15.3x15.3mm.
The body of microcontroller is inserted into this hole.  Then
microcontroller leads are slightly bent upwards and soldered to PCB copper
contacts from opposite side as normally.  This mounting can achieve final
thickness of card about 1.1mm.  Most of card readers deal with this
thickness without problems.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">Be aware that final thickness about 1.1mm violates ISO7816-1
specification, which defines thickness of card to 0.76mm with tolerance
+0.08mm.</td>
</tr></table>
</div>
<div class="paragraph"><p>PCB dimensions must also match ISO 7816-1 specification: width 85.47mm -
85.72mm and height 53.92mm - 54.03mm, and corner radiuses in range 2.88 to
3.48mm.</p></div>
<div class="paragraph"><p>It is assumed that you have plenty of mechanical skills and experience with
soldering surface mounted integrated circuit. Further details
of the mechanical installation are therefore not listed here.</p></div>
<div class="paragraph"><p><span class="image">
<img src="images/imbedding.png" alt="Imbedding TQFP package into PCB">
</span></p></div>
</div>
<div class="sect3">
<h4 id="_pcb_plating_coating">PCB plating / coating</h4>
<div class="paragraph"><p>For amateur use, a common printed circuit board without special surface finish will be sufficient.
Because copper on PCB corrodes on air, sooner or
later, problems arise when using the card.  If you plan to use the card
frequently, it is advisable to use circuit board with gold-plated contact
pads.  An alternative to gold plating is silver plating or nickel plating.
Consult your local printed circuit board producer what plating he offers and
at what price.</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
<div class="sect2">
<h3 id="_programming_microcontroller">Programming microcontroller</h3>
<div class="paragraph"><p>Before using the card, microprocessor must be programmed with card operation
system.  You need hex file <em>card.hex</em> that is available in download section.  To
load hex file into ATmega128 microcontroller, you need atmel programmer tool
with programmer software.  For example, free software can be found at
<a href="http://www.nongnu.org/avrdude/">http://www.nongnu.org/avrdude/</a>. Programmer hardware overview can be found at
<a href="http://www.ladyada.net/learn/avr/programmers.html">http://www.ladyada.net/learn/avr/programmers.html</a>. You can learn more about
programming AVR microcontrollers on internet, a good website to start is
<a href="https://learn.adafruit.com/introducing-trinket/programming-with-avrdude">https://learn.adafruit.com/introducing-trinket/programming-with-avrdude</a>.</p></div>
<div class="paragraph"><p>At this point the familiarity with programming AVR
microcontrollers through ISP is assumed. Your card already includes ISP connector but in
different format as normal Atmel ISP6 or ISP10 connectors. Mapping
microcontroller pins to card contact pads and to standard Atmel ISP6 can be
found in the table below.</p></div>
<table class="tableblock frame-all grid-all"
style="
width:80%;
">
<caption class="title">Table 1. Mapping card / microcontroller / ISP contacts</caption>
<col style="width:33%;">
<col style="width:33%;">
<col style="width:33%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" > CPU pin name</th>
<th class="tableblock halign-left valign-top" >ISO pad name</th>
<th class="tableblock halign-left valign-top" > Atmel ISP name</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">GND</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">GND  C5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">GND    6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Vcc</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Vcc  C1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">VCC    2</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">RESET</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Vpp  C6</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">RESET  5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">PE0/PDI 2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">RST  C2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">MOSI   4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">PE1/PDO</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CLK  C3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">MISO   1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">PB1/SCK</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">I/O  C7</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">SCK    3</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>It is recommended to make simple adapter from AVR ISP6 connector to CARD
contact pads.  You need a smart card connector and a ribbon cable with
IDC connector with 6 pins. Alternatively, if your programmer already
contains ribbon cable with 6 pin female IDC connector, you need 6 pin male
IDC connector.</p></div>
<div class="imageblock">
<div class="content">
<img src="images/adapter1.jpg" alt="programming adapter">
</div>
</div>
<div class="paragraph"><p>You can buy it from here:</p></div>
<div class="paragraph"><p><a href="http://www.tme.eu/en/details/116b-dboa-r/card-connectors/attend/116b-dbo0-r02/">http://www.tme.eu/en/details/116b-dboa-r/card-connectors/attend/116b-dbo0-r02/</a>
<a href="http://www.tme.eu/en/details/fc06150-s/ribbon-cables-with-idc-connectors/amphenol/">http://www.tme.eu/en/details/fc06150-s/ribbon-cables-with-idc-connectors/amphenol/</a>
<a href="http://www.tme.eu/en/details/09185066324/idc-connectors/harting/">http://www.tme.eu/en/details/09185066324/idc-connectors/harting/</a></p></div>
<div class="paragraph"><p>Carefully connect the cable to the relevant contact pads of smart card
connector.  Connect this adapter to AVR programmer, insert new card into
smart card connector and you can upload firmware into your card.</p></div>
<div class="paragraph"><p>It is recommended to program microcontroller fuses first:</p></div>
<div class="paragraph"><p>Extended fuses:  0xFF<br>
High fuses:      0xD9<br>
Low fuses:       0x04<br></p></div>
<div class="paragraph"><p>Then upload card.hex and at last step is programming lock bits:</p></div>
<div class="paragraph"><p>Lock bits:       0xFC<br></p></div>
<div class="paragraph"><p>Example for <strong>avrdude</strong> and <strong>avrispmkII</strong> programmer:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ avrdude -p m128 -c avrispmkII -v -U efuse:w:0xFF:m
$ avrdude -p m128 -c avrispmkII -v -U hfuse:w:0xD9:m
$ avrdude -p m128 -c avrispmkII -v -U lfuse:w:0x04:m
$ avrdude -p m128 -c avrispmkII -v -U flash:w:download/OsEID_card.hex
$ avrdude -p m128 -c avrispmkII -v -U lock:w:0xFC:m</pre>
</div></div>
<div class="paragraph"><p>Your card is ready for use now.</p></div>
</div>
<div class="sect2">
<h3 id="_compiling_from_sources">Compiling from sources</h3>
<div class="paragraph"><p>You can use source files to build card.hex.  Development is tested on DEBIAN
9.1.  You need <strong>gcc-avr</strong>, <strong>binutils-avr</strong>, <strong>avr-libc</strong>, <strong>make</strong>, <strong>srecord</strong> and
<strong>avrdude</strong> package.  You need to unpack OsEID tarball.  Makefiles located in <strong>src</strong> subdirectory
are used to compile and program the card.  Card serial number
is automatically generated from actual time/date.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>make -f Makefile.atmega128
make -f Makefile.atmega128 fuses
make -f Makefile.atmega128 program
make -f Makefile.atmega128 lock</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_vpp_pad">Vpp pad</h3>
<div class="paragraph"><p>In year 2006, the standard ISO 7816 changed the definition of <strong>Vpp</strong> pad.
This pad is no longer used for programming voltage.  If you use newer reader
(produced after 2006), card may work, or fail in this reader.  If your OsEID
card does not working in your card reader, Vpp pad of card pad must be isolated
from reader.  This can be done by stick self-adhesive tape on Vpp pad.</p></div>
</div>
<div class="sect2">
<h3 id="_building_oseid_token">Building OsEID-token</h3>
<div class="paragraph"><p>Only partial information here, schematics, PCB and list of components is in
Appendix D.  It is assumed that only a skilled technician will try to
build this device.</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_oseid_card">Using OsEID card</h2>
<div class="sectionbody">
<div class="paragraph"><p>For linux users: download and install <strong>opensc</strong> package.  Please use opensc
version 0.16, 0.17, 0.18 or 0.19.  Debian (stretch) already contains the
<strong>opensc</strong> version 0.16.  If you need ECC, please use version 0.19 from Debian
Buster, or compile version 0.19 from sources.  For other distros, please
follow distro specific installation of opensc package.  Download and install
<strong>pcscd</strong> package.  According to your card reader, you will need to install
specific driver for your reader (for example <strong>libccid</strong> or <strong>libacr38u</strong>
package, ..  )</p></div>
<div class="paragraph"><p>Windows users: download and install opensc 0.17.  (version 0.18,0.19 is only
partially tested, please read comments about minidriver configuration below)</p></div>
<div class="sect2">
<h3 id="_base_functionality">Base functionality</h3>
<div class="paragraph"><p>The fastest way to test the functionality of the card is by launching program
<strong>pcsc_scan</strong> :</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>$ pcsc_scan
PC/SC device scanner
V 1.4.23 (c) 2001-2011, Ludovic Rousseau &lt;ludovic.rousseau@free.fr&gt;
Compiled with PC/SC lite version: 1.8.11
Using reader plug'n play mechanism
Scanning present readers...
0: Alcor Micro AU9540 00 00

Thu Dec 29 09:22:26 2016
Reader 0: Alcor Micro AU9540 00 00
  Card state: Card removed,</pre>
</div></div>
<div class="paragraph"><p>Insert card into reader. If the card is recognized, similar message is
displayed:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>Wed Jan  4 14:21:01 2017
Reader 0: Alcor Micro AU9540 00 00
  Card state: Card inserted,
  ATR: 3B F5 18 00 02 10 80 4F 73 45 49 44

ATR: 3B F5 18 00 02 10 80 4F 73 45 49 44
+ TS = 3B --&gt; Direct Convention
+ T0 = F5, Y(1): 1111, K: 5 (historical bytes)
  TA(1) = 18 --&gt; Fi=372, Di=12, 31 cycles/ETU
    129032 bits/s at 4 MHz, fMax for Fi = 5 MHz =&gt; 161290 bits/s
  TB(1) = 00 --&gt; VPP is not electrically connected
  TC(1) = 02 --&gt; Extra guard time: 2
  TD(1) = 10 --&gt; Y(i+1) = 0001, Protocol T = 0
-----
  TA(2) = 80 --&gt; Protocol to be used in spec mode: T=0 - Unable to change -
defined by interface bytes
+ Historical bytes: 4F 73 45 49 44
  Category indicator byte: 4F (proprietary format)</pre>
</div></div>
<div class="paragraph"><p>Press CTRL-C break <strong>pcsc_scan</strong> and you can go to configure <strong>opensc</strong> package.</p></div>
<div style="page-break-after:always"></div>
</div>
<div class="sect2">
<h3 id="_opensc_package_configuration">Opensc package configuration</h3>
<div class="paragraph"><p>Configure opensc package: edit <strong>/etc/opensc/opensc.conf</strong></p></div>
<div class="paragraph"><p>or if you use windows <strong>C:\Program Files\OpenSC Project\OpenSC\opensc.conf</strong></p></div>
<div class="paragraph"><p>add new ATR for OsEID card and OsEID token:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>        # OsEID card is handled by myeid driver
        card_atr 3b:f5:00:00:02:10:80:4f:73:45:49:44 {
                atrmask = "ff:ff:00:ff:ff:ff:ff:ff:ff:ff:ff:ff";
                driver = "myeid";
        }
        # OsEID token, T0/T1 protocol
        card_atr 3b:f5:00:00:02:80:01:4f:73:45:49:44:00 {
                atrmask = "ff:ff:00:ff:ff:ff:ff:ff:ff:ff:ff:ff:00"
                driver = "myeid";
        }</pre>
</div></div>
<div class="paragraph"><p>It is recommended that you install oseid profile files into opensc profile
directory (usually /usr/share/opensc/). Profile files for different versions
of opensc can be found in download directory.</p></div>
<div class="paragraph"><p>After this configuration step, you can use <strong>opensc-explorer</strong>, <strong>pkcs15-init</strong>,
<strong>pkcs15-tool</strong>, <strong>pkcs11-tool</strong> and other software to personalize your OsEID card.</p></div>
</div>
<div class="sect2">
<h3 id="_windows_minidriver_configuration">Windows minidriver configuration</h3>
<div class="paragraph"><p>If you plan to use OsEID card in Win 10 (for example in EDGE browser etc.) you
need install <strong>opensc</strong> package (0.17).</p></div>
<div class="paragraph"><p>Opensc version 0.17.0 functionality with OsEID card has been tested in WIN
10 (both 64 and 32 bit versions).  <strong>certutil</strong> command is fully functional
and TLS client auth in <strong>EDGE</strong> browser is working.  Opensc 0.18.0 and 0.19 fails
in EDGE, there is missing PIN dialog.</p></div>
<div class="paragraph"><p>To use OsEID card, You need configure opensc package (add OsEID ATR to
opensc.conf file) and you need update your registry file.  Please use
OsEID.reg file from download section.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Cryptography\Calais\SmartCards\OsEID]
"80000001"="opensc-minidriver.dll"
"ATR"=hex:3b,f5,00,00,02,10,80,4f,73,45,49,44
"ATRmask"=hex:ff,ff,00,ff,ff,ff,ff,ff,ff,ff,ff,ff
"Smart Card Key Storage Provider"="Microsoft Smart Card Key Storage Provider"
"Crypto Provider"="OpenSC CSP"

[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Cryptography\Calais\SmartCards\OsEID-token]
"80000001"="opensc-minidriver.dll"
"ATR"=hex:3b,f5,00,00,02,80,01,4f,73,45,49,44,00
"ATRmask"=hex:ff,ff,00,ff,ff,ff,ff,ff,ff,ff,ff,ff,00
"Smart Card Key Storage Provider"="Microsoft Smart Card Key Storage Provider"
"Crypto Provider"="OpenSC CSP"</pre>
</div></div>
<div class="paragraph"><p>Opensc from version 0.18.0 uses different location of file
opensc-minidriver.dll.  Please correct this in your register file:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>"80000001"="C:\Program Files\OpenSC Project\OpenSC\minidriver\opensc-minidriver.dll"</pre>
</div></div>
<div class="paragraph"><p>For 32 bit opensc version on 64 bit system:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>"80000001"="C:\Program Files (x86)\OpenSC Project\OpenSC\minidriver\opensc-minidriver.dll"</pre>
</div></div>
<div class="paragraph"><p>After personalizing your card, you need to use <strong>certutil -scinfo</strong> command in
windows command prompt to import certificates from card into windows
certificate store. After successful import of certificates, you can browse
personal certificates by <strong>certmgr</strong> and/or <strong>certlm</strong> command.</p></div>
<div style="page-break-after:always"></div>
</div>
<div class="sect2">
<h3 id="_explore_files_on_card">Explore files on card:</h3>
<div class="paragraph"><p>On linux/windows with installed opensc package You can use <strong>opensc-explorer</strong>
to browse files on Your new card:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>$ opensc-explorer
OpenSC Explorer version 0.14.0
Using reader with a card: ACS ACR38U 00 00
OpenSC [3F00]&gt; info

Dedicated File  ID 3F00

File path:     3F00
File size:     32767 bytes
ACL for SELECT:       N/A
ACL for LOCK:         N/A
ACL for DELETE:       CHV3
ACL for CREATE:       CHV3
ACL for REHABILITATE: N/A
ACL for INVALIDATE:   N/A
ACL for LIST FILES:   N/A
ACL for CRYPTO:       N/A
ACL for DELETE SELF:  N/A
Proprietary attributes:  00 02
Security attributes:     33 3F FF</pre>
</div></div>
<div class="paragraph"><p>There exists only one file on card. This is file with ID 3F00 - master file
(MF). Card security system (PIN/PUK codes) are inactive for now.</p></div>
</div>
<div class="sect2">
<h3 id="_card_initialization_creation_of_pkcs15_structure">Card initialization (creation of pkcs15 structure)</h3>
<div class="literalblock">
<div class="content monospaced">
<pre>pkcs15-init -C --so-pin 00000000 --so-puk 00000000 --pin 1111111</pre>
</div></div>
<div class="paragraph"><p>or better way, determine opensc version by running</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>opensc-tool -i</pre>
</div></div>
<div class="paragraph"><p>Then use oseid profile with the same version as opensc (for example 0.17):</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>pkcs15-init -C -c oseid_0.17 --so-pin 00000000 --so-puk 00000000 --pin 1111111</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_init_user_pin_puk">Init user pin/puk</h3>
<div class="literalblock">
<div class="content monospaced">
<pre>pkcs15-init --store-pin --id 01 --pin 11111111 --puk 11111111 --so-pin 00000000</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_finalize_card_activate_card_security_mechanism">Finalize card (activate card security mechanism)</h3>
<div class="literalblock">
<div class="content monospaced">
<pre>pkcs15-init -F</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_generate_rsa_key">Generate RSA key</h3>
<div class="paragraph"><p>(Warning, this operation is really slow, may run about 4 minutes but in some
cases over 30 minutes for 1024 bit key, generating 2048 bit key take about
45 minutes but in some cases several hours.)</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>pkcs15-init --generate-key rsa/1024 --auth-id 1 --pin 11111111 \
  --label gen_rsa_1024 --key-usage sign,decrypt</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_generate_rsa_key_with_openssl_and_upload_rsa_key">Generate RSA key with openssl and upload RSA key</h3>
<div class="literalblock">
<div class="content monospaced">
<pre>openssl genrsa -out 1024-key.pem 1024
pkcs15-init  --store-private-key 1024-key.pem --auth-id=1 --pin 11111111 \
  --key-usage sign,decrypt --id 1234</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_sign_message_with_rsa_key">Sign message with RSA key</h3>
<div class="literalblock">
<div class="content monospaced">
<pre>pkcs11-tool  --sign --slot 0 -m SHA1-RSA-PKCS --id 1234 -pin 11111111 \
  --input-file rsa_sign_testfile.txt --output-file rsa_sign_testfile.txt.sign</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_generate_ec_key_on_card">Generate EC key on card</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">For EC operations you need an opensc version 0.17 or newer version, or
check appendixes for opensc0.16 patch.</td>
</tr></table>
</div>
<div class="literalblock">
<div class="content monospaced">
<pre>pkcs15-init --generate-key ec-prime256v1 --auth-id 1 --pin 11111111</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_generate_key_with_openssl_and_upload_ec_key_certificate_to_card">Generate key with openssl and upload EC key/certificate to card</h3>
<div class="literalblock">
<div class="content monospaced">
<pre>openssl ecparam -name prime256v1 -genkey -noout -out prime256v1-key.pem
pkcs15-init --store-private-key prime256v1-key.pem  --auth-id=1 --pin 11111111

pkcs15-init -X prime256v1-cert.pem --pin 11111111 --auth-id=1</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_sign_with_ec_key">Sign with EC key</h3>
<div class="paragraph"><p>First read possible keys, select proper key id for sign (in example 121212)</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>pkcs15-tool --list-public-keys
pkcs15-crypt --pin 11111111 -k 121212 --signature-format "openssl" -s \
  -i testfile.txt.sha1 -o testfile.txt.pkcs11.sha1.sig</pre>
</div></div>
<div class="paragraph"><p>Another example for sign with EC key:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>pkcs11-tool --sign --signature-format "openssl" --slot 1 -m ECDSA \
  --input-file sign.this.txt --output-file sign.this.txt.signature</pre>
</div></div>
<div style="page-break-after:always"></div>
</div>
<div class="sect2">
<h3 id="_oseid_tool">OsEID-tool</h3>
<div class="paragraph"><p>You can use <strong>OsEID-tool</strong> software (available in tools section, only linux
version).  This software is designed to simplify some tasks on OsEID card
(can be used with MyEID card too).  Implemented functions:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>INFO - print info about card
INIT - do initialization of token by pkcs15-init
EC-CREATE-KEYS - use openssl to generate EC keys
EC-UPLOAD-KEYS - upload EC keys into initialized token
EC-GENERATE-KEYS  - generate keys on card
EC-SIGN-TEST - sign sample text by ECDSA operation and test this signature
EC-ECDH-TEST - generate shared secrets and test shared secrets
RSA-CREATE-KEYS -  use openssl to generate RSA keys
RSA-UPLOAD-KEYS - upload RSA keys into initialized token
RSA-GENERATE-KEYS - generate RSA key on card
RSA-SIGN-TEST - sign sample text with token RSA operation and test this signature
RSA-DECRYPT-TEST - decrypt test data
PKCS11-RSA-TEST - pkcs11-tool full test on RSA keys
CSR [key] [subject] - generate certificate signing request
CRT [key] [subject] - generate self signed certificate
RND-TEST - test random generator entropy</pre>
</div></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_faq">FAQ</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_what_is_oseid">What is OsEID ?</h3>
<div class="paragraph"><p>OsEID is smart card with cryptography support, realized in amateur
conditions.  It consist of one integrated circuit (microcontroller atmel
ATmega 128) and PCB (printed circuit board).  No more components are needed.</p></div>
</div>
<div class="sect2">
<h3 id="_what_can_oseid_handle">What can OsEID handle ?</h3>
<div class="paragraph"><p>OsEID smart card supports both RSA cryptography and Elliptic curve
cryptography.  DES and AES ciphers are supported too.  It is (partially *)
compatible with ISO 7816 specifications.  Card support PKCS15 structure, RSA
up to 2048 bits and NIST elliptic curves (192,256 and 384 bits).</p></div>
<div class="paragraph"><p>It is designed to emulate Aventra MyEID card in universal microcontroller.
No special driver is needed for use in Linux/Windows.</p></div>
</div>
<div class="sect2">
<h3 id="_what_difference_is_between_myeid_and_oseid_card">What difference is between MyEID and OsEID card?</h3>
<div class="paragraph"><p>OsEID is hobby/amateur smart card, MyEID is professional card.  OsEID come
with open source firmware in well known, easily accessible and inexpensive
microcontroller.</p></div>
</div>
<div class="sect2">
<h3 id="_where_do_i_buy_a_card">Where do I buy a card ?</h3>
<div class="paragraph"><p>The card can not be bought, You have to make it. (Read documentation chapter
Making OsEID card)</p></div>
</div>
<div class="sect2">
<h3 id="_where_can_i_find_the_latest_firmware_version">Where can I find the latest firmware version ?</h3>
<div class="paragraph"><p>New versions are published on  <a href="https://sourceforge.net/projects/oseid">https://sourceforge.net/projects/oseid</a>
This is a primary site, code is available in tarball (all sources, firmware
files compiled from sources in HEX format, and PDF version of doc). Same
site can be reached at <a href="https://oseid.sourceforge.io">https://oseid.sourceforge.io</a></p></div>
<div class="paragraph"><p>Some time later, code is available on github <a href="https://github.com/popovec/oseid">https://github.com/popovec/oseid</a>
HTTP online doc is available on <a href="https://popovec.github.io/OsEID">https://popovec.github.io/OsEID</a></p></div>
</div>
<div class="sect2">
<h3 id="_in_what_application_i_can_use_this_smart_card">In what application I can use this smart card ?</h3>
<div class="ulist"><ul>
<li>
<p>
openssh - private rsa key can be stored on card
</p>
</li>
<li>
<p>
Firefox - secure login into web pages
</p>
</li>
<li>
<p>
windows Edge - secure login into web pages (tested with opensc 0.17)
</p>
</li>
<li>
<p>
Thunderbird - sign and decrypt emails
</p>
</li>
<li>
<p>
openvpn - secure login to openvpn server
</p>
</li>
<li>
<p>
easy-rsa - sign certificates by private key on card
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_why_rsa_calculation_is_so_slow">Why RSA calculation is so slow?</h3>
<div class="paragraph"><p>ATmega128 is 8 bit CPU and runs at  low frequency (about 13.5Mhz).
The chip has only 8x8 bit multiplier, no special acceleration units for
RSA and ECC, as it is in the world of commercial cards.</p></div>
</div>
<div class="sect2">
<h3 id="_is_there_a_faster_alternative_to_oseid_card">Is there a faster alternative to OsEID card?</h3>
<div class="paragraph"><p>Yes, you can make OsEID token, but it is more complicated to make it.
A lot of skill with soldering of SMD components is needed. The token is about two
times faster than OsEID card.  Token can run 2048 RSA operation in about 12
seconds.  Overclocked version can run 2048 bit RSA operation in about 8 sec.</p></div>
</div>
<div class="sect2">
<h3 id="_why_oseid_is_denoted_as_beta_software">Why OsEID is denoted as BETA software?</h3>
<div class="paragraph"><p>OsEID card software is in extensive development.  New features are added,
and lot of old code is optimized.  Lot of internal interfaces are changed
from version to version.  Finally, card behavior is tested using (partial)
regression tests.  Through this, nobody can guarantee the flawless function
of such a large system.  It is advisable to leave the BETA tag (for now) on
this project.</p></div>
</div>
<div class="sect2">
<h3 id="_i_found_a_bug_in_oseid_card_where_can_i_report_it">I found a bug in OsEID card, where can I report it ?</h3>
<div class="paragraph"><p>You can contact me (author) by email &lt;<a href="mailto:popovec.peter@gmail.com">popovec.peter@gmail.com</a>&gt;</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_filesystem">Filesystem</h2>
<div class="sectionbody">
<div class="paragraph"><p>Card uses a simple filesystem compatible with ISO7816.  However, the
functions of filesystem do not meet all the requirements defined in ISO7816.
Please, follow the comments on these inconsistencies in the following text.</p></div>
<div class="paragraph"><p>Filesystem is in ATMEGA FLASH.  Security data (PINs, PUKs) are stored in
ATMEGA EEPROM.  Filesystem is organized as simple linear structure, header,
file, header, file&#8230;.  header, file.  Simplicity of filesystem limits file
delete operation.  Delete operation only marks file as deleted.
Deallocation of file space is available only for files at end of filesystem.
There does not exist any CRC data checks or other consistency check in
filesystem.  (Already a BETA version of FLASH friendly COW filesystem
exists, with CRC and other features, but not open source for now.  Because
of the code size it may not be available at all.  The development is
currently frozen.)</p></div>
<div class="paragraph"><p>File size is limited to max 32767 bytes, DF files are always auto sized.  If
DF file is created, only the space for file header is allocated in card.  DF
file does not contain information about children, but children know what DF
is their parent.  There is no limit on number of files on card.  Filesystem
limit is 65536 bytes.  (MyEID uses PUT DATA: INITIALIZE APPLET to set
maximum number of files, this operation is supported, but value is ignored.)</p></div>
<div class="paragraph"><p>The file with ID=3F00 (MF) already exists on a new blank card.  There is no
other file on card.  This is different to MyEID card.  New MyEID card comes
with MF file 3F00 and with DF file 5015. DF 5015 in OsEID card is created
by <strong>opensc</strong> package (pkcs15-init).</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>MyEID (ver 3.3.3)                       OsEID:

OpenSC [3F00]&gt; info                     OpenSC [3F00]&gt; info

Dedicated File  ID 3F00                 Dedicated File  ID 3F00

File path:     3F00                     File path:     3F00
File size:     32767 bytes              File size:     32767 bytes
ACL for SELECT:       N/A               ACL for SELECT:       N/A
ACL for LOCK:         N/A               ACL for LOCK:         N/A
ACL for DELETE:       CHV3              ACL for DELETE:       CHV3
ACL for CREATE:       CHV3              ACL for CREATE:       CHV3
ACL for REHABILITATE: N/A               ACL for REHABILITATE: N/A
ACL for INVALIDATE:   N/A               ACL for INVALIDATE:   N/A
ACL for LIST FILES:   N/A               ACL for LIST FILES:   N/A
ACL for CRYPTO:       N/A               ACL for CRYPTO:       N/A
ACL for DELETE SELF:  N/A               ACL for DELETE SELF:  N/A
Proprietary attributes:  00 02          Proprietary attributes:  00 02
Security attributes:     33 3F FF       Security attributes:     33 3F FF

OpenSC [3F00]&gt; cd 5015                  OpenSC [3F00]&gt; cd 5015
OpenSC [3F00/5015]&gt; info                OpenSC [3F00/5015]&gt; info

Dedicated File  ID 5015                 Dedicated File  ID 5015

File path:     3F00/5015                File path:     3F00/5015
File size:     32767 bytes              File size:     5000 bytes
DF name:     \xA0\x00\x00\x00cPKCS-15   DF name:     \xA0\x00\x00\x00cPKCS-15
ACL for SELECT:       N/A               ACL for SELECT:       N/A
ACL for LOCK:         N/A               ACL for LOCK:         N/A
ACL for DELETE:       NEVR              ACL for DELETE:       CHV1
ACL for CREATE:       CHV3              ACL for CREATE:       CHV1
ACL for REHABILITATE: N/A               ACL for REHABILITATE: N/A
ACL for INVALIDATE:   N/A               ACL for INVALIDATE:   N/A
ACL for LIST FILES:   N/A               ACL for LIST FILES:   N/A
ACL for CRYPTO:       N/A               ACL for CRYPTO:       N/A
ACL for DELETE SELF:  N/A               ACL for DELETE SELF:  N/A
Proprietary attributes:  00 02          Proprietary attributes:  00 00
Security attributes:     33 FF FF       Security attributes:     11 1F FF</pre>
</div></div>
<div class="paragraph"><p>If someone needs the exact same 5015 file as in MyEID card, workaround is
available in <strong>OsEID-tool</strong>, you need only to uncomment APDU, that creates DF
5015 in INIT command.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">hexadecimal values in next text are prefixed by <strong>0x</strong> or suffixed by <strong>h</strong>
for example 0x45 or 45h. In some cases, hexadecimal values are without
prefix/suffix, but it can be deduced from context that this number is
hexadecimal. Sorry about this. This doc is only a draft, not the final version.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">OsEID documentation is still incomplete, please consult MyEID
reference manual 2.1.4, lot of MyEID APDUs are identical with OsEID APDUs.
Do not expect a completely identical functions, keep in mind, OsEID is a hobby
card.</td>
</tr></table>
</div>
<div style="page-break-after:always"></div>
<div class="sect2">
<h3 id="_select_file">SELECT FILE</h3>
<div class="paragraph"><p>Selection mechanism manages current DF and current EF. If EF is selected,
parent DF is set as current DF.</p></div>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1  </th>
<th class="tableblock halign-left valign-top" > P2  </th>
<th class="tableblock halign-left valign-top" > LC </th>
<th class="tableblock halign-left valign-top" > Data </th>
<th class="tableblock halign-left valign-top" > LE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xA4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
</tbody>
</table>
<div class="ulist"><ul>
<li>
<p>
P1 see below
</p>
</li>
<li>
<p>
P2 0 = return FCI of selected file, 0x0c - return status only
</p>
</li>
<li>
<p>
LC see below
</p>
</li>
<li>
<p>
Data  length corresponding to LC
</p>
</li>
<li>
<p>
LE empty
</p>
</li>
</ul></div>
<div class="paragraph"><p>Select file is controlled by P1, P2 parameters. There are several P1, P2
valid combinations. For some of combinations LC != 0 and data field must
contain specific data</p></div>
<div class="ulist"><ul>
<li>
<p>
P1 = 0, P2 == 0, LC = 0:
  Select MF (0x3f00)
</p>
</li>
<li>
<p>
P1 = 3, LC = 0:
  Select parent DF of the current DF
</p>
</li>
<li>
<p>
P1 = 8, LC &gt;=2, LC even, Data represents IDs of path to file:
  Select by path from MF
</p>
</li>
<li>
<p>
P1 = 9, LC &gt;=2, LC even, Data represents IDs of path to file:
  Select by path from selected DF
</p>
</li>
<li>
<p>
P1 = 4, LC &gt;0, LC &lt; 17, Data represents filename:
  Select DF by name
</p>
</li>
<li>
<p>
P1 = 1, LC = 2, Data file ID:
  Select DF
</p>
</li>
<li>
<p>
P1 = 2, LC = 2, Data file ID:
  Select EF
</p>
</li>
<li>
<p>
P1 = 0, P2 = 0, LC = 2, Data = 0x3f00:
  Select MF
</p>
</li>
<li>
<p>
P1 = 0, LC = 2, Data = ID:
  Firstly the file with ID in all children of selected DF is searched, if ID is found,
  FCI/status is returned.  If previous search fails, test if parent of selected
  file matches ID.  If this fails too, file in neighbors of selected
  file is searched.
</p>
</li>
<li>
<p>
P2 = 0x0c - do not return FCI/FCP/FMD
</p>
</li>
</ul></div>
<div class="paragraph"><p>If select command failed, last correctly selected file remains selected.</p></div>
<div class="paragraph"><p>MyEID difference: MyEID (according MyEID reference manual 2.1.4) does not
support values 1,2,3 for P1.  MyEID does not support P2 = 0x0c.</p></div>
<div style="page-break-after:always"></div>
</div>
<div class="sect2">
<h3 id="_create_file">CREATE FILE</h3>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1   </th>
<th class="tableblock halign-left valign-top" > P2   </th>
<th class="tableblock halign-left valign-top" > LC </th>
<th class="tableblock halign-left valign-top" > Data </th>
<th class="tableblock halign-left valign-top" > LE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xE0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
</tbody>
</table>
<div class="ulist"><ul>
<li>
<p>
LC  18 .. 255
</p>
</li>
<li>
<p>
Data - length corresponding to LC
</p>
</li>
<li>
<p>
LE empty
</p>
</li>
</ul></div>
<div class="paragraph"><p>Data must contain File Control Parameters (FCP) information.</p></div>
<div class="paragraph"><div class="title">FCP structure</div><p>First byte (0x62) represents FCP tag, second byte represents sum of length of
all tags in structure. The rest of structure is formed by TLV items. TLV items
order doesn&#8217;t matter. TLV item with the same TAG value overwrites previous item
with the same tag except TAG 0x80 and 0x81, these tags are mutually exclusive and
can not be repeated.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>Value   bytes   description

0x62    1       FCP tag
16..255 1       length of FCP structure

0x80    1       File size TAG (for EF)
1..2    1       length of value
value   1..2    size of file in bytes

0x81    1       File size TAG (for DF and key EF)
2       1       length of value
value   2       size of file in bytes

0x82    1       File description tag
1..6    1       length of value
value   1..6    File description byte(s) check table below

0x83    1       file identifier
2       1       length of value
value   2       File Identifier

0x84    1       DF Name tag    (optional, default none)
1..16   1       length of value
value   1..16   Optional DF name

0x85    1       Proprietary Information (optional, default 0)
2       1       length of value
value   2       check table below

0x86    1       Security Attributes (optional, default 0x000000)
3..16   1       length of value
value   3..16   only first 3 bytes are used, rest of bytes are ignored

0x8A    1       Life Cycle Status (optional, ignored)
1       1       length of value
value   1       check table below</pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">key file size can be specified by tag 0x80.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">DF size is handled in card internally. Size of DF specified by tag 0x81
is only symbolic, card allocates filesystem space for DF dynamically.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">TAG 0x8a (Lifecycle) can be provided in FCP structure, but is ignored by
<strong>CREATE FILE</strong> command</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">Before, between or after BER-TLV data objects, 0x00 or 0xffs without any meaning may occur.</td>
</tr></table>
</div>
<div class="paragraph"><div class="title">File description byte(s)</div><p>only the first byte is used, rest is ignored.</p></div>
<div class="paragraph"><p>allowed values:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>0x01    EF working, transparent structure
0x11    EF proprietary, for RSA key
0x22    EF proprietary, for EC key
0x23    EF proprietary, for EC key secp256k1 Experimental!
0x19    EF proprietary, for DES key
0x29    EF proprietary, for AES key
0x38    DF</pre>
</div></div>
<div class="paragraph"><p>Any value can be orred with value 0x40, this mark file as shareable.</p></div>
<div class="paragraph"><p>BEWARE! filetype 0x23 is not used by original MyEID card. In future, MyEID card may
use the 0x23 filetype to different purposes. OsEID project will then change
secp256k1 key marking to another filetype or move marking into Proprietary
Information field.</p></div>
<div class="listingblock">
<div class="title">File Identifier</div>
<div class="content monospaced">
<pre>reserved: 0x3f00, 0x3fff, 0xffff</pre>
</div></div>
<div class="listingblock">
<div class="title">KEY EF</div>
<div class="content monospaced">
<pre>1st byte:
X0h - not valid key file
X1h - valid key file
X3h - key valid, key generated on card

X = AC to be cleared after RSA operation - due to incomplete information
about this in MyEID documentation, upper nibble is ignored by OsEID card.

If KEY file is created, 1st byte is always masked to X0h.  After successful
upload of private part of EC key or modulus of RSA key or AES/DES key
upload, the 1st byte of proprietary information is changed. Beware, file can be
marked as valid, but not all parts of key are in file.  For EC key this is
no problem if public part is missing, but incomplete RSA key then generates
error in RSA security operation.

2nd byte: 0x00 RFU</pre>
</div></div>
<div class="listingblock">
<div class="title">EF</div>
<div class="content monospaced">
<pre>1st byte: 0x00 RFU
2nd byte: 0x00 RFU</pre>
</div></div>
<div class="listingblock">
<div class="title">DF</div>
<div class="content monospaced">
<pre>1st byte: 0x00 RFU
2nd byte: 0x00 or 0x02 other values RFU
          0x02 = this DF can not be deleted</pre>
</div></div>
<div class="listingblock">
<div class="title">Lifecycle</div>
<div class="content monospaced">
<pre> (card uses only codes 1 and 7)
0       - no info
1*      - creation
3       - initialization
4       - operational (deactivated)
5       - operational (activated)
6       - operational (deactivated)
7*      - operational (activated)</pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">Lifecycle is managed internally (by PUT DATA/initialize applet and ACTIVATE APPLET
commands), value in FCP is ignored</td>
</tr></table>
</div>
<div class="paragraph"><p>You can found more information about key file in PUT DATA and GENERATE
PUBLIC KEY PAIR command.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">opensc versions 0.14 to 0.19 (myeid driver) can handle only limited set of key sizes:
512, 768, 1024, 1536, 2048
<strong>Example apdu</strong></td>
</tr></table>
</div>
<div class="paragraph"><p>Create working EF with transparent structure, ID 2233, size 511, security
attributes set to 01 1F FF:</p></div>
<div class="exampleblock">
<div class="content">
<div class="paragraph"><p>00 e0 00 00 12 62 10 80 02 01 ff 82 01 01 83 02 22 33 86 03 01 1f ff</p></div>
</div></div>
<div class="paragraph"><p><strong>Responses</strong></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>No error</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x9000
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if P1 != 0 or P2 != 0</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6a86 - Incorrect parameters P1-P2
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if LC = 0</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6700 - Incorrect length
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if transport of LC bytes of data fail</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6984 invalid data
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if there is not selected DF</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6a82 - file not found
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>missing FCP template byte (0x62) in 1st position in data</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6984 - invalid data
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>any wrong tag/value in FCP data</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6984 - invalid data
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if DF name already exists</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6A89 - already exists
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>security status (does not allow file creation)</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6982 - security status not satisfied
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>file with same ID already exists in current DF</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6A89 - already exists
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>problem to write file in filesystem</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6985 -  condition not satisfied
</p>
</li>
</ul></div>
</dd>
</dl></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">From ISO 7816-4 <strong>SELECT</strong> APDU with P1 = 0: If P2 is set to 0 and the
command data field provides a file identifier, then that file identifier
shall be unique in the following three environments: the immediate children
of the current DF, the parent DF and the immediate children of the parent
DF. Function <strong>CREATE FILE</strong> allows to create files with same ID in these three
environments. Please check <strong>SELECT</strong> command to find how the file selection is handled.</td>
</tr></table>
</div>
<div style="page-break-after:always"></div>
</div>
<div class="sect2">
<h3 id="_delete_file">DELETE FILE</h3>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1   </th>
<th class="tableblock halign-left valign-top" > P2   </th>
<th class="tableblock halign-left valign-top" > LC  </th>
<th class="tableblock halign-left valign-top" > Data </th>
<th class="tableblock halign-left valign-top" > LE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xE0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
</tbody>
</table>
<div class="ulist"><ul>
<li>
<p>
LC  0
</p>
</li>
<li>
<p>
Data empty
</p>
</li>
<li>
<p>
LE empty
</p>
</li>
</ul></div>
<div class="paragraph"><p>The DELETE FILE command does removing of file. File must be selected by
SELECT command before calling DELETE FILE command. Before deletion of file,
access condition is checked. After file delete operation a parent of deleted
file is selected. (This may change in future!)</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">files are only marked as deleted, and only marked files at end of
filesystem are really deallocated and space is returned to filesystem.
Returned space is filled by value 0xff.</td>
</tr></table>
</div>
<div class="paragraph"><p><strong>Responses</strong></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>No error</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x9000
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if P1 != 0 or P2 != 0</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6a86 - Incorrect parameters P1-P2
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if LC = 0</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6700 - Incorrect length
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if there is not selected file</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6986 command not allowed, (no current EF)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>DF/MF file is marked by proprietary attribute as undeletable</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6985 condition of use not satisfied
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>security status (does not allow file deletion)</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6982 - security status not satisfied
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>DF is not empty</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6985 condition of use not satisfied
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>select of parent failed</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6A82  File not found
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>memory subsystem error</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6581 memory fail
</p>
</li>
</ul></div>
</dd>
</dl></div>
<div style="page-break-after:always"></div>
</div>
<div class="sect2">
<h3 id="_erase_binary">ERASE BINARY</h3>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1 </th>
<th class="tableblock halign-left valign-top" > P2  </th>
<th class="tableblock halign-left valign-top" > LC  </th>
<th class="tableblock halign-left valign-top" > Data </th>
<th class="tableblock halign-left valign-top" > LE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x0E</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
</tbody>
</table>
<div class="ulist"><ul>
<li>
<p>
P1 - in range 0-0x7f
</p>
</li>
<li>
<p>
P2 in range 0-0xff
</p>
</li>
<li>
<p>
LC  empty
</p>
</li>
<li>
<p>
Data empty
</p>
</li>
<li>
<p>
LE empty
</p>
</li>
</ul></div>
<div class="paragraph"><p>The ERASE BINARY command fills selected transparent EF with 0xff value. Start
of fill is selectable by P1, P2 parameters. P1 represent bits 14..8, P2
represent bit 7..0 of offset.</p></div>
<div class="paragraph"><p><strong>Responses</strong></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>No error</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x9000
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if P1,P2 is over 0x7fff</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6a86 - Incorrect parameters P1-P2
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if LC = 0</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6700 - Incorrect length
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if there is not selected file</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6986 command not allowed,(no current EF)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>file is RSA/EC key file or DF</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6985 condition of use not satisfied
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>security status (does not allow file deletion)</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6982 - security status not satisfied
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>offset in P1,P2 is outside EF size</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6B00 outside EF
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>memory subsystem error</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6581 memory fail
</p>
</li>
</ul></div>
</dd>
</dl></div>
<div style="page-break-after:always"></div>
</div>
<div class="sect2">
<h3 id="_update_binary">UPDATE BINARY</h3>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1 </th>
<th class="tableblock halign-left valign-top" > P2  </th>
<th class="tableblock halign-left valign-top" > LC  </th>
<th class="tableblock halign-left valign-top" > Data </th>
<th class="tableblock halign-left valign-top" > LE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xD6</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
</tbody>
</table>
<div class="ulist"><ul>
<li>
<p>
P1 - in range 0-0x7f
</p>
</li>
<li>
<p>
P2 in range 0-0xff
</p>
</li>
<li>
<p>
LC  1..0xff
</p>
</li>
<li>
<p>
Data binary data
</p>
</li>
<li>
<p>
LE empty
</p>
</li>
</ul></div>
<div class="paragraph"><p>The UPDATE BINARY command updates data in selected transparent EF. Start
of update is selectable by P1, P2 parameters. P1 represents bits 14..8, P2
represents bit 7..0 of offset. LC represents number of updated bytes.</p></div>
<div class="paragraph"><p><strong>Responses</strong></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>No error</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
61 xx - xx of data bytes are available (for GET RESPONSE COMMAND)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if P1,P2 is over 0x7fff</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6a86 - Incorrect parameters P1-P2
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if LE = 0</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6700 - Incorrect length
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if transport of LC bytes of data fail</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6984 invalid data
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if there is not selected file</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6986 command not allowed,(no current EF)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>file is RSA/EC/DES/AES key file or DF</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6985 condition of use not satisfied
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>security status (does not allow file update)</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6982 - security status not satisfied
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>offset in P1,P2 is outside EF size</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6b00 end of size before LE
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>memory subsystem error</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6581 memory fail
</p>
</li>
</ul></div>
</dd>
</dl></div>
<div style="page-break-after:always"></div>
</div>
<div class="sect2">
<h3 id="_read_binary">READ BINARY</h3>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1 </th>
<th class="tableblock halign-left valign-top" > P2  </th>
<th class="tableblock halign-left valign-top" > LC  </th>
<th class="tableblock halign-left valign-top" > Data </th>
<th class="tableblock halign-left valign-top" > LE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xB0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
</tbody>
</table>
<div class="ulist"><ul>
<li>
<p>
P1 - in range 0-0x7f
</p>
</li>
<li>
<p>
P2 in range 0-0xff
</p>
</li>
<li>
<p>
LC  empty
</p>
</li>
<li>
<p>
Data empty
</p>
</li>
<li>
<p>
LE Number of bytes to read.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The READ BINARY command reads data from selected transparent EF (file type
0x01).  Start of read is selectable by P1, P2 parameters.  P1 represents bits
14..8, P2 represents bits 7..0 of offset.  For LE=0, 256 bytes are to be read;</p></div>
<div class="paragraph"><p><strong>Responses</strong></p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>No error</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
61 xx - xx of data bytes are available (for GET RESPONSE COMMAND)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if P1,P2 is over 0x7fff</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6a86 - Incorrect parameters P1-P2
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if LE = 0</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6700 - Incorrect length
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if there is not selected file</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6986 command not allowed, (no current EF)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>file is RSA/EC/DES/AES key file or DF</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6985 condition of use not satisfied
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>security status (does not allow file read)</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6982 - security status not satisfied
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>offset in P1,P2 is outside EF size</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6282 end of size before LE
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>memory subsystem error</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6281 part of data is corrupted
</p>
</li>
</ul></div>
</dd>
</dl></div>
<div style="page-break-after:always"></div>
</div>
<div class="sect2">
<h3 id="_get_data">GET DATA</h3>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1   </th>
<th class="tableblock halign-left valign-top" > P2  </th>
<th class="tableblock halign-left valign-top" > LC  </th>
<th class="tableblock halign-left valign-top" > Data </th>
<th class="tableblock halign-left valign-top" > LE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xCA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x01</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
</tbody>
</table>
<div class="ulist"><ul>
<li>
<p>
LC = 0
</p>
</li>
<li>
<p>
P2 = data selector
</p>
</li>
</ul></div>
<div class="paragraph"><p>P2 for global functions:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>0xA0  Get applet information
0xA1  Get file list in current DF
0xA2  Get file list in current DF - list only transparent EF
0xA3  Get file list in current DF - list only DF
0xA4  Get file list in current DF - list only EF with RSA keys
0xA5  Get file list in current DF - list only EF with ECC keys
0xA6  Get file list in current DF - list only EF with DES/AES keys
0xAA  Get card capabilities
0xAC  Get access condition table</pre>
</div></div>
<div class="paragraph"><p>P2 for key file GET DATA:
(Key file must be selected before GET DATA command)</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>0x00  Get algorithm identifier
0x00  Get modulus
0x02  Get public exponent
0x81  Get ECC curve parameter prime
0x82  Get ECC curve parameter A
0x83  Get ECC curve parameter B
0x84  Get ECC Generator point (X and Y)
0x85  Get ECC curve parameter Order
0x86  Get ECC public key (uncompressed)</pre>
</div></div>
<div class="paragraph"><p>GET DATA  PIN information:</p></div>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1  </th>
<th class="tableblock halign-left valign-top" > P2    </th>
<th class="tableblock halign-left valign-top" > LC  </th>
<th class="tableblock halign-left valign-top" > Data </th>
<th class="tableblock halign-left valign-top" > LE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xCA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x01</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xBX</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">9</p></td>
</tr>
</tbody>
</table>
<div class="ulist"><ul>
<li>
<p>
X in range 1..E
</p>
</li>
<li>
<p>
LC, Data are ignored
</p>
</li>
</ul></div>
<div class="paragraph"><p>This function returns PIN parameters as 9 bytes structure:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>PIN retries - actual state
PUK retries - actual state
PIN max retries - initial state
PUK max retries - initial state
FLAGS
PIN type (for now always 0, normal PIN)
Grid size (for GRID PIN, not implemented for now)
PIN minimal length
PUK minimal length</pre>
</div></div>
<div style="page-break-after:always"></div>
</div>
<div class="sect2">
<h3 id="_put_data">PUT DATA</h3>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1 </th>
<th class="tableblock halign-left valign-top" > P2  </th>
<th class="tableblock halign-left valign-top" > LC  </th>
<th class="tableblock halign-left valign-top" > Data </th>
<th class="tableblock halign-left valign-top" > LE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xDA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">..</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="_initialize_applet">INITIALIZE APPLET</h4>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CLA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">INS</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">LC</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Data</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">LE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xDA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">01</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">E0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">08</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">XX XX ACL0 ACL1 ACL2 XX XX XX</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
</tbody>
</table>
<div class="ulist"><ul>
<li>
<p>
LE empty
</p>
</li>
</ul></div>
<div class="paragraph"><p>This function can be used to erase card and return card into creation state
(Lifecycle = 1). MF access conditions are set to values specified by
ACL0, ACL1, ACL2.  If card is already in creation state, no access condition
is checked, card is erased, only MF exists after calling this function.  If
card is in activated state, access condition is checked first (MF
recreation access condition).</p></div>
</div>
<div class="sect3">
<h4 id="_initialize_pin">INITIALIZE PIN</h4>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CLA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">INS</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">LC</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Data</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">LE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xDA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">01</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">ID</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
</tbody>
</table>
<div class="ulist"><ul>
<li>
<p>
LE empty
</p>
</li>
<li>
<p>
ID PIN ID 1 .. 14
</p>
</li>
</ul></div>
<div class="paragraph"><p>This function is available only in card creation state (Lifecycle = 1). No
access conditions are checked in this state, PIN 1 to 14 can be
initialized. If PIn is already initialized, new initialization overwrites
old PIN data.</p></div>
<div class="paragraph"><p>If card is in activated state (Lifecycle = 7), this function returns SW1,2 = 0x6982
(security status not satisfied).</p></div>
</div>
<div class="sect3">
<h4 id="_key_load_operations">Key load operations</h4>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:6%;">
<col style="width:6%;">
<col style="width:6%;">
<col style="width:18%;">
<col style="width:6%;">
<col style="width:50%;">
<col style="width:6%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CLA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">INS</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">LC</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Data</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">LE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0xDA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">01</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Key Part ID</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
</tbody>
</table>
<div class="ulist"><ul>
<li>
<p>
LE empty
</p>
</li>
<li>
<p>
Part = key part identification
</p>
</li>
<li>
<p>
LC corresponding to data field length
</p>
</li>
</ul></div>
<div class="paragraph"><p>Key part identification numbers:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre> 80  modulus P*Q - (for keys &lt; 2048)
 81  public exponent (65537 or 3)
 82  private exponent (not CRT, for keys &lt; 2048)
 83  prime P
 84  prime Q
 85  d mod (p-1)
 86  d mod (q-1)/EC publickey
 87  q-1 mod p/EC private key
 88  modulus (1st part for 2048 key)
 89  modulus (2nd part for 2048 key)
 8A  private exponent (not CRT, 1st part for 2048 key)
 8B  private exponent (not CRT, 2nd part for 2048 key)
 A0  symmetric key (DES/3DES/AES128/AES192/AES256)</pre>
</div></div>
<div class="paragraph"><p>Key file length in bytes must match key size in bits (for any type of keys,
symmetric/ECC or RSA).</p></div>
<div class="paragraph"><p>Before Key load operation, key file must be selected.</p></div>
<div class="paragraph"><p>OsEID internally uses TLV to represent key parts, T is 8 bit value, L 8 bit
value, length of V is specified by L (1..256 bytes).  One more byte is
reserved (but for now not used) for key index in file.  There is one byte at
end of last component (padding, 0xff).</p></div>
<div class="paragraph"><p>OsEID allows to create key file of arbitrary size, but key upload fail if file
size does not correspond to allowed key sizes for selected cipher.</p></div>
<div class="paragraph"><p>Any EF can be used to hold key data. However, it is advisable to use the values
specified in description if the CREATE FILE operation.</p></div>
<div class="paragraph"><p>For DES,  allowed size are: 64 bytes = standard DES, 128 bytes 2DES (EDE
mode), 256 bytes for 3DES (EDE mode).</p></div>
<div class="paragraph"><p>For AES,  allowed sizes are: 128, 192, or 256 bytes.</p></div>
<div class="paragraph"><p>For ECC keys, only private key must be uploaded, public key is not needed.
File type is 0x22.  Allowed key sizes: 192, 256 or 384 bits.  For secp256k1
curve file type must be set to 0x23 and only 256 it key is allowed.</p></div>
<div class="paragraph"><p>For RSA keys, card uses only CRT algo, if some of CRT component is not
available, RSA operation fails.  You need to upload at least: <strong>prime P</strong>,
<strong>prime Q</strong>, <strong>d mod (p-1)</strong>, <strong>d mod (q-1)</strong>, <strong>q<sup>-1</sup> mod P</strong></p></div>
<div class="paragraph"><p>For now, public exponent is not needed by OsEID card, but future version of
OsEID with RSA message blinding algo need this part of key too.  Therefore,
it is recommended to upload <strong>public exponent</strong>.</p></div>
<div class="paragraph"><p>Card allows to upload <strong>modulus</strong> and <strong>private exponent</strong>, but these values are not
used. (But if <strong>modulus</strong> is not loaded, operation GET DATA fails if modulus is
requested!)</p></div>
<div class="paragraph"><p>Components with ID A3 and A4 are not standard CRT components.
Precalculating of these values allows us to speed up RSA calculation.  Card
automatically calculates these values from P and Q components, user is not
allowed to upload these components.  This functionality is optional, can be
turned off at compilation time.  (R is based on P/Q length, if P length is
512 bits, R is set to 2<sup>512</sup>, more information - search internet for
Montgomery product calculation).</p></div>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:33%;">
<col style="width:11%;">
<col style="width:11%;">
<col style="width:11%;">
<col style="width:11%;">
<col style="width:11%;">
<col style="width:11%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >                </th>
<th class="tableblock halign-left valign-top" >Key part ID</th>
<th class="tableblock halign-left valign-top" > 512  </th>
<th class="tableblock halign-left valign-top" > 768  </th>
<th class="tableblock halign-left valign-top" > 1024  </th>
<th class="tableblock halign-left valign-top" > 1536  </th>
<th class="tableblock halign-left valign-top" >  2048</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">modulus P*Q</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">80</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+64</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+96</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+128</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+192</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">public exp d</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">81</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">priv. exp</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">82</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+64</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+96</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+128</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+192</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">83</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+32</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+48</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+64</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+96</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+128</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Q</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">84</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+32</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+48</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+64</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+96</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+128</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P<sup>-1</sup> mod R</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">A3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+48</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+48</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+64</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+96</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+128</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Q<sup>-1</sup> mod R</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">A4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+48</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+48</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+64</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+96</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+128</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">d<sup>-1</sup> mod (Q-1)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">85</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+32</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+48</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+64</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+96</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+128</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">d<sup>-1</sup> mod (P-1)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">86</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+32</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+48</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+64</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+96</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+128</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Q<sup>-1</sup> mod P</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">87</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+32</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+48</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+64</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+96</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+128</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">mod2048 part1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">88</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+128</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">mod2048 part2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">89</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+128</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">exp2048 part1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">8A</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+128</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">exp2048 part2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">8B</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2+128</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">File size</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">512</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">768</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1024</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1536</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2048</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>MyEID allows to upload non CRT components, but these components may
overwrite some of CRT components. Please consult MyEID reference manual.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_generate_public_key_pair">GENERATE PUBLIC KEY PAIR</h3>
<div class="paragraph"><p>This command generates RSA/ECC keys. Key type and size is determined from
selected file. If file type/size does not match allowed key length for
cipher, operation fails.</p></div>
<div class="paragraph"><p>RSA key for now uses fixed public exponent 65537. For RSA key, user can set LC
to 0 or set LC and data field with this public exponent:</p></div>
<div class="paragraph"><p>RSA key generation APDU:</p></div>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1 </th>
<th class="tableblock halign-left valign-top" > P2 </th>
<th class="tableblock halign-left valign-top" > LC </th>
<th class="tableblock halign-left valign-top" > Data                               </th>
<th class="tableblock halign-left valign-top" > LE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x46</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x46</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">07</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x30 0x05 0x02 0x03 0x01 0x00 0x01</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x46</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">07</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x30 0x05 0x81 0x03 0x01 0x00 0x01</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>All three formats are identical. First format  does not define public
exponent, the card then uses default public exponent. If LC is not 0, data
field contain ASN1 formated data for public exponent. Only value 65537 is
accepted.</p></div>
<div class="paragraph"><p>Data field is ASN1 formated, 0x30 is SEQUENCE indicator, and value 0x02 or
0x81 is used as "public exponent" tag.  (ASN.1 uses 0x02 as tag for INTEGER,
MyEID 2.1.4 manual defines here tag 0x02 too. Opensc 0.17 send
0x81 here, OsEID for now allows both values).</p></div>
<div class="paragraph"><p>If key is successfully generated, key file is filled with key data and card
returns public modulus.</p></div>
<div class="paragraph"><p>ECC key generation APDU:</p></div>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">CLA</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">INS</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">P2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">LC</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Data</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">LE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x46</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
</tbody>
</table>
<div class="ulist"><ul>
<li>
<p>
Data empty
</p>
</li>
<li>
<p>
LE 3 + [key size in bites] * 2 / 8
</p>
</li>
</ul></div>
<div class="paragraph"><p>This APDU is same as specified in MyEID reference manual 2.1.4. As you can
see, there is no information about key size or OID of cipher. Only one way to
detect number of key bits exists -  key file size. If you need to generate ECC
key on card, key file size in bytes must match key length in bits.</p></div>
<div class="paragraph"><p>APDU returns public key in format:
0x86 - TAG
0xXX - LEN (or 0x81, LEN for 521 bit key)
0x04 - uncompressed indicator
0xXX .. 0xXX - X coordinate of public key
0xXX .. 0xXX - Y coordinate of public key</p></div>
<div class="paragraph"><p>It is surprising that MyEID does not use for example OID of curve in the
DATA section to specify the key absolutely precisely. OsEID may in future use
proprietary APDU thats allows to specify OID of curve in data field, but if
<strong>opensc</strong> does not support this information, this feature is for now not
interesting.</p></div>
</div>
<div class="sect2">
<h3 id="_card_security_mechanism_functions">Card security mechanism functions</h3>
<div class="paragraph"><p>Files and directories on card are protected by access flags. If file
operation is protected by access flag, access flag can deny or allow
operation on file.</p></div>
<div class="paragraph"><p>PIN create is allowed only before using ACTIVATE APPLET command.</p></div>
<div class="sect3">
<h4 id="_verify">VERIFY</h4>
<div class="paragraph"><p>Verify command is used to authenticate user/application to card.
Command allows to send verification data (e.g password/PIN) to card.
The verification data is compared to reference data stored in card.
The card security status is modified according to this comparison.</p></div>
<div class="paragraph"><p>Card supports maximal 14 security access conditions.</p></div>
<div class="paragraph"><p>A successful comparison enables use of card function controlled by security
access condition, which number is in P2 parameter of APDU.  Counter
of unsuccessful verify attempts is then cleared.</p></div>
<div class="paragraph"><p>For unsuccessful comparison, counter of unsuccessful verify attempts is
incremented and if this counter is over predefined value, PIN
is blocked. PIN can be unblocked by PUK.</p></div>
<div class="paragraph"><p>PIN can be optionally marked as LOCKED, verification to locked PIN always fails.
For more about PIN LOCK feature check CHANGE REFERENCE DATA command.</p></div>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1   </th>
<th class="tableblock halign-left valign-top" > P2  </th>
<th class="tableblock halign-left valign-top" > LC  </th>
<th class="tableblock halign-left valign-top" > Data </th>
<th class="tableblock halign-left valign-top" > LE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x20</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
</tbody>
</table>
<div class="ulist"><ul>
<li>
<p>
P2 must specify PIN number
</p>
</li>
<li>
<p>
LC 0 to 255
</p>
</li>
<li>
<p>
Data - length corresponding to LC
</p>
</li>
<li>
<p>
LE empty
</p>
</li>
</ul></div>
<div class="paragraph"><p>If LC is 0, this command returns how many authorization retries are left for
PIN specified by parameter P2 in APDU.</p></div>
<div class="paragraph"><p>If LC != 0, data in APDU are used as verification data. Normally exact 8
bytes are present in APDU Data section and LC is set to 8.  PIN in Data
section of APDU is padded by 0xff or 0x00.  If APDU present more data, rest
of data is ignored.  If APDU presents data below 8 bytes, data are internally
padded with 0xff.</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Responses
</dt>
<dt class="hdlist1">
<strong>if P1 != 0</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6a86 - Incorrect parameters P1-P2
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if P2 &lt;1 or &gt;14</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6a86 - Incorrect parameters P1-P2
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if LC = 0</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6983 - PIN fail, no more auth retries, PIN is blocked
</p>
</li>
<li>
<p>
0x6985 - PIN is locked
</p>
</li>
<li>
<p>
0x63cX - X present number of retries left
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>if LC != 0</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
0x6983 - PIN fail, no more auth retries, PIN is blocked
</p>
</li>
<li>
<p>
0x6985 - PIN is locked
</p>
</li>
<li>
<p>
0x63cX - PIN fail, X present number of retries left
</p>
</li>
<li>
<p>
0x9000 - PIN ok, access is enabled for all functions controlled by pin P2
</p>
</li>
</ul></div>
</dd>
</dl></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">MyEID - from reference manual Ver 1.7.7,  APDU need exact 0 or 8 bytes
in data (LC = 0 or 8).
NOTE: response codes are organized in same order as tests in code</td>
</tr></table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_activate_applet">ACTIVATE APPLET</h3>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1 </th>
<th class="tableblock halign-left valign-top" > P2  </th>
<th class="tableblock halign-left valign-top" > LC  </th>
<th class="tableblock halign-left valign-top" > Data </th>
<th class="tableblock halign-left valign-top" > LE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x44</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
</tbody>
</table>
<div class="ulist"><ul>
<li>
<p>
P1, P2, LC, Data, - arbitrary data are accepted
</p>
</li>
</ul></div>
<div class="paragraph"><p>This command activates card security mechanism of card, all access conditions
become active.</p></div>
<div class="paragraph"><p>Difference to MyEID: MyEID needs applet AID in Data field, P1 must be set to
4 and P2 to 0.  Applet AID must be set to A000000063504B43532D3135.  MyEID
card allow activation only if PIN corresponding to MF recreation access
condition is already initialized, otherwise card return SW1,2 = 0x6985
(Conditions not satisfied).  OsEID always allow activation.  If PIN that
allow recreation of MF is not initialized, there is no possibility to erase
the activated card (only way for reuse activated card is reprogramming card
CPU).</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cryptographic_functions">Cryptographic functions</h2>
<div class="sectionbody">
<div class="paragraph"><p>Card supports several cryptographic functions. Symmetric cryptographic
functions are available and asymmetric cryptography is available.</p></div>
<div class="paragraph"><p>Support for symmetric cryptography is experimental for now, because it is based
only on MyEID 2.1.4 reference manual.  Internally OsEID support AES
encrypt/decrypt with standard block size 16 bytes, and key sizes 128/192/256
bits in ECB mode.  DES encrypt/decrypt in ECB is supported with standard
block size 8 bytes, and standard key size 64 bits (56 bits + parity bits,
but all parity bits are ignored).  Support for 3DES encrypt/decrypt is for
192 bit key size, all three keys independent (3TDEA).  Only EDE keying is
supported, no EEE.  This allow run 2 DES too, if 3rd key is copy of 1st key
(2TDEA).  Maximal key size is then 192 bits, but real security of this cipher
is about 112 bits.</p></div>
<div class="paragraph"><p>Block chaining is not available for now, but it seems that MyEID uses CBC
mode, and in future this mode is planed as default.  OsEID for now uses only
ECB mode for AES and DES.  Data size for DES operation is then limited for
only 8 bytes block per operation (APDU) and one 16 bytes block AES operation.</p></div>
<div class="paragraph"><p>Asymmetric cryptography supports RSA with key sizes 512 to 2048 bits (with
steps 64 bit).  There is support for private operation only.  This allows to use
RSA for decipher and for sign operation.  Elliptic curve cryptography
support is available for small set of curves: prime192v1, prime256v1,
secp384r1, secp256k1.  ECDH and ECDSA are supported.</p></div>
<div class="paragraph"><p>The following procedure is recommended for the execution of a security
operation:</p></div>
<div class="ulist"><ul>
<li>
<p>
use SELECT FILE operation to specify file with key/private key
</p>
</li>
<li>
<p>
use VERIFY command to get access condition for key file
</p>
</li>
<li>
<p>
use SET SECURITY ENVIRONMENT command to set parameters of security
</p>
</li>
<li>
<p>
use PERFORM SECURITY OPERATION or GENERAL AUTHENTICATE to perform
  requested operation
</p>
</li>
</ul></div>
<div class="sect2">
<h3 id="_set_security_environment">SET SECURITY ENVIRONMENT</h3>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1 </th>
<th class="tableblock halign-left valign-top" > P2  </th>
<th class="tableblock halign-left valign-top" > LC  </th>
<th class="tableblock halign-left valign-top" > Data </th>
<th class="tableblock halign-left valign-top" > LE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x22</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
</tbody>
</table>
<div class="ulist"><ul>
<li>
<p>
P1  41h: decipher operation
      81h: encipher operation
      A4h: ECDH operation
</p>
</li>
<li>
<p>
P2  B6h: attributes for digital signature in data filed
      B8h: attributes for cipher/decipher in data field
      A4h: ECDH operation
</p>
</li>
<li>
<p>
LC size of data field
</p>
</li>
<li>
<p>
Data concatenated objects
</p>
</li>
<li>
<p>
LE  0
</p>
</li>
</ul></div>
<div class="paragraph"><p>Warning, implementation of ECDH operation differs in Opensc 0.17 and
MyEID manual 2.1.4.  Opensc  uses value 41h in P1 and value A4h in P2.
MyEID manual request A4h in P1 for authentication/key agreement.  Because
this discrepancy, OsEID uses workaround, if P1 is set to A4h, internally P1
is changed to 41h and P2 is set to A4h.  This allows both alternatives to
work.  Please set P1 to 41h and P2 to A4h for ECDH operation.</p></div>
<div class="paragraph"><p>Data field is organized as concatenated Tag Len Value objects.</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>TAG 80h, LEN 1


Value
00h - Raw operation - data length must match key modulus length

02h - for decipher: remove padding from data
02h - for signatures: concatenate padding || signature data
      (do not use data over 60% of key size, minimal padding is 11 bytes)
12h - for decipher: same as raw operation
12h - for signatures: concatenate padding || SHA1 OID || signature data
      (here always 20 bytes of signature data is allowed)

04h - ECDSA, ECDH operation</pre>
</div></div>
<div class="literalblock">
<div class="content monospaced">
<pre>TAG 81h, LEN 2
Value: XXXXh key file ID,

Id is used to select the file which contains the key for the next security
operation.  Select file this file is selected by same way as SELECT
operation with P1 = 2 (DF can not be selected here).


TAG 83h or 84h, LEN 1
Tag 83h is for key file with symmetric key, 84h for file with asymmetric key.
Not used, must not be present. Reference for key in keyfile.
If present, only value 0 is correct.</pre>
</div></div>
<div class="literalblock">
<div class="content monospaced">
<pre>TAG 87h, LEN 1

Set initialization vector.  Must not be present.  If not present, then
initialization vector is filled by 0.  OsEID does not use initialization
vector for now.  (Experimental support for AES/DES).</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_perform_security_operation">PERFORM SECURITY OPERATION</h3>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1 </th>
<th class="tableblock halign-left valign-top" > P2  </th>
<th class="tableblock halign-left valign-top" > LC  </th>
<th class="tableblock halign-left valign-top" > Data </th>
<th class="tableblock halign-left valign-top" > LE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x2A</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Before security operation correct security environment must be set and
correct file with key for security operation must be selected.  Access
condition must allow use of selected key file.</p></div>
<div class="paragraph"><p>More types of security operations exists:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Perform digital signature (ECC/RSA)
   CLA = 00h or 80h
   P1 = 9Eh perform digital signature
   P2 = 9Ah data to be signed in data field
   LC = length of data
</p>
</li>
<li>
<p>
Encrypt plaintext (DES/3DES/AES128/AES192/AES256)
   CLA = 80h
   P1 = 84h
   P2 = 80h
   LC = length of plaintext
</p>
</li>
<li>
<p>
Decrypt ciphertext (RSA/DES/3DES/AES128/AES192/AES256)
   CLA = 00h or 80h
   P1 = 80h
   P2 = 84h - data field contain ciphertext
   P2 = 86h - data field contain padding indicator, then partial or full ciphertext
   LC = length of ciphertext/ciphertext part + length of padding indicator if used
</p>
</li>
</ol></div>
<div class="paragraph"><p>If P2 = 0x86, 1st byte of ciphertext is padding byte. Allowed padding bytes:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>00h = rest of data field is ciphertext
81h = rest of data field is 1st part of ciphertext
82h = rest of data field is 2nd part of ciphertext</pre>
</div></div>
<div class="paragraph"><p>In case of P1 = 80h and P2 = 81h, card saves 1st part of ciphertext in
temporary buffer.  Status 0x9000 is returned.  In all other cases the card
returns result of security operation and status bytes.</p></div>
<div class="paragraph"><p>Temporary buffer is overwritten by any command that returns data (not only
status bytes).  If 2nd part of ciphertext is send by APDU, the card checks if
temporary buffer is in tact, and concatenate 1st and 2nd part of ciphertext
for decipher operation.  Length of concatenated ciphertext must not be
over 256 bytes of data.</p></div>
<div class="paragraph"><p>MyEID manual 2.1.4 limits P2 = 0x84 for AES/DES decipher.  For RSA decipher
P2 = 0x86 is requested.  OsEID allows both values for AES/DES/RSA decipher.
OsEID allows arbitrary length of ciphertext parts for padding indicators 81h
and 82h.  MyEID manual 2.1.4 defines use of this padding indicators for 2048
bit keys.</p></div>
<div class="paragraph"><p>MyEID as described in reference manual 2.1.4 does not support RSA 2048 raw
sign operation, but this operation is identical to raw decipher operation.
Please use <strong>opensc</strong> version from <strong>git</strong>, there is already fix that allows raw
2048 bit signature.
<a href="https://github.com/OpenSC/OpenSC/commit/deab9cce73377f973d2020ab5ab7adc302018bf6">https://github.com/OpenSC/OpenSC/commit/deab9cce73377f973d2020ab5ab7adc302018bf6</a>
Opensc 0.18.0 already contain this patch.</p></div>
<div class="paragraph"><p>WARNING!  OsEID support for DES and AES security operation is experimental.
If selected key file contain AES/DES key, security operation is allowed only
for CLA = 0x80.  Digital signature security operation is not supported if
AES/DES key is selected. Data size (LC) must match block size of DES /AES
block.</p></div>
<div class="paragraph"><p>WARNING!  Before running SECURITY OPERATION, key file specified by tag 81h
in SET SECURITY ENVIRONMENT must be selected by SELECT FILE command!  MyEID
card does not need it.  MyEID (ver 3.3.3) always uses key file specified by
tag 81h in SET SECURITY ENVIRONMENT, even currently selected file have
different ID.  After security operation last selected file by SELECT command
remains selected (SET SECURITY ENVIRONMENT/PERFORM SECURITY OPERATION
preserves last selected file)</p></div>
<div class="paragraph"><p>ECDH security operation is handled by GENERAL AUTHENTICATE command.</p></div>
</div>
<div class="sect2">
<h3 id="_general_authenticate">GENERAL AUTHENTICATE</h3>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1 </th>
<th class="tableblock halign-left valign-top" > P2  </th>
<th class="tableblock halign-left valign-top" > LC  </th>
<th class="tableblock halign-left valign-top" > Data </th>
<th class="tableblock halign-left valign-top" > LE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x86</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">..</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>This command is used to provide ECDH operation. Before calling this command,
correct security environment must be set and key file must be selected.</p></div>
<div class="paragraph"><p>LC   - correspond to length of data field
Data - peer public key in format:  0x7c, LC-2 0x85 LC-4 0x04 point_data
Here: 0x7c is Dynamic Authentication Template tag
      0x85 public key in data field
      0x04 uncompressed key indicator</p></div>
<div class="paragraph"><p>In addition to tag 0x85 tag 0x80 (Witness tag) is allowed with an arbitrary
length.  This tag is ignored for now.</p></div>
<div class="paragraph"><p>Card returns shared secret derived from private key in selected file and
public key provided in APDU. Technically, this operation does a point
multiplication and X coordinate of calculated point is returned.</p></div>
<div class="paragraph"><p>For more info, please read <strong>OsEID-tool</strong> - ECDH operation.</p></div>
</div>
<div class="sect2">
<h3 id="_get_challenge">GET CHALLENGE</h3>
<table class="tableblock frame-all grid-all"
style="
width:85%;
">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:7%;">
<col style="width:57%;">
<col style="width:7%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >CLA  </th>
<th class="tableblock halign-left valign-top" > INS  </th>
<th class="tableblock halign-left valign-top" > P1 </th>
<th class="tableblock halign-left valign-top" > P2  </th>
<th class="tableblock halign-left valign-top" > LC  </th>
<th class="tableblock halign-left valign-top" > Data </th>
<th class="tableblock halign-left valign-top" > LE</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0x84</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">&#8230;</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">..</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">..</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>LE - number of requested random data (1..255)</p></div>
<div class="paragraph"><p>Card return 1..255 bytes of random data.</p></div>
<div class="paragraph"><p>Please read appendix <strong>Random generator implementation</strong> about random number
generator.</p></div>
<div class="paragraph"><p>Return values:
- 0x9000 - All OK
- 0x6f00 - if number of requested bytes is zero.</p></div>
<div class="paragraph"><p>Note: In future here comes more P1/P2 values, thats allow us to
authenticate by challenge/response.  There is consideration about requested
number of random data bytes, for LC=0, 256 bytes of random data may be
returned.</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendixA">Appendix A: PCB ver 0.1</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="images/OsEID_pcb_ver0.1.svg" alt="PCB0.1">
</div>
</div>
<div style="page-break-after:always"></div>
</div>
</div>
<div class="sect1">
<h2 id="appendixB">Appendix B: Schematics ver 0.1</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="images/OsEID_sch_ver0.1.svg" alt="SCH0.1">
</div>
</div>
<div style="page-break-after:always"></div>
</div>
</div>
<div class="sect1">
<h2 id="appendixC">Appendix C: APDU summary</h2>
<div class="sectionbody">
<div class="admonitionblock">
<table><tr>
<td class="icon">
<img src="./images/icons/note.png" alt="Note">
</td>
<td class="content">All APDU numbers in hexadecimal format, APDU format for T0 protocol</td>
</tr></table>
</div>
<div class="sect2">
<h3 id="_class_0">CLASS 0</h3>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>ERASE BINARY</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 0E P1 P2 00 (P1 0-0x7f, P2 0-0xff)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>VERIFY</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 20 00 P2 00  (P2 in range 1 to 0x0e)
</p>
</li>
<li>
<p>
00 20 00 P2 LC [data] (P2 in range 1 to 0x0e)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>MANAGE SECURITY ENVIRONMENT</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 22 F3 00 00        reset sec env
</p>
</li>
<li>
<p>
00 22 41 B6 LC [data] perform digital signature
</p>
</li>
<li>
<p>
00 22 41 B8 LC [data] perform decipher
</p>
</li>
<li>
<p>
00 22 81 B8 LC [data] perform encipher
</p>
</li>
<li>
<p>
00 22 41 A4 LC [data] perform ECDH operation
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>CHANGE REFERENCE DATA</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 24 00 P2 10 [data] (P2 in range 1 to 0x0e)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>PERFORM SECURITY OPERATION</strong> 
</dt>
<dd>
<p>
-00 2A 9E 9A LC [data]
</p>
</dd>
<dt class="hdlist1">
<strong>RESET RETRY COUNTER</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 2C 00 P2 00  (P2 in range 1 to 0x0e)
</p>
</li>
<li>
<p>
00 2C 00 P2 10 [data] (P2 in range 1 to 0x0e)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>DEAUTHENTICATE</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 2E 00 P2 00  (P2 in range 0 to 0x0e)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>ACTIVATE APPLET</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 44 P1 P2 LC [data](P1,P2,LC, does not matter to values)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>GENERATE PUBLIC KEY PAIR</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 46 00 00 LC
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>GET CHALLENGE</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 84 00 00 LE [data] (LE in range 1 - 255)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>GENERAL AUTHENTICATE</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 86 00 00 LC [data]
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>SELECT FILE</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 A4 P1 P2 LC [data]
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>READ BINARY</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 B0 P1 P2 LE (P1 0-0x7f, P2 0-0xff, LE 1..0xff)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>GET RESPONSE</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 C0 00 00 LE
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>GET DATA</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 CA 01 00 00 Get algorithm identifier
</p>
</li>
<li>
<p>
00 CA 01 01 00 Get modulus
</p>
</li>
<li>
<p>
00 CA 01 02 00 Get public exponent
</p>
</li>
<li>
<p>
00 CA 01 81 00 Get ECC curve parameter prime
</p>
</li>
<li>
<p>
00 CA 01 82 00 Get ECC curve parameter A
</p>
</li>
<li>
<p>
00 CA 01 83 00 Get ECC curve parameter B
</p>
</li>
<li>
<p>
00 CA 01 84 00 Get ECC Generator point (X and Y)
</p>
</li>
<li>
<p>
00 CA 01 85 00 Get ECC curve parameter Order
</p>
</li>
<li>
<p>
00 CA 01 86 00 Get ECC public key (uncompressed)
</p>
</li>
<li>
<p>
00 CA 01 A0 00 Get applet information
</p>
</li>
<li>
<p>
00 CA 01 A1 00 Get file list in current DF
</p>
</li>
<li>
<p>
00 CA 01 A2 00 Get file list in current DF - list only EF
</p>
</li>
<li>
<p>
00 CA 01 A3 00 Get file list in current DF - list only DF
</p>
</li>
<li>
<p>
00 CA 01 A4 00 Get file list in current DF - list only EF with RSA keys
</p>
</li>
<li>
<p>
00 CA 01 A5 00 Get file list in current DF - list only EF with ECC keys
</p>
</li>
<li>
<p>
00 CA 01 A6 00 Get file list in current DF - list only EF with DES/AES keys
</p>
</li>
<li>
<p>
00 CA 01 AA 00 Get card capabilities
</p>
</li>
<li>
<p>
00 CA 01 AC 00 Get access condition table
</p>
</li>
<li>
<p>
00 CA 01 BX 00 Get PIN parameters (X in range 1 - 0x0e)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>UPDATE BINARY</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 D6 P1 P2 LC [data] (P1 0-0x7f, P2 0-0xff, LC 1..0xff)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>PUT DATA/initialize pin</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 DA 01 P2 LC [data]
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>PUT DATA/load key</strong> 
</dt>
<dd>
<p>
NOTE: only CRT algo is supported, loading not CRT components is not supported,
operation exits with code 0x6985 - conditions not satisfied
</p>
<div class="ulist"><ul>
<li>
<p>
00 DA 01 80 LC [data] private modulus
</p>
</li>
<li>
<p>
00 DA 01 81 LC [data] public exponent
</p>
</li>
<li>
<p>
00 DA 01 82 LC [data] private exponent (not CRT)
</p>
</li>
<li>
<p>
00 DA 01 83 LC [data] prime P
</p>
</li>
<li>
<p>
00 DA 01 84 LC [data] prime Q
</p>
</li>
<li>
<p>
00 DA 01 85 LC [data] d<sup>-1</sup> mod (p-1)
</p>
</li>
<li>
<p>
00 DA 01 86 LC [data] d<sup>-1</sup> mod (q-1) /EC publickey
</p>
</li>
<li>
<p>
00 DA 01 87 LC [data] q<sup>-1</sup> mod p /EC private key
</p>
</li>
<li>
<p>
00 DA 01 88 LC [data] modulus (1st part for 2048 key)
</p>
</li>
<li>
<p>
00 DA 01 89 LC [data] modulus (2nd part for 2048 key)
</p>
</li>
<li>
<p>
00 DA 01 8A LC [data] private exponent 1st part for 2048 key (not CRT)
</p>
</li>
<li>
<p>
00 DA 01 8B LC [data] private exponent 2nd part for 2048 key (not CRT)
</p>
</li>
<li>
<p>
00 DA 01 A0 LC [data] symmetric key (DES/3DES/AES128/AES192/AES256)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>PUT DATA/initialize applet</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 DA 01 E0 08 [data]
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>CREATE FILE</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 E0 00 00 LC [data] (LC in range 25 to 49 bytes)
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong>DELETE FILE</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 E4 00 00 00
</p>
</li>
</ul></div>
</dd>
</dl></div>
</div>
<div class="sect2">
<h3 id="_class_a0">CLASS A0</h3>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong>DELETE FILE</strong> 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
00 E4 00 00 00
</p>
</li>
</ul></div>
</dd>
</dl></div>
</div>
<div class="sect2">
<h3 id="_class_80">CLASS 80</h3>
<div class="dlist"><dl>
<dt class="hdlist1">
Proprietary, change file type of EC key from 0x22 to 0x23 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
80 DA 00 00 00
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
Proprietary, DES and AES ciphers 
</dt>
<dd>
<div class="ulist"><ul>
<li>
<p>
80 2A xx xx xx
</p>
</li>
</ul></div>
</dd>
</dl></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendixD">Appendix D: OsEID token</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="images/token1.png" alt="OeEID-token">
</div>
</div>
<div class="sect2">
<h3 id="_features_2">Features</h3>
<div class="ulist"><ul>
<li>
<p>
Based on easily accessible microcontroller Atmel xmega128A4U
</p>
</li>
<li>
<p>
single sided PCB
</p>
</li>
<li>
<p>
integrated CCID reader and card in one microcontroller
</p>
</li>
<li>
<p>
no driver needed for windows/linux - emulation of Gemalto reader
</p>
</li>
<li>
<p>
T0 and T1 protocol, TPDU exchange level
</p>
</li>
<li>
<p>
RSA speed: 2048 - about 12 second, 1536 about 6 seconds, 1024 about 2seconds
</p>
</li>
<li>
<p>
ECC speed: secp384r1 about 2.5 seconds, prime256v1 about 1.1 seconds
</p>
</li>
<li>
<p>
low suspend current
</p>
</li>
<li>
<p>
two LEDs to signalize reader/card operation
</p>
</li>
<li>
<p>
optional button to approve sign/decrypt operations
</p>
</li>
<li>
<p>
full speed USB device with electrostatic discharge protection
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_drawbacks_2">Drawbacks</h3>
<div class="paragraph"><p>Drawback are similar to OsEID card. But one significant drawback should be
pointed up:</p></div>
<div class="ulist"><ul>
<li>
<p>
USB and CCID code in same microcontroller as card code reduces security of device
  (due complexity of code, bug in CCID/USB code can compromise card code
  and lead to getting private keys from card.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_components">Components</h3>
<div class="paragraph"><p>1x ATMEL ATXMEGA128A4U-AU - microcontroller
<a href="https://www.tme.eu/en/details/atxmega128a4u-au/8-bit-avr-family/microchip-atmel/">https://www.tme.eu/en/details/atxmega128a4u-au/8-bit-avr-family/microchip-atmel/</a></p></div>
<div class="paragraph"><p>1x NXP PRTR5V0U2X.215  - ESD protection
<a href="https://www.tme.eu/en/details/prtr5v0u2x.215/transil-diodes-arrays/nexperia/">https://www.tme.eu/en/details/prtr5v0u2x.215/transil-diodes-arrays/nexperia/</a></p></div>
<div class="paragraph"><p>1x MCP1700T3302E/TT LTO 3.3V - LDO stabilizer (quiescent current 1.6uA package SOT23)
<a href="https://www.tme.eu/en/details/mcp1700t3302ett/ldo-unregulated-voltage-regulators/microchip-technology/mcp1700t-3302ett/">https://www.tme.eu/en/details/mcp1700t3302ett/ldo-unregulated-voltage-regulators/microchip-technology/mcp1700t-3302ett/</a></p></div>
<div class="paragraph"><p>1x DL1206-4.7  4.7H  - inductor package 1206  0.9ohm 50mA
<a href="https://www.tme.eu/en/details/dl1206-4.7/smd-1206-inductors/ferrocore/dl1206-4r7/">https://www.tme.eu/en/details/dl1206-4.7/smd-1206-inductors/ferrocore/dl1206-4r7/</a></p></div>
<div class="paragraph"><p>1x  DS1097-BN0  - USB connector
<a href="https://www.tme.eu/en/details/usba-lp/usb-ieee1394-connectors/connfly/ds1097-bn0/">https://www.tme.eu/en/details/usba-lp/usb-ieee1394-connectors/connfly/ds1097-bn0/</a></p></div>
<div class="paragraph"><p>4x SMD capacitors in 1206 package (values from schematics)
4x SMD resistors  in 1206 package (values from schematics)
2x SMD LED in 1206 package (red/green or red/blue)</p></div>
<div class="paragraph"><p>1x Optional button OMRON B3U-3100PM
<a href="https://www.tme.eu/en/details/b3u-3100pm/microswitches-tact/omron/">https://www.tme.eu/en/details/b3u-3100pm/microswitches-tact/omron/</a></p></div>
<div class="paragraph"><p>P2 connector is realized only by pads on PCB. Connector is used to program
xmega by PDI programmer.  Needle spring probe is used to connect programmer
to P2 connector.</p></div>
</div>
<div class="sect2">
<h3 id="_programming">Programming</h3>
<div class="paragraph"><p>You need programmer that support PDI programming. One open source/open
hardware can be found at:</p></div>
<div class="paragraph"><p><a href="https://www.olimex.com/Products/AVR/Programmers/AVR-ISP-MK2/open-source-hardware">https://www.olimex.com/Products/AVR/Programmers/AVR-ISP-MK2/open-source-hardware</a></p></div>
<div class="paragraph"><p>To connect programmer to token, you need connector with spring needles
(contacts pitch 2mm).  Create a reduction from this connector to your PDI
programmer.  Use schematics of token and pin description of your programmer,
to get correct connection.</p></div>
<div class="paragraph"><p>Example for <strong>avrdude</strong> and <strong>avrispmkII</strong> programmer:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>$ avrdude -p x128a4u -c avrispmkII -e -v -U flash:w:download/OsEID_token.hex
$ avrdude -p x128a4u -c avrispmkII -v -U fuse2:w:0xBF:m</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_compiling_from_sources_2">Compiling from sources</h3>
<div class="paragraph"><p>Compiling is similar to ATmega128 version:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>make -f Makefile.xmega128a4u
make -f Makefile.xmega128a4u fuses
make -f Makefile.xmega128a4u program</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_overclocking">Overclocking</h3>
<div class="paragraph"><p>Overclocking is not recommended, but if someone need this, there is a simple
way to do this. CPU clock is defined in file <strong>targets/xmega128a4u/avr_os.c</strong></p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>// use PLL - multiply 2MHz RC oscilator to 32MHz
  OSC.PLLCTRL = OSC_PLLSRC_RC2M_gc | (32 / 2);</pre>
</div></div>
<div class="paragraph"><p>Overwrite multiplication factor <strong>(32 / 2)</strong> to requested value (for example
<strong>(48 / 2)</strong>). Recompile and program your token.</p></div>
<div class="paragraph"><p>There is lot of information about XMEGA overclocking on internet.  Some
people run XMEGA over 50MHz and more without any problems.  Some other
people report problems with EEPROM on overclocked XMEGAs.  If your XMEGA
burns, this is your problem.  Please, read again disclaimer section in this
manual.</p></div>
</div>
<div class="sect2">
<h3 id="_schematics">Schematics</h3>
<div class="imageblock">
<div class="content">
<img src="images/OsEID_token.sch.svg" alt="SCH0.1">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pcb">PCB</h3>
<div class="paragraph"><p>There exists two version of PCB, one for classical photographic method and
etching in ferric chloride and second version for CNC routing.  You can
found OsEID_token.ngc file in download section.  This file is designed for
<strong>linuxcnc</strong> <a href="http://linuxcnc.org">http://linuxcnc.org</a>.  Please read this file, adjust feed rate,
check safe Z position, tune spindle commands, tool number etc.  Dimensions
in file are given in mm, make sure your machine uses metric, not imperial
units.  Use 0.3 up to 0.5mm milling tool.  PCB is positioned at Z=-1, Z=1 is
used for traverse.  Run your machine without tool first!</p></div>
<div class="paragraph"><p>AUTHOR IS NOT RESPONSIBLE FOR ANY DAMAGE OF YOUR MACHINE, TOOL OR ANY ANOTER
EQUIPMENTS. USE AT YOUR OWN RISK ONLY!</p></div>
<div class="imageblock">
<div class="content">
<img src="images/OsEID_token-F.Cu.svg" alt="PCB0.1">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/OsEID_token-Dwgs.User.svg" alt="PCBcut0.1">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/OsEID_token_vis1.png" alt="VIS0.1">
</div>
</div>
<div class="paragraph"><p>There is a plan for dual side PCB, with SD card reader. Development of this
model is frozen for now.</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendixE">Appendix E: AVR arithmetics</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_addition_subtraction_and_rotate_shift_operations">Addition, subtraction and rotate/shift operations</h3>
<div class="paragraph"><p>These operations are relatively simple, but to achieve desired speed,
operations are partially unrolled.  In one unrolled step 32 or 64 bit of
operands are processed.</p></div>
</div>
<div class="sect2">
<h3 id="_multiplication">Multiplication</h3>
<div class="paragraph"><p>AVR multiplication is based on karatsuba multiplication.  It uses modified
open source (public domain) implementation from Michael Hutter and Peter
Schwabe <a href="#AVR_KARATSUBA">[AVR_KARATSUBA]</a>.  256 bit multiplication code is fully revised to
enable run in interrupt safe way (stack pointer change is protected by CLI
instruction.) Code is faster, original code took 4797 clock cycles (in
branched version), new code is about 5% faster and about 6% smaller.  Now
code need only 4552 clock cycles.  Same revision was made on 192 bit
multiplication, 2923 clock cycles was reduced to 2860 clock cycles.</p></div>
</div>
<div class="sect2">
<h3 id="_squaring">Squaring</h3>
<div class="paragraph"><p>192 and 256 bit squaring was written from scratch, it uses similar method as
described in <a href="#AVR_SQUARING">[AVR_SQUARING]</a>.  Code is designed as non branched.  Optimized
squaring allows us to run 1872 clock cycles for 192 bit squaring and 3093
clock cycles for 256 bit squaring.  (1966 / 3253 clock cycles
<a href="#AVR_SQUARING">[AVR_SQUARING]</a>).  Squaring code is interrupt safe too.</p></div>
</div>
<div class="sect2">
<h3 id="_modular_multiplicative_inversion">Modular multiplicative inversion</h3>
<div class="paragraph"><p>Modular multiplicative inversion is based on left shift, similar to
<a href="#Lorencz">[Lorencz]</a> or more similar to <a href="#Hars">[Hars]</a> shifting Euclidean algorithm.  AVR
microcontroller shift/rotate instruction allow us to rotate 8 bit value only
by one bit in one instruction cycle.  Original Hars algorithm is not usable
without modifications (very slow repetitive rotations of V/S by <em>f</em>).  The
goal is to minimize the number of rotations.</p></div>
<div class="paragraph"><p>In each step of algorithm <em>U</em> and <em>V</em> is aligned (by left rotations) on
highest non zero bit, then this bit is eliminated by subtraction.  <em>R</em> and
<em>S</em> are kept updated similar to <em>U</em> and <em>V</em>.  This step is repeating, but
align is done by right rotation, until bit size of <em>U</em> is bigger that bit
size of <em>V</em>.  If this is not true, <em>U</em> and <em>V</em> (<em>R</em> and <em>S</em>) are swapped, and
all rotations are returned back (right).  This procedure is repeating until
bit size of <em>U</em> is zero or one (no inversion exists or inversion found).</p></div>
<div class="paragraph"><p>The <em>U</em> and <em>V</em> are represented as unsigned number, but there are helper
variables <em>sU</em> and <em>sV</em> for storing the signs of <em>U</em> and <em>V</em>.  <em>R</em> and <em>S</em>
variables use 64 more bits (this is enough to use 1 more bit to represent
two&#8217;s complement number, but arithmetics routines are unrolled and use 8 bytes
step).</p></div>
<div class="paragraph"><p>Only C code is available for now, ASM version is planned.  Implementation
allows us to calculate inversion for even modulus too (this is needed for
calculation of CRT components).  Code is designed to be small, the speed of
the algorithm is not significant.  (In versions before 20171231, right shift
binary Euclidean algorithm was used, but this doesn&#8217;t allows us to calculate
CRT components because modulus is always even number.  This code is smaller
as new code but is slower too.)</p></div>
<div style="page-break-after:always"></div>
</div>
<div class="sect2">
<h3 id="_modulo_operation">Modulo operation</h3>
<div class="paragraph"><p>Operation uses binary division algorithm.  The rotate/shift operation, as
mentioned before, is slow on AVR devices, table of 8 rotated modulus values
are used to save lot of rotate instructions. AVR assembler version of this
code need 262593 clock cycles for 1024 bit number (575021 clock cycles for
1536, 1008281 clock cycles for 2048). Code run in  constant time.</p></div>
</div>
<div class="sect2">
<h3 id="_montgomery_exponentiation">Montgomery exponentiation</h3>
<div class="paragraph"><p>For Montgomery exponentiation we need to calculate  <em>M = msg * r mod n</em> and
<em>x = 1 * r mod n</em>.  Additionally we need <em>n<sup>/</sup></em> value calculated from <em>r *
r<sup>-1</sup> - n * n<sup>/</sup> = 1</em>.  Here <em>r</em> is in form <em>r = 2<sup>k</sup></em>.  The smallest
possible <em>k</em> is chosen so that <em>r &gt; n</em>.</p></div>
<div class="paragraph"><p>For calculation of <em>n<sup>/</sup></em> modified Euclidean algorithm is used, there is
similar table for <em>n</em> used as in modulo operation.  Code is in AVR
assembler, calculation need only only 188300 clock cycles for 512 bit
modulus length (400684 clock cycles for 768 bit, 694988 clock cycles for
1024).</p></div>
<div class="paragraph"><p><em>M</em> calculation uses already described  modulo operation.</p></div>
<div class="paragraph"><p>For calculating <em>x = 1 * r mod n</em> similar code can be used as for
calculating <em>M = msg * r mod n</em>, but we can use special property of <em>r</em> to
avoid division in this calculation (<a href="#RSA_high_speed">[RSA_high_speed]</a> page 48, chapter 3.8.1.
claims need of division in this step).</p></div>
<div class="paragraph"><p>If <em>n &lt; 2<sup>k</sup> &lt; 2 * n</em>,  then <em>2<sup>k</sup> mod n = 2<sup>k</sup> - n</em>.  Here negated <em>n</em>
(<em>0 - n</em>) can be used directly as <em>x</em>.</p></div>
</div>
<div class="sect2">
<h3 id="_ecc_operation_speed">ECC operation speed</h3>
<div class="paragraph"><p>EC calculation uses projective coordinates.  Lot of code is inspired by NIST
<a href="#NIST_ECC">[NIST_ECC]</a> and <a href="#OPENCRYPTOTOKEN">[OPENCRYPTOTOKEN]</a> EC point doubling is optimized for NIST
curves and for secp256k1 curve.  EC point multiplication is designed as
constant time, with multiplication window of 4 bits.  Point multiplication
is blinded.  For each supported curve, a separate fast reduction algorithm
is used. The secp521r1 curve is supported only on devices with 8KB RAM and
more (ATmega 1284, xmega128A4U). Firmware for atmega128 microcontroller can
be recompiled with two bits multiplication window, then secp521r1 is running
on this device.</p></div>
<table class="tableblock frame-all grid-all"
style="
width:80%;
">
<caption class="title">Table 2. ECDSA operation timing, blinded, in millions of clock cycles</caption>
<col style="width:33%;">
<col style="width:33%;">
<col style="width:33%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">32 bit blind</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">not blinded</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">prime192v1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">15,5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">13,5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">prime256v1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">38,7</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">34,6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">secp256k1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">----</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">47,1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">secp384r1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">82,9</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">76.8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">secp521r1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">140,9</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">133.8</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_rsa_operation_speed">RSA operation speed</h3>
<div class="paragraph"><p>In the next table, there is  RSA calculation timing in clock cycles (normal
RSA / precalculated P<sup>-1</sup> mod R and Q<sup>-1</sup> mod R) in key file, interrupt
always enabled.  512 bit key is calculated by using 768 bit arithmetics,
because 512 bit key is not safe today, it makes no sense to speed up this
calculation by using 512 bit arithmetics.  Likewise, it does not make sense
to speed up the calculation for small keys if exponentiation window is not
optimal to key size - optimal window for key size 512/768 is 4 bits, not 5,
but code uses fixed size defined at compilation time for all key sizes.</p></div>
<div style="page-break-after:always"></div>
<table class="tableblock frame-all grid-all"
style="
width:80%;
">
<caption class="title">Table 3. RSA private operation timing (in millions of clock cycles)</caption>
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<col style="width:16%;">
<tbody>
<tr>
<td class="tableblock halign-left valign-top" colspan="2" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" colspan="2" ><p class="tableblock">no blinding</p></td>
<td class="tableblock halign-left valign-top" colspan="2" ><p class="tableblock">precalc, blinding</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">key size</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">window</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">precalc</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">no precalc</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock"></p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Bellcore.prot</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="6" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="3" ><p class="tableblock">512</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">20,58</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">20,80</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">22,45</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">23,38</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">17,60</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">17,82</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">19,14</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">20,07</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">18,01</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">18,23</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">19,52</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">20,46</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="6" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="3" ><p class="tableblock">768</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">30,43</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">30,65</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">32,30</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">33,23</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">25,67</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">25,89</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">27,21</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">28,13</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">25,54</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">25,76</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">27,34</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">28,29</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="6" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="3" ><p class="tableblock">1024</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">63,36</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">63,73</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">66,30</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">67,75</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">53,14</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">53,51</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">55,56</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">57,01</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">52,56</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">52,93</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">54,93</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">56,41</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="6" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="3" ><p class="tableblock">1536</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">199,4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">200,2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">205,6</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">208,7</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">165,8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">166,6</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">170,9</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">174,0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">162,0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">162,8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">167,0</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">170,1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="6" ><p class="tableblock"></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" rowspan="3" ><p class="tableblock">2048</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">410,9</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">412,3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">420,5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">425,3</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">340,9</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">342,3</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">348,8</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">353,6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">331,1</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">332,5</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">340,4</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">345,2</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>To reach this, lot of  assembler routines are used, especially Montgomery
algo and function like mul256 mod 2<sup>256</sup> (truncated multiplication).  To get
best possible performance, the 384, 512, 768 and 1024 bit squaring and
multiplication are unrolled as possible, with respect to flash memory size
in AVR.</p></div>
<div class="paragraph"><p>Code size: about 20 000 lines in AVR assembler, about 10000 lines in C. AVR
flash in ATmega128 is occupied by ~ 63kB code, 64Kb is used as data space for
card filesystem.</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendixF">Appendix F: Cryptographic algorithm security</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_rsa_security">RSA security</h3>
<div class="paragraph"><p>OsEID implements several protections to generally known attacks to RSA
cryptosystem. There exists several types of side channel attacks:</p></div>
<div class="sect3">
<h4 id="_simple_power_analysis_spa_timing_attack">Simple Power Analysis (SPA) / timing attack</h4>
<div class="paragraph"><p>To prevent this type of attack, OsEID uses:</p></div>
<div class="ulist"><ul>
<li>
<p>
constant time calculation (time does not depend on key or message value)
</p>
</li>
<li>
<p>
Exponentiation uses fixed window size, window is not sliding, zeros
   are not skipped.
</p>
</li>
</ul></div>
<div class="paragraph"><p><em>RSA implementation in OsEID card is resistant to SPA / timing attack.</em></p></div>
</div>
<div class="sect3">
<h4 id="_differential_power_analysis_dpa">Differential Power Analysis (DPA)</h4>
<div class="paragraph"><p>To prevent this type of attack, OsEID uses:</p></div>
<div class="ulist"><ul>
<li>
<p>
card uses exponent blinding
</p>
</li>
</ul></div>
<div class="paragraph"><p>In default settings 24 bits random value is used to blind private exponent
parts (dP and dQ).  Exponent blinding is a big barrier for lot of advanced
techniques that allow use of side channel attack to expose private keys.</p></div>
<div class="ulist"><ul>
<li>
<p>
Card does not support message blinding <a href="#RSA_MSG_BLINDING">[RSA_MSG_BLINDING]</a>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Due constant time of operation (no variable length sliding window), it is
not possible to use known attacks which could work due to the absence of a
message blinding.</p></div>
<div class="ulist"><ul>
<li>
<p>
Card does not support modulus blinding
</p>
</li>
</ul></div>
<div class="paragraph"><p>Modular reduction is needed to calculate Montgomery product like <span class="monospaced">1 * r mod
n</span> and <span class="monospaced">M * r mod n</span>.  In both cases, <span class="monospaced">n</span> is secret value P or Q.  Due CRT
calculation there are operations like <span class="monospaced">M mod P</span> and <span class="monospaced">M mod Q</span>.  Modular
reduction is running in constant time, but is not blinded.  There is a way
to extract power fingerprint from this operation.  It is necessary to run
lot of power traces to get reliable power fingerprint from the same message.
Several special formated messages must be traced to get some information
about P/Q.  Because number of analyzed messages run over 30 000, this type
of attack is not realistic for now.  More about this attack to this function
can be found in <a href="#DPA_on_modular_reduction">[DPA_on_modular_reduction]</a>.</p></div>
<div class="paragraph"><p>Because missing message blinding, there is another point that allow extract
some information from card.  CRT recombination (Garner`s algorithm)
produce result, that need conditional addition.  This addition is always
realized, but power trace can be used to detect which of two possible
results is used as return value.  It&#8217;s not easy to detect this step in one
power trace, but the correlation of a very large number of power traces may
leak some information about this step.</p></div>
<div class="paragraph"><p>Montgomery product needs <span class="monospaced">n'</span> from equation <span class="monospaced">r* r^-1 - n * n' = 1</span>.  This
calculation is running in constant time, but is not blinded.  There is a way
to use DPA for extracting some information about P and Q from card.  In
default firmware configuration, this calculation is running only in key
upload operation, therefore the security of this algorithm is for now
irrelevant.</p></div>
<div class="paragraph"><p><em>RSA implementation in OsEID card is (reasonably) resistant to DPA attack</em></p></div>
</div>
<div class="sect3">
<h4 id="_algorithm_problem">Algorithm problem</h4>
<div class="paragraph"><p>RSA implementation uses <a href="#CRT">[CRT]</a> (China Remainder Theorem).  <a href="#SINGLE_ERROR">[SINGLE_ERROR]</a>
in CRT implementation can expose private key.  This is also known as
<a href="#BELLCORE">[BELLCORE]</a> attack. To prevent this type of attack, OsEID uses:</p></div>
<div class="ulist"><ul>
<li>
<p>
result of exponentiation is checked by public exponent.
</p>
</li>
</ul></div>
<div class="paragraph"><p>This extends the calculation time by approximately 2% for 2048 bits to 5%
for 512 bits RSA.  CRT recombination is not protected, but injecting fault
precisely into this point is very difficult.  Implementing full check
(exponenting signature by public exponent) is problematic due RAM and FLASH
size limitation.  There is not protection against wrong loaded P or Q from
key storage!  There is about 20 msec interval for 1024 bit key for
injecting error in message mod P/Q calculation and about 75 msec if 2048
bit key is used. Intervals for OsEID token are about 2.5x shorter.</p></div>
<div class="paragraph"><p>There is lot of methods to inject error into microcontroller calculation,
fotons from laser/flash light can be used or some particle from radioactive
isotope or electrostatic discharge etc.  Is very difficult to hit exact time
and exact part of microcontroller (for example do not hit program counter but
hit only some of registers or ALU, exact part of RAM etc.), lot of attempt
is needed and lot of luck is needed.  Usually any of attempts ends with
halted microcontroller or in worst case with total damage of
microcontroller.</p></div>
<div class="paragraph"><p><em>RSA implementation in OsEID card is (reasonably) resistant to Bellcore attack</em></p></div>
</div>
<div class="sect3">
<h4 id="_rsa_key_generation">RSA key generation</h4>
<div class="paragraph"><p>OsEID supports RSA key generation.  This operation is really slow, but is
not subject to <a href="#ROCA">[ROCA]</a>.  There is really random prime selection algorithm
used for RSA key generation.</p></div>
<div class="paragraph"><p>Number from random generator is modified - highest  and lowest bit are set
to 1 and this number is then tested by simple sieve - division by 1st 130
primes - and then Miller-Rabin test is used as primality test.  There is no
hardware divisor in AVR devices, GCD is used to check all 130 primes in one
step (product of 1st 130 primes can be fitted into 1024 bit value, this
value is one operand in GCD, second operand is tested number).  When both
primes are found, they are tested if they are not too close to each other.
Then modulus is calculated, and tested if modulus is not too short.  Finally
RSA components are calculated.  If some of test fails, both primes are
discarded and two new primes are searched.  This handling prevents
unnecessary bias of prime/modulus value.  The potential attack to
sieve/primality test is then even more complicated too.</p></div>
<div class="paragraph"><p>Keep in mind, if you generate a key, operation is not blinded.
Exponentiation in Miller-Rabin test, squaring, and CRT components calculation
(3x modular multiplicative inverse) is not blinded too.  SPA, DPA or IPA can
be used to extract some informations about generated key.  Therefore it is
recommended to generate key only in secure environment, if key security is
important.</p></div>
<div class="paragraph"><p>Generation of 1024 bit key take in average about 4 minutes, but in worst case
over 30 minutes. When generating a 2048 bit key you have to be very patient.
Count with time 1 to 3 hours. (One Miller-Rabin test run in 13 second - there
is really no way to run this faster with only one 8 bit multiplier in AVR)</p></div>
<div class="paragraph"><p><em>RSA key generation is not resistant to side channels attack</em></p></div>
<div class="paragraph"><p>Please read more about <a href="#RSA_attack_resistance">[RSA_attack_resistance]</a>, OsEID is hobby card, you
can not expect perfect resistance to all attacks.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_ecc_security">ECC security</h3>
<div class="paragraph"><p>Briefly, all implemented curves are not secure enough, more info at
<a href="#SAFECURVES">[SAFECURVES]</a>.  Apart from this information, implemented elliptic curves
are widely used on the Internet.  If you have any doubts about the safety of
NIST curves, please search internet about rigidity of NIST curves.  Some
information can be found here: <a href="#NIST_RIGGED">[NIST_RIGGED]</a></p></div>
<div class="paragraph"><p>To prevent SPA, EC calculation is running in constant time (but not perfect
constant time, for example, modular multiplicative inversion run time
depends on input numbers).  OsEID implementation also uses blinding in point
multiplication.  Random 32 bit value is used to blind private key in point
multiplication.  SPA attack is not very effective.  Still DPA/IPA can be
used to extract some of sensitive information from other functions.  It is,
however, much more problematic as the attack on not blinded point
multiplication.</p></div>
<div class="paragraph"><p><em>Card firmware implementation may also have some security bugs.  You have
been warned.</em></p></div>
<div class="paragraph"><p>(Do you know about these shortcomings in the world of commercial cards?)</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendixG">Appendix G: Literature</h2>
<div class="sectionbody">
<div class="paragraph"><p>sorry, no paper literature, only internet links</p></div>
<div class="sect2">
<h3 id="_card_iso7816_related_literature">Card/ISO7816 related literature</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="https://en.wikipedia.org/wiki/ISO/IEC_7816">https://en.wikipedia.org/wiki/ISO/IEC_7816</a>
</p>
</li>
<li>
<p>
<a href="http://www.cardwerk.com/smartcards/smartcard_standard_ISO7816.aspx">http://www.cardwerk.com/smartcards/smartcard_standard_ISO7816.aspx</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_avr">AVR</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.atmel.com/images/Atmel-0856-AVR-Instruction-Set-Manual.pdf">http://www.atmel.com/images/Atmel-0856-AVR-Instruction-Set-Manual.pdf</a>
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_atmega128">atmega128</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.microchip.com/wwwproducts/ATmega128">http://www.microchip.com/wwwproducts/ATmega128</a>
</p>
</li>
<li>
<p>
<a href="http://ww1.microchip.com/downloads/en/DeviceDoc/doc2467.pdf">http://ww1.microchip.com/downloads/en/DeviceDoc/doc2467.pdf</a>
</p>
</li>
<li>
<p>
<a href="http://www.atmel.com/Images/Atmel-8151-8-bit-AVR-ATmega128A_Datasheet.pdf">http://www.atmel.com/Images/Atmel-8151-8-bit-AVR-ATmega128A_Datasheet.pdf</a>
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_atxmega128a4u">atxmega128a4u</h4>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.microchip.com/wwwproducts/en/ATxmega128A4U">http://www.microchip.com/wwwproducts/en/ATxmega128A4U</a>
</p>
</li>
<li>
<p>
<a href="http://ww1.microchip.com/downloads/en/DeviceDoc/Atmel-8331-8-and-16-bit-AVR-Microcontroller-XMEGA-AU_Manual.pdf">http://ww1.microchip.com/downloads/en/DeviceDoc/Atmel-8331-8-and-16-bit-AVR-Microcontroller-XMEGA-AU_Manual.pdf</a>
</p>
</li>
<li>
<p>
<a href="http://ww1.microchip.com/downloads/en/DeviceDoc/Atmel-8387-8-and16-bit-AVR-Microcontroller-XMEGA-A4U_Datasheet.pdf">http://ww1.microchip.com/downloads/en/DeviceDoc/Atmel-8387-8-and16-bit-AVR-Microcontroller-XMEGA-A4U_Datasheet.pdf</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_mathematics_implementations_in_avr">Mathematics implementations in AVR</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="https://cryptojedi.org/papers/avrmul-20140715.pdf">https://cryptojedi.org/papers/avrmul-20140715.pdf</a>
</p>
</li>
<li>
<p>
<a id="AVR_KARATSUBA"></a>[AVR_KARATSUBA] <a href="https://eprint.iacr.org/2014/592.pdf">https://eprint.iacr.org/2014/592.pdf</a>
</p>
</li>
<li>
<p>
<a id="AVR_SQUARING"></a>[AVR_SQUARING] <a href="https://eprint.iacr.org/2014/817.pdf">https://eprint.iacr.org/2014/817.pdf</a>
</p>
</li>
<li>
<p>
<a href="http://mhutter.org/research/avr/">http://mhutter.org/research/avr/</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_modular_multiplicative_inversion_2">Modular Multiplicative Inversion</h3>
<div class="ulist"><ul>
<li>
<p>
<a id="Hars"></a>[Hars] <a href="https://pdfs.semanticscholar.org/2e6e/fa126c2f1e719489df30b22c4ec42a7212c8.pdf">https://pdfs.semanticscholar.org/2e6e/fa126c2f1e719489df30b22c4ec42a7212c8.pdf</a>
</p>
</li>
<li>
<p>
<a id="Lorencz"></a>[Lorencz] <a href="https://link.springer.com/content/pdf/10.1007%2F3-540-36400-5_6.pdf">https://link.springer.com/content/pdf/10.1007%2F3-540-36400-5_6.pdf</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_ecc">ECC</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.johannes-bauer.com/compsci/ecc/">http://www.johannes-bauer.com/compsci/ecc/</a>
</p>
</li>
<li>
<p>
<a id="NIST_ECC"></a>[NIST_ECC] <a href="https://apps.nsa.gov/iaarchive/library/ia-guidance/ia-solutions-for-classified/algorithm-guidance/mathematical-routines-for-the-nist-prime-elliptic-curves.cfm">https://apps.nsa.gov/iaarchive/library/ia-guidance/ia-solutions-for-classified/algorithm-guidance/mathematical-routines-for-the-nist-prime-elliptic-curves.cfm</a>
</p>
</li>
<li>
<p>
<a id="SAFECURVES"></a>[SAFECURVES] <a href="https://safecurves.cr.yp.to/">https://safecurves.cr.yp.to/</a>
</p>
</li>
<li>
<p>
<a id="NIST_RIGGED"></a>[NIST_RIGGED] <a href="https://crypto.stackexchange.com/questions/12898/is-there-a-feasible-method-by-which-nist-ecc-curves-over-prime-fields-could-be-i">https://crypto.stackexchange.com/questions/12898/is-there-a-feasible-method-by-which-nist-ecc-curves-over-prime-fields-could-be-i</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_rsa">RSA</h3>
<div class="ulist"><ul>
<li>
<p>
<a id="CRT"></a>[CRT] <a href="http://www.di-mgt.com.au/crt_rsa.html">http://www.di-mgt.com.au/crt_rsa.html</a>
</p>
</li>
<li>
<p>
<a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.538.4909&amp;rep=rep1&amp;type=pdf">http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.538.4909&amp;rep=rep1&amp;type=pdf</a>
</p>
</li>
<li>
<p>
<a id="RSA_high_speed"></a>[RSA_high_speed] <a href="ftp://ftp.rsasecurity.com/pub/pdfs/tr201.pdf">ftp://ftp.rsasecurity.com/pub/pdfs/tr201.pdf</a>
</p>
</li>
<li>
<p>
<a href="https://crypto.stanford.edu/~dabo/papers/RSA-survey.pdf">https://crypto.stanford.edu/~dabo/papers/RSA-survey.pdf</a>
</p>
</li>
<li>
<p>
<a href="https://www.nics.uma.es/pub/seciot10/files/pdf/liu_seciot10_paper.pdf">https://www.nics.uma.es/pub/seciot10/files/pdf/liu_seciot10_paper.pdf</a>
</p>
</li>
<li>
<p>
<a id="RSA_MSG_BLINDING"></a>[RSA_MSG_BLINDING] <a href="https://eprint.iacr.org/2014/869.pdf">https://eprint.iacr.org/2014/869.pdf</a>
</p>
</li>
<li>
<p>
<a href="https://www.cryptoexperts.com/ches2015/slides/day2/session1/talk2.pdf">https://www.cryptoexperts.com/ches2015/slides/day2/session1/talk2.pdf</a>
</p>
</li>
<li>
<p>
<a id="ROCA"></a>[ROCA] <a href="https://github.com/crocs-muni/roca">https://github.com/crocs-muni/roca</a>
</p>
</li>
<li>
<p>
<a id="SINGLE_ERROR"></a>[SINGLE_ERROR] <a href="https://www.cryptologie.net/article/371/fault-attacks-on-rsas-signatures/">https://www.cryptologie.net/article/371/fault-attacks-on-rsas-signatures/</a>
</p>
</li>
<li>
<p>
<a id="BELLCORE"></a>[BELLCORE] <a href="https://eprint.iacr.org/2012/553.pdf">https://eprint.iacr.org/2012/553.pdf</a>
</p>
</li>
<li>
<p>
<a id="DPA_on_modular_reduction"></a>[DPA_on_modular_reduction] <a href="https://link.springer.com/content/pdf/10.1007/3-540-36400-5_18.pdf">https://link.springer.com/content/pdf/10.1007/3-540-36400-5_18.pdf</a>
</p>
</li>
<li>
<p>
<a id="RSA_attack_resistance"></a>[RSA_attack_resistance] <a href="https://www.bsi.bund.de/SharedDocs/Downloads/DE/BSI/Zertifizierung/Interpretationen/AIS_46_BSI_guidelines_SCA_RSA_V1_0_e_pdf.pdf">https://www.bsi.bund.de/SharedDocs/Downloads/DE/BSI/Zertifizierung/Interpretationen/AIS_46_BSI_guidelines_SCA_RSA_V1_0_e_pdf.pdf</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_rng">RNG</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.chronox.de/lrng/doc/lrng.pdf">http://www.chronox.de/lrng/doc/lrng.pdf</a>
</p>
</li>
<li>
<p>
<a href="https://csrc.nist.gov/projects/random-bit-generation/documentation-and-software">https://csrc.nist.gov/projects/random-bit-generation/documentation-and-software</a>
</p>
</li>
<li>
<p>
<a href="http://www.phy.duke.edu/~rgb/General/dieharder.php">http://www.phy.duke.edu/~rgb/General/dieharder.php</a>
</p>
</li>
<li>
<p>
<a href="http://www.fourmilab.ch/random/">http://www.fourmilab.ch/random/</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_usb_related_literature_software">USB related literature/software</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.beyondlogic.org/usbnutshell/usb1.shtml">http://www.beyondlogic.org/usbnutshell/usb1.shtml</a>
</p>
</li>
<li>
<p>
<a href="http://www.fourwalledcubicle.com/LUFA.php">http://www.fourwalledcubicle.com/LUFA.php</a>
</p>
</li>
<li>
<p>
<a href="https://www.obdev.at/products/vusb/index.html">https://www.obdev.at/products/vusb/index.html</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_ccid">CCID</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="https://usb.org.10-1-108-210.causewaynow.com/sites/default/files/DWG_Smart-Card_CCID_Rev110.pdf">https://usb.org.10-1-108-210.causewaynow.com/sites/default/files/DWG_Smart-Card_CCID_Rev110.pdf</a>
</p>
</li>
<li>
<p>
<a href="https://github.com/LudovicRousseau/CCID">https://github.com/LudovicRousseau/CCID</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_myeid">MyEID</h3>
<div class="ulist"><ul>
<li>
<p>
<a id="MyEID"></a>[MyEID] <a href="https://webservices.aventra.fi/wordpress/wp-content/downloads/MyEID_PKI_JavaCard_Applet_Reference_Manual_2-1-4.pdf">https://webservices.aventra.fi/wordpress/wp-content/downloads/MyEID_PKI_JavaCard_Applet_Reference_Manual_2-1-4.pdf</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_related_projects">Related projects</h3>
<div class="ulist"><ul>
<li>
<p>
<a id="OpenSC"></a>[OpenSC] <a href="https://github.com/OpenSC/OpenSC/wiki">https://github.com/OpenSC/OpenSC/wiki</a>
</p>
</li>
<li>
<p>
<a id="OPENCRYPTOTOKEN"></a>[OPENCRYPTOTOKEN] <a href="https://github.com/sa2ajj/opencryptotoken/tree/master/opencryptotoken">https://github.com/sa2ajj/opencryptotoken/tree/master/opencryptotoken</a>
</p>
</li>
<li>
<p>
<a href="http://wiki.seeed.cc/FST-01/">http://wiki.seeed.cc/FST-01/</a>
</p>
</li>
<li>
<p>
<a href="http://www.fsij.org/category/gnuk.html">http://www.fsij.org/category/gnuk.html</a>
</p>
</li>
<li>
<p>
<a href="https://trezor.io/">https://trezor.io/</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_pkcs11">pkcs11</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="https://github.com/Pkcs11Interop/PKCS11-SPECS/tree/master/v2.20">https://github.com/Pkcs11Interop/PKCS11-SPECS/tree/master/v2.20</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_piv">PIV</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="http://csrc.nist.gov/groups/SNS/piv/index.html">http://csrc.nist.gov/groups/SNS/piv/index.html</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_minidriver">minidriver</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="https://msdn.microsoft.com/en-us/library/windows/hardware/dn631754(v=vs.85).aspx">https://msdn.microsoft.com/en-us/library/windows/hardware/dn631754(v=vs.85).aspx</a>
</p>
</li>
<li>
<p>
<a href="http://download.microsoft.com/download/7/E/7/7E7662CF-CBEA-470B-A97E-CE7CE0D98DC2/sc-minidriver_specs_V7.docx">http://download.microsoft.com/download/7/E/7/7E7662CF-CBEA-470B-A97E-CE7CE0D98DC2/sc-minidriver_specs_V7.docx</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_licence">Licence</h3>
<div class="ulist"><ul>
<li>
<p>
<a id="GPL"></a>[GPL] <a href="https://www.gnu.org/licenses/licenses.en.html">https://www.gnu.org/licenses/licenses.en.html</a>
</p>
</li>
</ul></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendixH">Appendix H: Opensc patches</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_opensc_0_17_018_and_0_19">Opensc 0.17, 018 and 0.19</h3>
<div class="paragraph"><p>Opensc 0.17, 0.18 and 0.19 can detect all features of OsEID except of
support for secp256k1.  To use myeid driver for OsEID card you need to
configure opensc package only.  Please insert OsEID ATR into <strong>opensc.conf</strong>
file.</p></div>
<div class="sect3">
<h4 id="_secp256k1_curve_support">secp256k1 curve support</h4>
<div class="paragraph"><p>If you need secp256k1 support, minimal patch is needed.  Please read all
comments about secp256k1 patch for opensc 0.16 (below).</p></div>
<div class="paragraph"><p>For Opensc 0.17, 0.18 and 0.19 following patch is suggested:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>--- opensc-0.17rc1/src/libopensc/card-myeid.c.orig     2017-06-13 13:23:53.000000000 +0200
+++ opensc-0.17rc1-patched/src/libopensc/card-myeid.c  2017-06-20 08:58:43.650806261 +0200
@@ -79,6 +79,7 @@
        "3B:89:80:01:09:38:33:B1:4D:79:45:49:44:4C",
        "3B:F5:96:00:00:80:31:FE:45:4D:79:45:49:44:15", /* Infineon's chip */
        "3B:F5:96:00:00:81:31:FE:45:4D:79:45:49:44:14",
+       "3B:F5:18:00:02:10:80:4F:73:45:49:44",          /* OsEID */
+       "3B:F5:18:00:02:80:01:4F:73:45:49:44:1A",       /* OsEID token*/
        NULL
 };

@@ -113,6 +114,7 @@
        {"secp384r1", {{1, 3, 132, 0, 34, -1}},         384},
        {"secp521r1", {{1, 3, 132, 0, 35, -1}},         521},
        {NULL, {{-1}}, 0},
+       {"secp256k1", {{1, 3, 132, 0, 10, -1}},         256},   /* OsEID */
 };

 static int myeid_get_info(struct sc_card *card, u8 *rbuf, size_t buflen);
@@ -227,6 +229,9 @@
                if (card_caps.max_aes_key_length &gt;= 256)
                        _sc_card_add_symmetric_alg(card, SC_ALGORITHM_AES, 256, flags);
        }
+        /* OsEID support for secp256k1 */
+        if (0 == memcmp("OsEID", card-&gt;atr.value + card-&gt;atr.len - 5, 5))
+               _sc_card_add_ec_alg(card,  ec_curves[5].size, flags, ext_flags, &amp;ec_curves[5].curve_oid);
+        if (0 == memcmp("OsEID", card-&gt;atr.value + card-&gt;atr.len - 6, 5))
+               _sc_card_add_ec_alg(card,  ec_curves[5].size, flags, ext_flags, &amp;ec_curves[5].curve_oid);

        /* State that we have an RNG */
        card-&gt;caps |= SC_CARD_CAP_RNG | SC_CARD_CAP_ISO7816_PIN_INFO;</pre>
</div></div>
</div>
</div>
<div class="sect2">
<h3 id="_opensc_0_15_and_0_16">Opensc 0.15 and 0.16</h3>
<div class="sect3">
<h4 id="_ecdh_operation">ECDH operation</h4>
<div class="paragraph"><p>There is not working support for ECDH in opensc version below 0.17. Please
use opensc 0.17 or newer if you need ECDH operation.</p></div>
</div>
<div class="sect3">
<h4 id="_secp384r1_curve_support">secp384r1 curve support</h4>
<div class="paragraph"><p>Card support for secp384r1 curve can be enabled in opensc. Following patch
is suggested:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>--- opensc-0.16.0/src/libopensc/card-myeid.c    2016-05-31 09:36:09.000000000 +0200
+++ opensc-0.16.0.patched/src/libopensc/card-myeid.c    2016-10-02 21:33:24.348532994 +0200
@@ -69,6 +69,7 @@
        "3B:89:80:01:09:38:33:B1:4D:79:45:49:44:4C",
        "3B:F5:96:00:00:80:31:FE:45:4D:79:45:49:44:15", /* Infineon's chip */
        "3B:F5:96:00:00:81:31:FE:45:4D:79:45:49:44:14",
+       "3B:F5:18:00:02:10:80:4F:73:45:49:44",          /* OsEID */
        NULL
 };

@@ -188,6 +189,10 @@
                        _sc_card_add_ec_alg(card,  ec_curves[i].size, flags,
ext_flags, &amp;ec_curves[i].curve_oid);
                }
        }
+       /* OsEID secp384r1 */
+        if (0 == memcmp("OsEID", card-&gt;atr.value + card-&gt;atr.len - 5, 5)) {
+               _sc_card_add_ec_alg(card,  ec_curves[2].size, flags, ext_flags, &amp;ec_curves[2].curve_oid);
+        }

        /* State that we have an RNG */
        card-&gt;caps |= SC_CARD_CAP_RNG | SC_CARD_CAP_ISO7816_PIN_INFO;</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_experimental_support_for_secp256k1">Experimental support for secp256k1</h4>
<div class="paragraph"><p>There is no simple way to decide what curve is used (secp256k1/secp256r1) in
card firmware/opensc.  Original MyEID card does not support curve OID
specification in key upload/key generate functions.  It is not simple to design
a reasonable method for specifying curve OID, which does not affect
compatibility with newer versions of MyEID card. For now, filetype 0x23 is used
to mark secp256k1 internal key file.</p></div>
<div class="paragraph"><p>For expert users, who want to try secp256k1 curve, following patch for
opensc is suggested:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>--- opensc-0.16.0/src/libopensc/card-myeid.c    2016-05-31 09:36:09.000000000 +0200
+++ opensc-0.16.0-patched/src/libopensc/card-myeid.c    2016-12-13 13:16:16.461312282 +0100
@@ -69,6 +69,7 @@
        "3B:89:80:01:09:38:33:B1:4D:79:45:49:44:4C",
        "3B:F5:96:00:00:80:31:FE:45:4D:79:45:49:44:15", /* Infineon's chip */
        "3B:F5:96:00:00:81:31:FE:45:4D:79:45:49:44:14",
+       "3B:F5:18:00:02:10:80:4F:73:45:49:44",          /* OsEID */
        NULL
 };

@@ -94,6 +95,7 @@
        {"secp384r1", {{1, 3, 132, 0, 34, -1}},         384},
        {"secp521r1", {{1, 3, 132, 0, 35, -1}},         521},
        {NULL, {{-1}}, 0},
+       {"secp256k1", {{1, 3, 132, 0, 10, -1}},         256},   /* OsEID */
 };

 static int myeid_get_info(struct sc_card *card, u8 *rbuf, size_t buflen);
@@ -188,6 +190,11 @@
                        _sc_card_add_ec_alg(card,  ec_curves[i].size, flags, ext_flags, &amp;ec_curves[i].curve_oid);
                }
        }
+        /* OsEID secp384r1, secp256k1 */
+         if (0 == memcmp("OsEID", card-&gt;atr.value + card-&gt;atr.len - 5, 5)) {
+                _sc_card_add_ec_alg(card,  ec_curves[2].size, flags, ext_flags, &amp;ec_curves[2].curve_oid);
+                _sc_card_add_ec_alg(card,  ec_curves[5].size, flags, ext_flags, &amp;ec_curves[5].curve_oid);
+         }

        /* State that we have an RNG */
        card-&gt;caps |= SC_CARD_CAP_RNG | SC_CARD_CAP_ISO7816_PIN_INFO;</pre>
</div></div>
<div class="paragraph"><p>After uploading secp256k1 key, you need to determine key file
path (use pkcs15-tool -D command).  Then change type of this file.  For
this purpose proprietary APDU can be used.  This proprietary APDU is a
special variant of PUT DATA command, but with CLA code 0x80:</p></div>
<div class="paragraph"><p>0x80 0xDA 0x00 0x00 0x00</p></div>
<div class="paragraph"><p>Before use of this APDU, SELECT and VERIFY command must be issued on key
file. (Key file path can be determined by pkcs15-tool -D command)</p></div>
<div class="paragraph"><p>Please read OsEID-tool script for example usage.</p></div>
<div class="paragraph"><p>Card can generate secp256k1 key, but this needs more patches in opensc
(before key is generated, key file must be created with 0x23 value in tag
0x82).  Unfortunately, there is no curve type information available in this
part of opensc (ver 0.16.0) code and there is no simple way to determine
what curve is to be used (secp256k1/prime256v1).</p></div>
<div class="paragraph"><p>To test key generation, there is a simple way - recompile opensc to always
generate 0x23 value in tag 0x82 for EC keys.</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>--- opensc-0.16.0/src/libopensc/cardctl.h       2016-05-31 09:36:09.000000000 +0200
+++ opensc-0.16.0-patched/src/libopensc/cardctl.h       2016-12-13 13:19:23.461149289 +0100
@@ -856,7 +856,7 @@
  */
        enum SC_CARDCTL_MYEID_KEY_TYPE {
                SC_CARDCTL_MYEID_KEY_RSA = 0x11,
-               SC_CARDCTL_MYEID_KEY_EC  = 0x22
+               SC_CARDCTL_MYEID_KEY_EC  = 0x23
        };

        struct sc_cardctl_myeid_data_obj {</pre>
</div></div>
<div class="paragraph"><p>After generating secp256k1 key, recompile opencs with original
libopensc/cardctl.h, and load/generate rest of normal (NIST) EC keys, RSA
keys etc.</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendixI">Appendix I: Random generator implementation</h2>
<div class="sectionbody">
<div class="paragraph"><p>Both  implementations (ATmega128  and xmega) use similar and very simple
random number generator.  There is no seed, no hash function, no reseed
function.</p></div>
<div class="paragraph"><p>Xmega uses 12 bit ADC to measure internal temperature sensor (to internal
band gap reference).  Only bit 0 from ADC conversion is used as entropy
value.</p></div>
<div class="paragraph"><p>Generator tests by <strong>ent</strong> software from <a href="http://www.fourmilab.ch/random/">http://www.fourmilab.ch/random/</a> (This
tests are made with small data blocks, random generator quality is here well
demonstrated - RSA key generation and ECC cryptography uses small data
blocks)</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>File parsed as the bit stream:
==============================
Entropy = 1.000000 bits per bit.

Optimum compression would reduce the size
of this 83264 bit file by 0 percent.

Chi square distribution for 83264 samples is 0.04, and randomly
would exceed this value 75.00 percent of the times.

Arithmetic mean value of data bits is 0.5003 (0.5 = random).
Monte Carlo value for Pi is 3.155709343 (error 0.45 percent).
Serial correlation coefficient is -0.000145 (totally uncorrelated = 0.0).

File parsed as the byte stream:
===============================
Entropy = 7.981877 bits per byte.

Optimum compression would reduce the size
of this 10408 byte file by 0 percent.

Chi square distribution for 10408 samples is 258.70, and randomly
would exceed this value 50.00 percent of the times.

Arithmetic mean value of data bytes is 127.4115 (127.5 = random).
Monte Carlo value for Pi is 3.155709343 (error 0.45 percent).
Serial correlation coefficient is 0.001352 (totally uncorrelated = 0.0).</pre>
</div></div>
<div class="paragraph"><p>The result is excellent for such a simple generator.</p></div>
<div class="paragraph"><p>Unfortunately, similar result is not available on atmega with 10 bit ADC.
There is no temperature sensor.  ADC is set to measure input voltage (to
internal band gap reference).  Only bit 0 from ADC conversion is used as
entropy value.</p></div>
<div class="paragraph"><p>Result of this RNG is not good.  Random generator is strongly affected by
input voltage characteristics (this depends on card reader, USB host,
cables, external interference etc..).  For example, in some environments
random generated data are significantly biased - arithmetic mean value over
160 or higher, Monte Carlo value for PI below 0.1, Chi square never exceed
0.01 percent, etc&#8230;  In some other environment RNG data are relatively good,
but still Chi square is wrong.</p></div>
<div class="paragraph"><p>To get better result, DES cipher is used on 16 bytes from ADC random data (8
bytes data, 8 bytes key) and resulting 8 bytes from DES cipher xored with
key are used as return value from RNG.</p></div>
<div style="page-break-after:always"></div>
<div class="paragraph"><p>In next tables results for OsEID token/card and MyEID card can be compared.
(Beware, in this table, result for atmega generator without DES is one of the
good ones /one of the best, but still with very wrong chi square value)</p></div>
<div class="paragraph"><p>Small data set 10408 bytes:</p></div>
<table class="tableblock frame-all grid-all"
style="
width:80%;
">
<col style="width:42%;">
<col style="width:14%;">
<col style="width:14%;">
<col style="width:14%;">
<col style="width:14%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >                         </th>
<th class="tableblock halign-left valign-top" >xmega      </th>
<th class="tableblock halign-left valign-top" > atmega    </th>
<th class="tableblock halign-left valign-top" > atmega+DES </th>
<th class="tableblock halign-left valign-top" >MyEID 3.3.3</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Entropy per bit</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1.000000</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.999766</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.999993</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.999997</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Entropy per byte</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">7.981877</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">7.781246</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">7.982590</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">7.982021</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Chi square (bit stream)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">75.00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.01</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">50.00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">54.64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Chi square (byte stream)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">50.00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.01</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">50.00</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">38.19</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Arithmetic mean (bit)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.5003</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.5090</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.5016</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.5010</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Arithmetic mean (byte)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">127.4115</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">123.8805</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">128.1469</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">127.4539</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Serial correlation (bit)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">-0.000145</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.111164</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.004077</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.000332</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Serial correlation (byte)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.001352</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.046713</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">-0.009899</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.005033</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Monte Carlo value for Pi</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.155709343</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.158016148</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.106751298</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.111367571</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Big data set (about 100 MBytes):</p></div>
<table class="tableblock frame-all grid-all"
style="
width:80%;
">
<col style="width:33%;">
<col style="width:33%;">
<col style="width:33%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >                         </th>
<th class="tableblock halign-left valign-top" >xmega      </th>
<th class="tableblock halign-left valign-top" > atmega+DES</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Entropy per bit</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1.000000</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1.000000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Entropy per byte</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">7.999998</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">7.999998</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Chi square (bit stream)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">41.54</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">78.08</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Chi square (byte stream)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">41.47</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">23.43</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Arithmetic mean (bit)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.5000</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.5000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Arithmetic mean (byte)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">127.5091</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">127.4966</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Serial correlation (bit)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.000010</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">0.000017</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Serial correlation (byte)</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">-0.000078</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">-0.000194</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">Monte Carlo value for Pi</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.140210247</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">3.141706616</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>More tests with big data sets (100MB) were made by <strong>dieharder</strong> software
(<a href="http://www.phy.duke.edu/~rgb/General/dieharder.php">http://www.phy.duke.edu/~rgb/General/dieharder.php</a>).</p></div>
<div class="paragraph"><p>(In doc directory you can found output from <strong>dieharder</strong> software for card and token
RNG.)</p></div>
<div class="sect2">
<h3 id="_random_generator_speed">Random generator speed</h3>
<div class="paragraph"><p>Speed measurement is only approximate, speed depend on card reader, 3.8MHz reader was used.
USB utilization  also have an impact on speed tests.</p></div>
<table class="tableblock frame-all grid-all"
style="
width:80%;
">
<col style="width:42%;">
<col style="width:14%;">
<col style="width:14%;">
<col style="width:14%;">
<col style="width:14%;">
<thead>
<tr>
<th class="tableblock halign-left valign-top" >                  </th>
<th class="tableblock halign-left valign-top" > xmega        </th>
<th class="tableblock halign-left valign-top" > atmega       </th>
<th class="tableblock halign-left valign-top" > atmega+DES   </th>
<th class="tableblock halign-left valign-top" > MyEID 3.3.3</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">240 bytes in APDU</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">4661 bytes/sec</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">1346 bytes/sec</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">640 bytes/sec</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">2670 bytes/sec</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" ><p class="tableblock">32 bytes in APDU</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">750 bytes/sec</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">340 bytes/sec</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">225 bytes/sec</p></td>
<td class="tableblock halign-left valign-top" ><p class="tableblock">340 bytes/sec</p></td>
</tr>
</tbody>
</table>
<div class="paragraph"><p>Note: OsEID card uses T0 protocol, MyEID and OsEID token use T1 protocol.</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendixJ">Appendix J: Card simulator</h2>
<div class="sectionbody">
<div class="paragraph"><p>All card functions can be tested without any hardware.  Card simulation is
then running as one task in OS.  Simulation is attached to pseudoterminal.
This pseudoterminal is then connected to simulated card reader, and this
reader is attached to <strong>pcscd</strong>.  Simulation creates one file <strong>card_mem</strong>,
where it maintains the FLASH and EEPROM memory of card.</p></div>
<div class="paragraph"><p>For now, this simulator must run with <strong>root privileges</strong>.  <strong>Consider this before
running</strong> this on your computer.  You need <strong>socat</strong> package to run simulation.
This simulation is tested on DEBIAN 9.1 system.</p></div>
<div class="paragraph"><p>Steps to use:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>1. Unpack OsEID tarball
2. cd src
3. make -f Makefile.console
4. su / sudo to get root
5. systemctl stop pcscd.socket
6. systemctl stop pcscd.service
7. build/console/run_pcscd.sh
8. switch to another window/console
9. pcsc_scan</pre>
</div></div>
<div class="paragraph"><p>If card is available, You can use <strong>OsEID-tool</strong> to test functionality of card
(OsEID-tool is in tool directory included in tarball)</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>./OsEID-tool INIT
./OsEID-tool RSA-CREATE-KEYS
./OsEID-tool RSA-UPLOAD-KEYS
pkcs15-tool -D
./OsEID-tool RSA-DECRYPT-TEST</pre>
</div></div>
<div class="paragraph"><p><strong>WARNING!</strong> all other readers in system are available to <strong>pcscd</strong> too, please
disconnect all other readers  or remove another cards from reader to
prevent unwanted modification of your real card.</p></div>
<div class="paragraph"><p>Better (but slower) simulation uses <strong>simulavr</strong>. This allow us to test card
functionality inclusive ASM routines for AVR, measuring speed of procedures
and debugging card function in native AVR instructions. Please read
<strong>targets/simulavr/Readme</strong> from OsEID tarball.</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
<div class="sect1">
<h2 id="appendixK">Appendix K: DES and AES implementation</h2>
<div class="sectionbody">
<div class="paragraph"><p>Both ciphers are optimized to minimal flash size.  Of course, the code is
written in assembler, but C version is available to.  Both ciphers are
optimized to run on 8 bit AVR microcontroller.  Xmega microcontroller
already contains DES instruction, but due absence of this instruction in
atmega, both microcontrollers uses same code (without special DES
instructions).  Xmega contains accelerated engine for 128 bit AES.  This is
not used for the same reason - atmega does not contain this accelerator.
Limiting AES to 128 bit is another reason to do not use xmega accelerator.</p></div>
<div class="paragraph"><p>Both ciphers are designed to run in constant time (time does not depend on
message or key bits).  Timing attack is protected, but differential power
attack is not protected.  (similar problem is in XMEGA accelerated engine:
<a href="https://www.cryptolux.org/images/7/7b/Xmegarump.pdf">https://www.cryptolux.org/images/7/7b/Xmegarump.pdf</a>,
<a href="https://wiki.newae.com/Tutorial_A6_Replication_of_Ilya_Kizhvatov%27s_XMEGA%C2%AE_Attack">https://wiki.newae.com/Tutorial_A6_Replication_of_Ilya_Kizhvatov%27s_XMEGA%C2%AE_Attack</a>
or location dependent EM leakage, please search internet for this keywords).</p></div>
<div class="sect2">
<h3 id="_des">DES</h3>
<div class="paragraph"><p>Code is modified, does not use standard permutations as described by DES
original (NIST) description.</p></div>
<div class="paragraph"><p>Message expansion (E), Permuted choice 1 (PC-1) and Permuted choice 2 (PC-2)
are merged into one 56 bit long message expansion.  This expanded message is
directly XORed by plain key.  S-box addresses are selected from result of
XOR operation by table.  S-boxes are merged to one table (256 bytes).</p></div>
<div class="paragraph"><p>Initial and inverse initial permutation is done by procedures.  Key
expansion is in procedure too.  Only the permutation (P) is unchanged.</p></div>
<div class="paragraph"><p>Code is really small, 800 bytes for DES or 828 bytes if 3DES is needed.
Speed about 50 000 clock cycles for DES decipher or encipher.</p></div>
<div class="paragraph"><p>More informations can be found in C and ASM sources.</p></div>
</div>
<div class="sect2">
<h3 id="_aes">AES</h3>
<div class="paragraph"><p>AES supports key sizes 128/192/256 bits.  AES code is extra small, below 600
bytes.  S-BOX is calculated into RAM.  About 800 bytes of RAM is needed (for
S-box, inverse S-box and expanded key).  Code is compact, does not use
context and therefore the S-box must be calculated repeatedly for every run
of AES.  Speed is sufficient, about 40 000 clock cycles for one AES encipher
or decipher with 256 bit key.</p></div>
<div style="page-break-after:always"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendixL">Appendix L: RSA calculation in <em>genius</em></h2>
<div class="sectionbody">
<div class="paragraph"><p>This part of doc is only for explanation how RSA cryptosystem works.
Especially, here is explained how message and exponent blinding can be
implemented and how can single error in CRT calculation expose P and Q.</p></div>
<div class="paragraph"><p>To run calculation from this appendix, please use <em>genius</em>  calculator
available from <a href="http://www.jirka.org/genius.html">http://www.jirka.org/genius.html</a>.  Code from this appendix
can be pasted directly into <em>genius</em> console. To track calculation, do
not paste whole code at once, code is divided by lines with asteriskses,
paste only partial code and check results in <em>genius</em> console.</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre># This is part of OsEID project documentation,
# https://sourceforge.net/projects/oseid/
.
#
#
# key calculation: choice prime numbers p,q, calculate totient
# ------------------------------------------------------------
.
p = 251
q = 337
totient = (p - 1) * (q - 1)

# choice public exponent
# most commonly used public exponent is 65537
# --------------------------------------------------------
.
pub_exp = 65537

# calculate private exponent
# --------------------------
.

priv_exp = pub_exp ^ -1 mod totient
# calculate n
n = p * q

# calculate  CRT components
# ------------------------
.
dP = (pub_exp^-1) mod (p-1)
dQ = (pub_exp^-1) mod (q-1)
qInv = q ^ -1  mod p

# encipher and decipher
# ---------------------
.
msg = 41444
ciphertext = msg ^ pub_exp mod n
plaintext = ciphertext ^ priv_exp mod n

#
# if calculation is correct, plaintext is 41444
# *****************************************************************
.

# decipher with message blinding
# ------------------------------
.
blind_msg_rnd = 54       # random number

blind_cipher_msg_rnd = blind_msg_rnd ^ pub_exp mod n
blind_cipher         = blind_cipher_msg_rnd * ciphertext mod n
blind_plain          = blind_cipher ^ priv_exp mod n

blind_msg_rnd_inv = blind_msg_rnd ^ -1 mod n
plaintext         = blind_msg_rnd_inv * blind_plain mod n

#
# if calculation is correct, plaintext is 41444
# *****************************************************************
.

# decipher with exponent blinding
# -------------------------------
.
blind_exp_rnd = 56      # random number

blind_exp = blind_exp_rnd * totient + priv_exp
plaintext = ciphertext ^ blind_exp mod n

#
# if calculation is correct, plaintext is 41444
# *****************************************************************
.

# CRT decipher
# ------------
.
cipher_m1 =  ciphertext mod p
cipher_m2 =  ciphertext mod q

m1 = cipher_m1 ^ dP mod p
m2 = cipher_m2 ^ dQ mod q
h = qInv * (m1 - m2) mod p
plaintext = m2 + h * q
#
# if calculation is correct, plaintext is 41444
# *****************************************************************
.

# CRT single error explanation:
# -----------------------------
# calculation of m2 fail:
.
m2 = 123
h = qInv * (m1 - m2) mod p
plaintext = m2 + h * q
# failed plaintext is used to reconstruct 'p'
# -------------------------------------------
.
reconstructed_p = gcd (plaintext - msg, n)
reconstructed_q = n / rp
#
# if calculation is correct, 'p' = 251 and 'q' = 337
# message blinding or exponent blinding does not eliminate single error!
# *****************************************************************
.
# CRT decipher with message blinding
# ----------------------------------
cipher_m1 =  ciphertext mod p
cipher_m2 =  ciphertext mod q

blind_msg_rnd = 54     #random number

blind_msg_p = blind_msg_rnd ^ pub_exp mod p
blind_cipher_p = blind_msg_p * cipher_m1
blind_cipher_m1 = blind_cipher_p mod p

blind_msg_q = blind_msg_rnd ^ pub_exp mod q
blind_cipher_q = blind_msg_q * cipher_m2
blind_cipher_m2 = blind_cipher_q mod q

blind_m1 = blind_cipher_m1 ^ dP mod p
blind_m2 = blind_cipher_m2 ^ dQ mod q

blind_inv_msg = blind_msg_rnd ^ -1 mod n

blind_inv_msg_p = blind_inv_msg mod p
m1 = blind_m1 * blind_inv_msg_p mod p

blind_inv_msg_q = blind_inv_msg mod q
m2 = blind_m2 * blind_inv_msg mod q

h = qInv * (m1 - m2) mod p
plaintext = m2 + h * q
#
# if calculation is correct, plaintext is 41444
# *****************************************************************
.

# similar, but unblinding after recombination:
.
h = qInv * (blind_m1 - blind_m2) mod p
plaintext_blindend = blind_m2 + h * q
plaintext = plaintext_blindend * blind_inv_msg mod n

#
# if calculation is correct, plaintext is 41444
# *****************************************************************
.

# CRT decipher with message and exponent blinding
# -----------------------------------------------
cipher_m1 =  ciphertext mod p
cipher_m2 =  ciphertext mod q

blind_msg_rnd = 54

blind_msg_p = blind_msg_rnd ^ pub_exp mod p
blind_cipher_p = blind_msg_p * cipher_m1
blind_cipher_m1 = blind_cipher_p mod p

blind_msg_q = blind_msg_rnd ^ pub_exp mod q
blind_cipher_q = blind_msg_q * cipher_m2
blind_cipher_m2 = blind_cipher_q mod q

blind_dP_rnd = 34
blind_dQ_rnd = 89

blind_dP = dP + blind_dP_rnd * (p -1)
blind_dQ = dQ + blind_dQ_rnd * (q -1)

blind_m1 = blind_cipher_m1 ^ blind_dP mod p
blind_m2 = blind_cipher_m2 ^ blind_dQ mod q

blind_inv_msg = blind_msg_rnd ^ -1 mod n

blind_inv_msg_p = blind_inv_msg mod p
m1 = blind_m1 * blind_inv_msg_p mod p

blind_inv_msg_q = blind_inv_msg mod q
m2 = blind_m2 * blind_inv_msg mod q

h = qInv * (m1 - m2) mod p
plaintext = m2 + h * q
#
# if calculation is correct, plaintext is 41444
# *****************************************************************
.</pre>
</div></div>
</div>
</div>
</div>
<div id="footnotes"><hr></div>
<div id="footer">
<div id="footer-text">
Last updated
 2019-01-02 09:22:10 CET
</div>
</div>
</body>
</html>
